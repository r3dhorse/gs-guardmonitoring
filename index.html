<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guard Monitoring System</title>
  <!-- jsPDF and jsPDF-AutoTable for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <!-- Chart.js for data visualization -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Open Sans', 'Mukta', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #006341 0%, #007850 50%, #005a3c 100%);
      background-attachment: fixed;
      color: #FFFFFF;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }

    /* Animated background shapes */
    body::before,
    body::after {
      content: '';
      position: fixed;
      border-radius: 50%;
      opacity: 0.1;
      pointer-events: none;
      z-index: 0;
    }

    body::before {
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, #81d742 0%, transparent 70%);
      top: -200px;
      right: -200px;
      animation: float 20s infinite ease-in-out;
    }

    body::after {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, #FBBF24 0%, transparent 70%);
      bottom: -100px;
      left: -100px;
      animation: float 15s infinite ease-in-out reverse;
    }

    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(50px, -50px) scale(1.1); }
      50% { transform: translate(-30px, 30px) scale(0.9); }
      75% { transform: translate(40px, 40px) scale(1.05); }
    }

    /* Hide Google Apps Script Banner */
    div[style*="background-color: rgb(255, 229, 153)"],
    div[style*="background-color: #ffe599"],
    div[style*="border: 1px solid rgb(240, 195, 109)"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      height: 0 !important;
      overflow: hidden !important;
    }

    /* Custom Scrollbar Styles */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(129, 215, 66, 0.5);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(129, 215, 66, 0.7);
    }

    /* Form Validation Styles */
    input.invalid, select.invalid {
      border: 2px solid #EF4444 !important;
      animation: shake 0.3s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* Black Placeholder Text System-Wide */
    input::placeholder,
    textarea::placeholder {
      color: #000000 !important;
      opacity: 0.7 !important;
    }

    /* Loading Spinner Animation */
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 0.5rem;
      vertical-align: middle;
    }

    /* Toast Notification Styles */
    .toast-container {
      position: fixed;
      top: 2rem;
      right: 2rem;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-width: 400px;
    }

    .toast {
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 1rem 1.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      display: flex;
      align-items: center;
      gap: 1rem;
      animation: slideIn 0.3s ease-out;
      border-left: 4px solid;
    }

    .toast.success {
      border-left-color: #22C55E;
    }

    .toast.error {
      border-left-color: #EF4444;
    }

    .toast.info {
      border-left-color: #3B82F6;
    }

    .toast.warning {
      border-left-color: #F59E0B;
    }

    .toast-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 0.25rem;
    }

    .toast-message {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .toast-close {
      background: transparent;
      border: none;
      color: white;
      font-size: 1.25rem;
      cursor: pointer;
      opacity: 0.6;
      transition: opacity 0.2s;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toast-close:hover {
      opacity: 1;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .toast.hiding {
      animation: slideOut 0.3s ease-in forwards;
    }

    .header {
      background: transparent;
      padding: 1.5rem 2rem;
      position: relative;
      z-index: 1;
    }

    .header h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #81d742;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      text-shadow: 0 2px 10px rgba(129, 215, 66, 0.3);
    }

    .container {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 3rem 2rem;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .hero {
      text-align: center;
      margin-bottom: 4rem;
      padding: 3rem 2rem;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }

    .hero::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { left: -100%; }
      100% { left: 100%; }
    }

    .hero h2 {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 1rem;
      line-height: 1.2;
      background: linear-gradient(135deg, #FFFFFF 0%, #81d742 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: none;
      position: relative;
      z-index: 1;
    }

    .hero p {
      font-size: 1.25rem;
      opacity: 0.95;
      max-width: 700px;
      margin: 0 auto;
      line-height: 1.8;
      position: relative;
      z-index: 1;
    }

    .features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
      margin-bottom: 3rem;
    }

    .feature-card {
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      padding: 2rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }

    .feature-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #81d742, #FBBF24);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .feature-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 40px rgba(129, 215, 66, 0.25), inset 0 1px 0 rgba(255, 255, 255, 0.2);
      border-color: rgba(129, 215, 66, 0.4);
      background: rgba(255, 255, 255, 0.12);
    }

    .feature-card:hover::before {
      transform: scaleX(1);
    }

    .feature-icon {
      width: 60px;
      height: 60px;
      background: linear-gradient(135deg, #81d742 0%, #6bc92b 100%);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      margin-bottom: 1.25rem;
      box-shadow: 0 4px 16px rgba(129, 215, 66, 0.3);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .feature-card:hover .feature-icon {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 6px 24px rgba(129, 215, 66, 0.5);
    }

    .feature-card h3 {
      font-size: 1.25rem;
      color: #81d742;
      margin-bottom: 0.75rem;
      font-weight: 700;
      text-shadow: 0 2px 8px rgba(129, 215, 66, 0.2);
    }

    .feature-card p {
      opacity: 0.9;
      line-height: 1.7;
      color: rgba(255, 255, 255, 0.95);
    }

    .cta-section {
      text-align: center;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(129, 215, 66, 0.3);
      border-radius: 24px;
      padding: 3rem 2rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
      position: relative;
      overflow: hidden;
    }

    .cta-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at 50% 0%, rgba(129, 215, 66, 0.15), transparent 70%);
      pointer-events: none;
    }

    .cta-section h3 {
      font-size: 1.75rem;
      margin-bottom: 1.5rem;
      color: #81d742;
      font-weight: 800;
      text-shadow: 0 2px 12px rgba(129, 215, 66, 0.3);
      position: relative;
      z-index: 1;
    }

    .cta-section p {
      font-size: 1.1rem;
      margin-bottom: 2rem;
      opacity: 0.95;
      position: relative;
      z-index: 1;
    }

    .btn {
      display: inline-block;
      background: linear-gradient(135deg, #81d742 0%, #6bc92b 100%);
      color: #006341;
      padding: 1.125rem 3rem;
      border-radius: 14px;
      text-decoration: none;
      font-weight: 700;
      font-size: 1.125rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 16px rgba(129, 215, 66, 0.4);
      position: relative;
      z-index: 1;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #FBBF24 0%, #F59E0B 100%);
      opacity: 0;
      transition: opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 24px rgba(129, 215, 66, 0.6);
    }

    .btn:hover::before {
      opacity: 1;
    }

    .btn:active {
      transform: translateY(-1px) scale(0.98);
    }

    /* Fade-in animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #landingPage .hero {
      animation: fadeInUp 0.8s ease-out;
    }

    #landingPage .feature-card {
      animation: fadeInUp 0.8s ease-out;
      animation-fill-mode: both;
    }

    #landingPage .feature-card:nth-child(1) { animation-delay: 0.1s; }
    #landingPage .feature-card:nth-child(2) { animation-delay: 0.2s; }
    #landingPage .feature-card:nth-child(3) { animation-delay: 0.3s; }
    #landingPage .feature-card:nth-child(4) { animation-delay: 0.4s; }
    #landingPage .feature-card:nth-child(5) { animation-delay: 0.5s; }
    #landingPage .feature-card:nth-child(6) { animation-delay: 0.6s; }

    #landingPage .cta-section {
      animation: fadeInUp 0.8s ease-out 0.7s;
      animation-fill-mode: both;
    }

    @media (max-width: 768px) {
      .hero h2 {
        font-size: 2rem;
      }

      .hero p {
        font-size: 1.1rem;
      }

      .features {
        grid-template-columns: 1fr;
      }

      .feature-icon {
        width: 52px;
        height: 52px;
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Landing Page Container -->
  <div id="landingPage">
    <header class="header">
    </header>

    <main class="container">
    <section class="hero">
      <h2>Professional Security Guard Management</h2>
      <p>Comprehensive Security Guard Management for De La Salle University Main Campus ‚Äî Streamlined monitoring and data-driven insights with real-time analytics powered by Google Sheets.</p>
    </section>

    <section class="features">
      <div class="feature-card">
        <div class="feature-icon">üë•</div>
        <h3>Guard Management</h3>
        <p>Maintain complete guard profiles with personal information, document tracking, and employment status monitoring</p>
      </div>

      <div class="feature-card">
        <div class="feature-icon">üìã</div>
        <h3>Document Monitoring</h3>
        <p>Keep track of license numbers, expiration dates, police clearance, NBI clearance, drug test results, and neuro exam validity with easy-to-read status indicators</p>
      </div>

      <div class="feature-card">
        <div class="feature-icon">üìà</div>
        <h3>Performance Records</h3>
        <p>Document violations and accomplishments with file attachments, filter records by date range, and export reports in PDF or Excel for detailed analysis.</p>
      </div>

      <div class="feature-card">
        <div class="feature-icon">üìä</div>
        <h3>Dashboard Analytics</h3>
        <p>View real-time statistics including total guards, expired licenses, monthly violations and accomplishments, plus performance rankings</p>
      </div>

      <div class="feature-card">
        <div class="feature-icon">‚öôÔ∏è</div>
        <h3>Customizable Settings</h3>
        <p>Add, edit, or remove violation types and sanctions to match your organization's policies and requirements</p>
      </div>

      <div class="feature-card">
        <div class="feature-icon">üîê</div>
        <h3>Secure Access Control</h3>
        <p>Protected login system with Admin and User roles, encrypted passwords, and complete activity tracking for accountability</p>
      </div>
    </section>

    <section class="cta-section">
      <h3>Ready to Get Started?</h3>
      <div style="display: flex; gap: 1rem; justify-content: center; align-items: center; flex-wrap: wrap;">
        <button class="btn" onclick="openDashboard()"><span style="position: relative; z-index: 2;">Login Account</span></button>
      </div>
    </section>
  </main>

  </div>
  <!-- End Landing Page Container -->

  <!-- Dashboard Container -->
  <div id="dashboardPage" style="display: none;"></div>

  <!-- Add Guard Modal -->
  <div id="addGuardModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; overflow-y: auto; padding: 2rem;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 800px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid #81d742; max-height: 90vh; overflow-y: auto;">
      <h2 style="color: #81d742; margin-bottom: 1.5rem; text-align: center; font-size: 1.75rem;">Add New Guard</h2>

      <div id="guardErrorMessage" style="display: none; background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;"></div>

      <form id="addGuardForm" novalidate style="display: grid; gap: 1rem;">
        <!-- Personal Information Section -->
        <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(129, 215, 66, 0.2);">
          <h3 style="color: #81d742; margin: 0 0 1rem; font-size: 1.1rem;">Personal Information</h3>

          <!-- Photo and Name Section -->
          <div style="display: flex; gap: 1.5rem; margin-bottom: 1rem;">
            <!-- Photo Preview (Left) - Clickable -->
            <div style="flex-shrink: 0;">
              <div id="guardPhotoPreview" onclick="document.getElementById('guardPhoto').click()" style="width: 120px; height: 120px; border: 2px dashed rgba(129, 215, 66, 0.3); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; background: rgba(0,0,0,0.2); cursor: pointer; transition: all 0.2s ease; position: relative;" onmouseover="this.style.borderColor='#81d742'; this.style.background='rgba(129, 215, 66, 0.1)'" onmouseout="this.style.borderColor='rgba(129, 215, 66, 0.3)'; this.style.background='rgba(0,0,0,0.2)'">
                <span style="color: rgba(255,255,255,0.4); font-size: 0.85rem; text-align: center; padding: 0.5rem;">üì∑<br>Click to upload</span>
              </div>
              <input type="file" id="guardPhoto" accept="image/*" onchange="handlePhotoPreview(this, 'guardPhotoPreview')" style="display: none;">
            </div>

            <!-- Name Fields (Right) -->
            <div style="flex: 1; display: flex; flex-direction: column; gap: 1rem;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                  <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">First Name *</label>
                  <input type="text" id="guardFirstName" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; text-transform: uppercase;">
                </div>
                <div>
                  <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Middle Name *</label>
                  <input type="text" id="guardMiddleName" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; text-transform: uppercase;">
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                  <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Last Name *</label>
                  <input type="text" id="guardLastName" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; text-transform: uppercase;">
                </div>
                <div>
                  <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Suffix</label>
                  <input type="text" id="guardSuffix" placeholder="Jr., Sr., III" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; text-transform: uppercase;">
                </div>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem;">
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Date of Birth *</label>
              <input type="date" id="guardDOB" min="1950-01-01" max="2015-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Hired Date *</label>
              <input type="date" id="guardHiredDate" min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">End of Contract</label>
              <input type="date" id="guardEndContract" min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Status *</label>
              <select id="guardStatus" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
                <option value="Active" style="background: #006341; color: white;">Active</option>
                <option value="Return To Agency" style="background: #006341; color: white;">Return To Agency</option>
                <option value="Banned" style="background: #006341; color: white;">Banned</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Tab Navigation -->
        <div style="display: flex; gap: 0.5rem; border-bottom: 2px solid rgba(129, 215, 66, 0.3);">
          <button type="button" id="documentsTab" onclick="switchAddGuardTab('documents')" style="flex: 1; padding: 0.75rem; background: #81d742; color: #006341; border: none; border-radius: 8px 8px 0 0; font-weight: 700; cursor: pointer;">
            üìÑ Documents Validity
          </button>
          <button type="button" id="healthTab" onclick="switchAddGuardTab('health')" style="flex: 1; padding: 0.75rem; background: rgba(255,255,255,0.1); color: white; border: none; border-radius: 8px 8px 0 0; font-weight: 700; cursor: pointer;">
            üí™ Health Monitoring
          </button>
        </div>

        <!-- Documents Validity Tab Content -->
        <div id="documentsTabContent" style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(129, 215, 66, 0.2);">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">License Number *</label>
              <input type="text" id="licenseNumber" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">License Expiry *</label>
              <input type="date" id="licenseExpiry" min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Police Clearance Validity *</label>
              <input type="date" id="policeClearance" min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">NBI Clearance Validity *</label>
              <input type="date" id="nbiClearance" min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Drug Test Validity *</label>
              <input type="date" id="drugTestValidity" min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Neuro Exam Validity *</label>
              <input type="date" id="neuroExamValidity" min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
          </div>
        </div>

        <!-- Health Monitoring Tab Content -->
        <div id="healthTabContent" style="display: none; background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(129, 215, 66, 0.2);">
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Height (cm) *</label>
              <input type="number" id="guardHeight" step="0.1" placeholder="e.g., 170.5" oninput="calculateBMI()" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Weight (kg) *</label>
              <input type="number" id="guardWeight" step="0.1" placeholder="e.g., 65.5" oninput="calculateBMI()" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">BMI</label>
              <input type="text" id="guardBMI" readonly style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.05); color: #81d742; font-weight: 700;">
            </div>
          </div>
          <div style="margin-top: 1rem;">
            <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">BMI Status</label>
            <div id="bmiStatus" style="padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.05); color: white; font-weight: 600; text-align: center;">
              -
            </div>
          </div>
          <div style="margin-top: 1rem;">
            <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Notes</label>
            <textarea id="guardHealthNotes" rows="4" placeholder="Enter any health-related notes or observations..." style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; resize: vertical; font-family: inherit;"></textarea>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="submit" id="submitGuardBtn" style="flex: 1; background: #81d742; color: #006341; padding: 1rem; border: none; border-radius: 8px; font-weight: 700; font-size: 1.1rem; cursor: pointer;">
            Add Guard
          </button>
          <button type="button" onclick="closeAddGuardModal()" style="background: rgba(255,255,255,0.1); color: white; padding: 1rem 2rem; border: 1px solid rgba(129, 215, 66, 0.3); border-radius: 8px; font-weight: 600; cursor: pointer;">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Update Guard Modal -->
  <div id="updateGuardModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; overflow-y: auto; padding: 2rem;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 1000px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid #81d742; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: #81d742; margin: 0; font-size: 1.75rem;">Update Guard Information</h2>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <button type="button" onclick="addPerformanceRecord()" style="background: #81d742; color: #006341; padding: 0.5rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 0.95rem; transition: all 0.2s ease;" onmouseover="this.style.background='#6bc92b'" onmouseout="this.style.background='#81d742'">
            + Add Record
          </button>
          <button onclick="closeUpdateGuardModal()" style="background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
            ‚úï Close
          </button>
        </div>
      </div>

      <div id="updateGuardErrorMessage" style="display: none; background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;"></div>
      <div id="updateGuardSuccessMessage" style="display: none; background: rgba(34, 197, 94, 0.2); border: 1px solid #22C55E; color: #86EFAC; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;"></div>

      <input type="hidden" id="updateGuardId">

      <form id="updateGuardForm" style="display: grid; gap: 1rem;">
        <!-- Personal Information Section -->
        <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(129, 215, 66, 0.2);">
          <h3 style="color: #81d742; margin: 0 0 1rem; font-size: 1.1rem;">üìã Personal Information</h3>

          <!-- Photo and Name Section -->
          <div style="display: flex; gap: 1.5rem; margin-bottom: 1rem;">
            <!-- Photo Preview (Left) - Clickable -->
            <div style="flex-shrink: 0;">
              <div id="updateGuardPhotoPreview" onclick="document.getElementById('updateGuardPhoto').click()" style="width: 120px; height: 120px; border: 2px dashed rgba(129, 215, 66, 0.3); border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; background: rgba(0,0,0,0.2); cursor: pointer; transition: all 0.2s ease; position: relative;" onmouseover="this.style.borderColor='#81d742'; this.style.background='rgba(129, 215, 66, 0.1)'" onmouseout="this.style.borderColor='rgba(129, 215, 66, 0.3)'; this.style.background='rgba(0,0,0,0.2)'">
                <span style="color: rgba(255,255,255,0.4); font-size: 0.85rem; text-align: center; padding: 0.5rem;">üì∑<br>Click to upload</span>
              </div>
              <input type="file" id="updateGuardPhoto" accept="image/*" onchange="handlePhotoPreview(this, 'updateGuardPhotoPreview')" style="display: none;">
            </div>

            <!-- Name Fields (Right) -->
            <div style="flex: 1; display: flex; flex-direction: column; gap: 1rem;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                  <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">First Name *</label>
                  <input type="text" id="updateGuardFirstName" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; text-transform: uppercase;">
                </div>
                <div>
                  <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Middle Name</label>
                  <input type="text" id="updateGuardMiddleName" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; text-transform: uppercase;">
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                  <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Last Name *</label>
                  <input type="text" id="updateGuardLastName" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; text-transform: uppercase;">
                </div>
                <div>
                  <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Suffix</label>
                  <input type="text" id="updateGuardSuffix" placeholder="Jr., Sr., III" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; text-transform: uppercase;">
                </div>
              </div>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem;">
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Date of Birth *</label>
              <input type="date" id="updateGuardDOB" required min="1950-01-01" max="2015-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Hired Date *</label>
              <input type="date" id="updateGuardHiredDate" required min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">End of Contract</label>
              <input type="date" id="updateGuardEndContract" min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            </div>
            <div>
              <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Status *</label>
              <select id="updateGuardStatus" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
                <option value="Active" style="background: #006341; color: white;">Active</option>
                <option value="Return To Agency" style="background: #006341; color: white;">Return To Agency</option>
                <option value="Banned" style="background: #006341; color: white;">Banned</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Tab Navigation -->
        <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(129, 215, 66, 0.2);">
          <div style="display: flex; gap: 0.5rem; border-bottom: 2px solid rgba(129, 215, 66, 0.3); margin-bottom: 1.5rem;">
            <button type="button" id="updateDocumentsTab" onclick="switchUpdateGuardTab('documents')" style="padding: 0.875rem 1.5rem; border: none; background: rgba(129, 215, 66, 0.3); color: #81d742; font-weight: 700; font-size: 0.95rem; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s ease; border-bottom: 3px solid #81d742;">
              üìÑ Documents Validity
            </button>
            <button type="button" id="updateHealthTab" onclick="switchUpdateGuardTab('health')" style="padding: 0.875rem 1.5rem; border: none; background: transparent; color: rgba(255,255,255,0.6); font-weight: 700; font-size: 0.95rem; cursor: pointer; border-radius: 8px 8px 0 0; transition: all 0.2s ease; border-bottom: 3px solid transparent;">
              üí™ Health Monitoring
            </button>
          </div>

          <!-- Documents Validity Tab Content -->
          <div id="updateDocumentsTabContent" style="display: block;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">License Number</label>
                <input type="text" id="updateLicenseNumber" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
              </div>
              <div>
                <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">License Expiry</label>
                <input type="date" id="updateLicenseExpiry" min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
              </div>
              <div>
                <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Police Clearance Validity</label>
                <input type="date" id="updatePoliceClearance" min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
              </div>
              <div>
                <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">NBI Clearance Validity</label>
                <input type="date" id="updateNbiClearance" min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
              </div>
              <div>
                <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Drug Test Validity</label>
                <input type="date" id="updateDrugTestValidity" min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
              </div>
              <div>
                <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Neuro Exam Validity</label>
                <input type="date" id="updateNeuroExamValidity" min="2024-01-01" max="2060-12-31" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
              </div>
            </div>
          </div>

          <!-- Health Monitoring Tab Content -->
          <div id="updateHealthTabContent" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Height (cm)</label>
                <input type="number" id="updateGuardHeight" step="0.1" placeholder="e.g., 170.5" oninput="calculateUpdateBMI()" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
              </div>
              <div>
                <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Weight (kg)</label>
                <input type="number" id="updateGuardWeight" step="0.1" placeholder="e.g., 65.5" oninput="calculateUpdateBMI()" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
              </div>
              <div>
                <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">BMI (Auto-calculated)</label>
                <input type="text" id="updateGuardBMI" readonly placeholder="Auto-calculated" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7); cursor: not-allowed;">
              </div>
              <div>
                <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">BMI Status</label>
                <div id="updateBmiStatus" style="padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.7); font-weight: 600; text-align: center;">
                  -
                </div>
              </div>
              <div style="grid-column: 1 / -1;">
                <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Notes</label>
                <textarea id="updateGuardHealthNotes" rows="4" placeholder="Enter any health-related notes..." style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; resize: vertical; font-family: inherit;"></textarea>
              </div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="submit" id="updateGuardBtn" style="flex: 1; background: #81d742; color: #006341; padding: 1rem; border: none; border-radius: 8px; font-weight: 700; font-size: 1.1rem; cursor: pointer;">
            Update Guard
          </button>
          <button type="button" onclick="closeUpdateGuardModal()" style="background: rgba(255,255,255,0.1); color: white; padding: 1rem 2rem; border: 1px solid rgba(129, 215, 66, 0.3); border-radius: 8px; font-weight: 600; cursor: pointer;">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div id="deleteConfirmModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 500px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.5); border: 2px solid #EF4444;">
      <div style="text-align: center; margin-bottom: 1.5rem;">
        <div style="width: 80px; height: 80px; background: rgba(239, 68, 68, 0.2); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
          <span style="font-size: 3rem;">‚ö†Ô∏è</span>
        </div>
        <h2 style="color: #EF4444; margin: 0 0 0.5rem; font-size: 1.5rem;">Delete Guard</h2>
        <p style="color: white; opacity: 0.8; margin: 0;">This action cannot be undone</p>
      </div>

      <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
        <p style="color: white; margin: 0 0 0.5rem; font-size: 0.9rem; opacity: 0.7;">You are about to delete:</p>
        <p id="deleteGuardName" style="color: #81d742; margin: 0; font-weight: 700; font-size: 1.1rem;"></p>
        <p id="deleteGuardId" style="color: white; margin: 0.25rem 0 0; font-size: 0.85rem; opacity: 0.6;"></p>
      </div>

      <div style="display: flex; gap: 1rem;">
        <button
          onclick="closeDeleteModal()"
          style="flex: 1; background: rgba(255,255,255,0.1); color: white; padding: 0.875rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;"
          onmouseover="this.style.background='rgba(255,255,255,0.15)'"
          onmouseout="this.style.background='rgba(255,255,255,0.1)'"
        >
          Cancel
        </button>
        <button
          id="confirmDeleteBtn"
          onclick="confirmDelete()"
          style="flex: 1; background: #EF4444; color: white; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s ease;"
          onmouseover="this.style.background='#DC2626'"
          onmouseout="this.style.background='#EF4444'"
        >
          Delete Guard
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Violation Confirmation Modal -->
  <div id="deleteViolationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 500px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.5); border: 2px solid #EF4444;">
      <div style="text-align: center; margin-bottom: 1.5rem;">
        <div style="width: 80px; height: 80px; background: rgba(239, 68, 68, 0.2); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
          <span style="font-size: 3rem;">‚ö†Ô∏è</span>
        </div>
        <h2 style="color: #EF4444; margin: 0 0 0.5rem; font-size: 1.5rem;">Delete Violation Type</h2>
        <p style="color: white; opacity: 0.8; margin: 0;">This action cannot be undone</p>
      </div>

      <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
        <p style="color: white; margin: 0 0 0.5rem; font-size: 0.9rem; opacity: 0.7;">You are about to delete:</p>
        <p id="deleteViolationName" style="color: #81d742; margin: 0; font-weight: 700; font-size: 1.1rem;"></p>
        <p id="deleteViolationId" style="color: white; margin: 0.25rem 0 0; font-size: 0.85rem; opacity: 0.6;"></p>
      </div>

      <div style="display: flex; gap: 1rem;">
        <button
          onclick="closeDeleteViolationModal()"
          style="flex: 1; background: rgba(255,255,255,0.1); color: white; padding: 0.875rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;"
          onmouseover="this.style.background='rgba(255,255,255,0.15)'"
          onmouseout="this.style.background='rgba(255,255,255,0.1)'"
        >
          Cancel
        </button>
        <button
          id="confirmDeleteViolationBtn"
          onclick="confirmDeleteViolation()"
          style="flex: 1; background: #EF4444; color: white; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s ease;"
          onmouseover="this.style.background='#DC2626'"
          onmouseout="this.style.background='#EF4444'"
        >
          Delete Violation
        </button>
      </div>
    </div>
  </div>

  <!-- Delete Sanction Confirmation Modal -->
  <div id="deleteSanctionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 500px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.5); border: 2px solid #EF4444;">
      <div style="text-align: center; margin-bottom: 1.5rem;">
        <div style="width: 80px; height: 80px; background: rgba(239, 68, 68, 0.2); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
          <span style="font-size: 3rem;">‚ö†Ô∏è</span>
        </div>
        <h2 style="color: #EF4444; margin: 0 0 0.5rem; font-size: 1.5rem;">Delete Sanction</h2>
        <p style="color: white; opacity: 0.8; margin: 0;">This action cannot be undone</p>
      </div>

      <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
        <p style="color: white; margin: 0 0 0.5rem; font-size: 0.9rem; opacity: 0.7;">You are about to delete:</p>
        <p id="deleteSanctionName" style="color: #81d742; margin: 0; font-weight: 700; font-size: 1.1rem;"></p>
        <p id="deleteSanctionId" style="color: white; margin: 0.25rem 0 0; font-size: 0.85rem; opacity: 0.6;"></p>
      </div>

      <div style="display: flex; gap: 1rem;">
        <button
          onclick="closeDeleteSanctionModal()"
          style="flex: 1; background: rgba(255,255,255,0.1); color: white; padding: 0.875rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;"
          onmouseover="this.style.background='rgba(255,255,255,0.15)'"
          onmouseout="this.style.background='rgba(255,255,255,0.1)'"
        >
          Cancel
        </button>
        <button
          id="confirmDeleteSanctionBtn"
          onclick="confirmDeleteSanction()"
          style="flex: 1; background: #EF4444; color: white; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s ease;"
          onmouseover="this.style.background='#DC2626'"
          onmouseout="this.style.background='#EF4444'"
        >
          Delete Sanction
        </button>
      </div>
    </div>
  </div>

  <!-- Add Violation Type Modal -->
  <div id="addViolationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 500px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid #81d742;">
      <h2 style="color: #81d742; margin-bottom: 1.5rem; text-align: center; font-size: 1.5rem;">Add Violation Type</h2>

      <form id="addViolationForm" novalidate style="display: flex; flex-direction: column; gap: 1rem;">
        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Violation Name *</label>
          <input type="text" id="violationName" placeholder="e.g., Late Arrival" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Description *</label>
          <textarea id="violationDescription" rows="3" placeholder="Brief description of the violation" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; resize: vertical;"></textarea>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="button" onclick="closeAddViolationModal()" style="flex: 1; background: rgba(255,255,255,0.1); color: white; padding: 0.875rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: 600; cursor: pointer;">
            Cancel
          </button>
          <button type="submit" id="submitViolationBtn" style="flex: 1; background: #81d742; color: #006341; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
            Add Violation
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Sanction Modal -->
  <div id="addSanctionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 500px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid #81d742;">
      <h2 style="color: #81d742; margin-bottom: 1.5rem; text-align: center; font-size: 1.5rem;">Add Violation Sanction</h2>

      <form id="addSanctionForm" novalidate style="display: flex; flex-direction: column; gap: 1rem;">
        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Sanction Name *</label>
          <input type="text" id="sanctionName" placeholder="e.g., Verbal Warning" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Description *</label>
          <textarea id="sanctionDescription" rows="3" placeholder="Brief description of the sanction" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; resize: vertical;"></textarea>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="button" onclick="closeAddSanctionModal()" style="flex: 1; background: rgba(255,255,255,0.1); color: white; padding: 0.875rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: 600; cursor: pointer;">
            Cancel
          </button>
          <button type="submit" id="submitSanctionBtn" style="flex: 1; background: #81d742; color: #006341; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
            Add Sanction
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Violation Type Modal -->
  <div id="editViolationModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 500px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid #81d742;">
      <h2 style="color: #81d742; margin-bottom: 1.5rem; text-align: center; font-size: 1.5rem;">Edit Violation Type</h2>

      <form id="editViolationForm" novalidate style="display: flex; flex-direction: column; gap: 1rem;">
        <input type="hidden" id="editViolationId">

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Violation Name *</label>
          <input type="text" id="editViolationName" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Description *</label>
          <textarea id="editViolationDescription" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; resize: vertical;"></textarea>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="button" onclick="closeEditViolationModal()" style="flex: 1; background: rgba(255,255,255,0.1); color: white; padding: 0.875rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: 600; cursor: pointer;">
            Cancel
          </button>
          <button type="submit" id="updateViolationBtn" style="flex: 1; background: #81d742; color: #006341; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
            Update Violation
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Sanction Modal -->
  <div id="editSanctionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 500px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid #81d742;">
      <h2 style="color: #81d742; margin-bottom: 1.5rem; text-align: center; font-size: 1.5rem;">Edit Violation Sanction</h2>

      <form id="editSanctionForm" novalidate style="display: flex; flex-direction: column; gap: 1rem;">
        <input type="hidden" id="editSanctionId">

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Sanction Name *</label>
          <input type="text" id="editSanctionName" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Description *</label>
          <textarea id="editSanctionDescription" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; resize: vertical;"></textarea>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="button" onclick="closeEditSanctionModal()" style="flex: 1; background: rgba(255,255,255,0.1); color: white; padding: 0.875rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: 600; cursor: pointer;">
            Cancel
          </button>
          <button type="submit" id="updateSanctionBtn" style="flex: 1; background: #81d742; color: #006341; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
            Update Sanction
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Performance Modal -->
  <div id="addPerformanceModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center; overflow-y: auto; padding: 2rem;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 700px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid #81d742; max-height: 90vh; overflow-y: auto;">
      <h2 style="color: #81d742; margin-bottom: 1.5rem; text-align: center; font-size: 1.5rem;">Add Record</h2>

      <div id="performanceErrorMessage" style="display: none; background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;"></div>

      <form id="addPerformanceForm" novalidate style="display: flex; flex-direction: column; gap: 1rem;">
        <input type="hidden" id="performanceGuardId">
        <input type="hidden" id="performanceGuardName">

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Type *</label>
          <select id="performanceType" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
            <option value="" style="background: #006341; color: white;">Select Type</option>
            <option value="Accomplishment" style="background: #006341; color: white;">Accomplishment</option>
            <option value="Violation" style="background: #006341; color: white;">Violation</option>
          </select>
        </div>

        <div id="violationTypeContainer" style="display: none;">
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Type of Violation *</label>
          <select id="performanceViolationType" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
            <option value="" style="background: #006341; color: white;">Select Violation Type</option>
          </select>
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Short Description *</label>
          <textarea id="performanceDescription" rows="3" required placeholder="Brief description of the accomplishment or violation" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; resize: vertical;"></textarea>
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Date *</label>
          <input type="date" id="performanceDate" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
        </div>

        <div id="violationSanctionContainer" style="display: none;">
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Violation Sanction *</label>
          <select id="performanceSanction" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
            <option value="" style="background: #006341; color: white;">Select Sanction</option>
          </select>
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Upload PDF (Max 5MB)</label>
          <input type="file" id="performancePDF" accept="application/pdf" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
          <p style="color: white; opacity: 0.6; font-size: 0.85rem; margin-top: 0.5rem;">Optional: Attach supporting document (PDF only, max 5MB)</p>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="button" onclick="closeAddPerformanceModal()" style="flex: 1; background: rgba(255,255,255,0.1); color: white; padding: 0.875rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: 600; cursor: pointer;">
            Cancel
          </button>
          <button type="submit" id="submitPerformanceBtn" style="flex: 1; background: #81d742; color: #006341; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
            Add Record
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Update Record Modal -->
  <div id="updateRecordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center; overflow-y: auto; padding: 2rem;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 700px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid #81d742; max-height: 90vh; overflow-y: auto;">
      <h2 style="color: #81d742; margin-bottom: 1.5rem; text-align: center; font-size: 1.5rem;">Update Record</h2>

      <div id="updateRecordErrorMessage" style="display: none; background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;"></div>

      <form id="updateRecordForm" novalidate style="display: flex; flex-direction: column; gap: 1rem;">
        <input type="hidden" id="updateRecordId">
        <input type="hidden" id="updateRecordGuardId">
        <input type="hidden" id="updateRecordGuardName">
        <input type="hidden" id="updateRecordCurrentPdfLink">

        <div style="background: rgba(129, 215, 66, 0.1); border: 1px solid rgba(129, 215, 66, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
          <p style="color: #81d742; margin: 0; font-weight: 600; font-size: 0.95rem;">Guard: <span id="displayGuardName" style="color: white; font-weight: 400;"></span></p>
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Type *</label>
          <select id="updateRecordType" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
            <option value="" style="background: #006341; color: white;">Select Type</option>
            <option value="Accomplishment" style="background: #006341; color: white;">Accomplishment</option>
            <option value="Violation" style="background: #006341; color: white;">Violation</option>
          </select>
        </div>

        <div id="updateRecordViolationTypeContainer" style="display: none;">
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Type of Violation *</label>
          <select id="updateRecordViolationType" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
            <option value="" style="background: #006341; color: white;">Select Violation Type</option>
          </select>
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Short Description *</label>
          <textarea id="updateRecordDescription" rows="3" required placeholder="Brief description of the accomplishment or violation" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; resize: vertical;"></textarea>
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Date *</label>
          <input type="date" id="updateRecordDate" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
        </div>

        <div id="updateRecordSanctionContainer" style="display: none;">
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Violation Sanction *</label>
          <select id="updateRecordSanction" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
            <option value="" style="background: #006341; color: white;">Select Sanction</option>
          </select>
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Upload PDF (Max 5MB)</label>
          <div id="currentPdfDisplay" style="display: none; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 0.75rem; margin-bottom: 0.5rem;">
            <p style="color: #60A5FA; margin: 0; font-size: 0.9rem;">
              üìÑ Current attachment: <a id="currentPdfLink" href="#" target="_blank" style="color: #81d742; text-decoration: underline;">View PDF</a>
            </p>
          </div>
          <input type="file" id="updateRecordPDF" accept="application/pdf" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
          <p style="color: white; opacity: 0.6; font-size: 0.85rem; margin-top: 0.5rem;">Optional: Upload new PDF to replace existing attachment (PDF only, max 5MB)</p>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="button" onclick="closeUpdateRecordModal()" style="flex: 1; background: rgba(255,255,255,0.1); color: white; padding: 0.875rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: 600; cursor: pointer;">
            Cancel
          </button>
          <button type="submit" id="submitUpdateRecordBtn" style="flex: 1; background: #81d742; color: #006341; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
            Update Record
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Record Confirmation Modal -->
  <div id="deleteRecordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 500px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.5); border: 2px solid #EF4444;">
      <div style="text-align: center; margin-bottom: 1.5rem;">
        <div style="width: 80px; height: 80px; background: rgba(239, 68, 68, 0.2); border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
          <span style="font-size: 3rem;">‚ö†Ô∏è</span>
        </div>
        <h2 style="color: #EF4444; margin: 0 0 0.5rem; font-size: 1.5rem;">Delete Record</h2>
        <p style="color: white; opacity: 0.8; margin: 0;">This action cannot be undone</p>
      </div>

      <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
        <p style="color: white; margin: 0 0 0.5rem; font-size: 0.9rem; opacity: 0.7;">You are about to delete:</p>
        <p id="deleteRecordGuardName" style="color: #81d742; margin: 0; font-weight: 700; font-size: 1.1rem;"></p>
        <p id="deleteRecordType" style="color: white; margin: 0.25rem 0 0; font-size: 0.95rem; opacity: 0.8;"></p>
        <p id="deleteRecordId" style="color: white; margin: 0.25rem 0 0; font-size: 0.85rem; opacity: 0.6;"></p>
      </div>

      <div style="display: flex; gap: 1rem;">
        <button
          onclick="closeDeleteRecordModal()"
          style="flex: 1; background: rgba(255,255,255,0.1); color: white; padding: 0.875rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;"
          onmouseover="this.style.background='rgba(255,255,255,0.15)'"
          onmouseout="this.style.background='rgba(255,255,255,0.1)'"
        >
          Cancel
        </button>
        <button
          id="confirmDeleteRecordBtn"
          onclick="confirmDeleteRecord()"
          style="flex: 1; background: #EF4444; color: white; padding: 0.875rem; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; transition: all 0.2s ease;"
          onmouseover="this.style.background='#DC2626'"
          onmouseout="this.style.background='#EF4444'"
        >
          Delete Record
        </button>
      </div>
    </div>
  </div>

  <!-- View Guard Modal -->
  <div id="viewGuardModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; overflow-y: auto; padding: 2rem;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 1200px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid #81d742; max-height: 95vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: #81d742; margin: 0; font-size: 1.75rem;">Guard Details</h2>
        <button onclick="closeViewGuardModal()" style="background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
          ‚úï Close
        </button>
      </div>

      <!-- Personal Information Section -->
      <div style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.2); margin-bottom: 1.5rem;">
        <h3 style="color: #81d742; margin: 0 0 1rem; font-size: 1.1rem;">üìã Personal Information</h3>
        <div style="display: flex; gap: 1.5rem;">
          <!-- Photo -->
          <div id="viewGuardPhoto" style="flex-shrink: 0; width: 150px; height: 150px; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; overflow: hidden; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;">
            <span style="color: rgba(255,255,255,0.4); font-size: 0.9rem; text-align: center;">No photo</span>
          </div>
          <!-- Personal Info -->
          <div id="viewGuardPersonalInfo" style="flex: 1; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <!-- Personal info will be populated here -->
          </div>
        </div>
      </div>

      <!-- Tabs for Documents, Health Records, and Performance -->
      <div style="margin-bottom: 1rem;">
        <div style="display: flex; gap: 0.5rem; border-bottom: 2px solid rgba(251, 191, 36, 0.2);">
          <button
            id="tabDocuments"
            onclick="switchViewTab('documents')"
            style="background: rgba(251, 191, 36, 0.2); color: #81d742; border: none; padding: 0.875rem 1.5rem; cursor: pointer; font-weight: 600; border-bottom: 3px solid #81d742; border-radius: 8px 8px 0 0;"
          >
            üìÑ Documents Information
          </button>
          <button
            id="tabHealth"
            onclick="switchViewTab('health')"
            style="background: transparent; color: white; border: none; padding: 0.875rem 1.5rem; cursor: pointer; font-weight: 600; opacity: 0.7; border-bottom: 3px solid transparent; border-radius: 8px 8px 0 0;"
          >
            üí™ Health Records
          </button>
          <button
            id="tabPerformance"
            onclick="switchViewTab('performance')"
            style="background: transparent; color: white; border: none; padding: 0.875rem 1.5rem; cursor: pointer; font-weight: 600; opacity: 0.7; border-bottom: 3px solid transparent; border-radius: 8px 8px 0 0;"
          >
            üìä Record Information
          </button>
        </div>
      </div>

      <!-- Documents Tab Content -->
      <div id="viewTabDocuments" style="background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.2);">
        <div id="viewGuardDocuments" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
          <!-- Documents info will be populated here -->
        </div>
      </div>

      <!-- Health Records Tab Content -->
      <div id="viewTabHealth" style="display: none; background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.2);">
        <div id="viewGuardHealth" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
          <!-- Health info will be populated here -->
        </div>
      </div>

      <!-- Performance Tab Content -->
      <div id="viewTabPerformance" style="display: none; background: rgba(255,255,255,0.05); padding: 1.5rem; border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.2);">
        <div id="viewGuardPerformance">
          <p style="color: white; opacity: 0.6; text-align: center; padding: 2rem;">
            Loading records...
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 3rem; border-radius: 16px; max-width: 400px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid #81d742;">
      <h2 style="color: #81d742; margin-bottom: 1.5rem; text-align: center; font-size: 1.75rem;">Access Your Account</h2>

      <div id="errorMessage" style="display: none; background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;"></div>

      <div style="margin-bottom: 1.5rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #81d742; font-weight: 600;">Username</label>
        <input type="text" id="username" style="width: 100%; padding: 0.875rem; border: 2px solid rgba(251, 191, 36, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 1rem;" onkeypress="if(event.key==='Enter') login()">
      </div>

      <div style="margin-bottom: 2rem;">
        <label style="display: block; margin-bottom: 0.5rem; color: #81d742; font-weight: 600;">Password</label>
        <input type="password" id="password" style="width: 100%; padding: 0.875rem; border: 2px solid rgba(251, 191, 36, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; font-size: 1rem;" onkeypress="if(event.key==='Enter') login()">
      </div>

      <div style="display: flex; gap: 1rem;">
        <button onclick="login()" id="loginBtn" style="flex: 1; background: #81d742; color: #006341; padding: 1rem; border: none; border-radius: 8px; font-weight: 700; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease;">
          Login
        </button>
        <button onclick="closeLoginModal()" style="flex: 0.4; background: rgba(255,255,255,0.1); color: white; padding: 1rem; border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
          Cancel
        </button>
      </div>

      <p style="margin-top: 1.5rem; text-align: center; opacity: 0.7; font-size: 0.9rem;">Copyright ¬© 2025 Security Guard Management</p>
    </div>
  </div>

  <!-- Add User Modal -->
  <div id="addUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; overflow-y: auto; padding: 2rem;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 600px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid #81d742; max-height: 90vh; overflow-y: auto;">
      <h2 style="color: #81d742; margin-bottom: 1.5rem; text-align: center; font-size: 1.75rem;">Add New User</h2>

      <div id="addUserErrorMessage" style="display: none; background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;"></div>

      <form id="addUserForm" novalidate style="display: grid; gap: 1rem;">
        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Username *</label>
          <input type="text" id="userUsername" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Full Name *</label>
          <input type="text" id="userFullName" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Password *</label>
          <input type="password" id="userPassword" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Role *</label>
          <select id="userRole" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
            <option value="" style="background: #006341; color: white;">Select Role</option>
            <option value="Admin" style="background: #006341; color: white;">Admin</option>
            <option value="User" style="background: #006341; color: white;">User</option>
          </select>
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Status *</label>
          <select id="userStatus" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
            <option value="Active" style="background: #006341; color: white;">Active</option>
            <option value="Inactive" style="background: #006341; color: white;">Inactive</option>
          </select>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="submit" id="submitUserBtn" style="flex: 1; background: #81d742; color: #006341; padding: 1rem; border: none; border-radius: 8px; font-weight: 700; font-size: 1.1rem; cursor: pointer;">
            Add User
          </button>
          <button type="button" onclick="closeAddUserModal()" style="background: rgba(255,255,255,0.1); color: white; padding: 1rem 2rem; border: 1px solid rgba(129, 215, 66, 0.3); border-radius: 8px; font-weight: 600; cursor: pointer;">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Update User Modal -->
  <div id="updateUserModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; overflow-y: auto; padding: 2rem;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 600px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid #81d742; max-height: 90vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: #81d742; margin: 0; font-size: 1.75rem;">Update User</h2>
        <button onclick="closeUpdateUserModal()" style="background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
          ‚úï Close
        </button>
      </div>

      <div id="updateUserErrorMessage" style="display: none; background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;"></div>
      <div id="updateUserSuccessMessage" style="display: none; background: rgba(34, 197, 94, 0.2); border: 1px solid #22C55E; color: #86EFAC; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;"></div>

      <input type="hidden" id="updateUserId">

      <form id="updateUserForm" novalidate style="display: grid; gap: 1rem;">
        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Username *</label>
          <input type="text" id="updateUserUsername" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Full Name *</label>
          <input type="text" id="updateUserFullName" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Password</label>
          <input type="password" id="updateUserPassword" placeholder="Leave blank to keep current password" style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
          <small style="color: rgba(255,255,255,0.6); font-size: 0.85rem; display: block; margin-top: 0.25rem;">Leave blank to keep current password</small>
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Role *</label>
          <select id="updateUserRole" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
            <option value="Admin" style="background: #006341; color: white;">Admin</option>
            <option value="User" style="background: #006341; color: white;">User</option>
          </select>
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Status *</label>
          <select id="updateUserStatus" required style="width: 100%; padding: 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white; cursor: pointer;">
            <option value="Active" style="background: #006341; color: white;">Active</option>
            <option value="Inactive" style="background: #006341; color: white;">Inactive</option>
          </select>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="submit" id="updateUserBtn" style="flex: 1; background: #81d742; color: #006341; padding: 1rem; border: none; border-radius: 8px; font-weight: 700; font-size: 1.1rem; cursor: pointer;">
            Update User
          </button>
          <button type="button" onclick="closeUpdateUserModal()" style="background: rgba(255,255,255,0.1); color: white; padding: 1rem 2rem; border: 1px solid rgba(129, 215, 66, 0.3); border-radius: 8px; font-weight: 600; cursor: pointer;">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="changePasswordModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center; overflow-y: auto; padding: 2rem;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 500px; width: 100%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 2px solid #81d742;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="color: #81d742; margin: 0; font-size: 1.75rem;">Change Password</h2>
        <button onclick="closeChangePasswordModal()" style="background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
          ‚úï Close
        </button>
      </div>

      <div id="changePasswordErrorMessage" style="display: none; background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;"></div>
      <div id="changePasswordSuccessMessage" style="display: none; background: rgba(34, 197, 94, 0.2); border: 1px solid #22C55E; color: #86EFAC; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; text-align: center;"></div>

      <form id="changePasswordForm" novalidate style="display: grid; gap: 1rem;">
        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Current Password *</label>
          <div style="position: relative;">
            <input type="password" id="currentPassword" required autocomplete="current-password" style="width: 100%; padding: 0.75rem 3rem 0.75rem 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            <button type="button" onclick="togglePasswordVisibility('currentPassword')" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #81d742; cursor: pointer; padding: 0.5rem; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;">
              <span id="currentPasswordIcon">üëÅÔ∏è</span>
            </button>
          </div>
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">New Password *</label>
          <div style="position: relative;">
            <input type="password" id="newPassword" required autocomplete="new-password" style="width: 100%; padding: 0.75rem 3rem 0.75rem 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            <button type="button" onclick="togglePasswordVisibility('newPassword')" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #81d742; cursor: pointer; padding: 0.5rem; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;">
              <span id="newPasswordIcon">üëÅÔ∏è</span>
            </button>
          </div>
        </div>

        <div>
          <label style="display: block; color: #81d742; margin-bottom: 0.5rem; font-weight: 600;">Confirm New Password *</label>
          <div style="position: relative;">
            <input type="password" id="confirmPassword" required autocomplete="new-password" style="width: 100%; padding: 0.75rem 3rem 0.75rem 0.75rem; border: 2px solid rgba(129, 215, 66, 0.3); border-radius: 8px; background: rgba(255,255,255,0.1); color: white;">
            <button type="button" onclick="togglePasswordVisibility('confirmPassword')" style="position: absolute; right: 0.5rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #81d742; cursor: pointer; padding: 0.5rem; font-size: 1.2rem; display: flex; align-items: center; justify-content: center;">
              <span id="confirmPasswordIcon">üëÅÔ∏è</span>
            </button>
          </div>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
          <button type="submit" id="changePasswordBtn" style="flex: 1; background: #81d742; color: #006341; padding: 1rem; border: none; border-radius: 8px; font-weight: 700; font-size: 1.1rem; cursor: pointer;">
            Change Password
          </button>
          <button type="button" onclick="closeChangePasswordModal()" style="background: rgba(255,255,255,0.1); color: white; padding: 1rem 2rem; border: 1px solid rgba(129, 215, 66, 0.3); border-radius: 8px; font-weight: 600; cursor: pointer;">
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Export Format Selection Modal (for Records) -->
  <div id="exportFormatModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 500px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.5); border: 2px solid #81d742;">
      <h2 style="color: #81d742; margin-bottom: 1.5rem; text-align: center; font-size: 1.5rem;">Select Export Format</h2>

      <p style="color: white; opacity: 0.8; text-align: center; margin-bottom: 2rem;">
        Choose the format for exporting <span id="exportRecordCount" style="color: #81d742; font-weight: 700;">0</span> records
      </p>

      <div style="display: flex; gap: 1rem;">
        <button onclick="exportToExcel()" style="flex: 1; background: rgba(34, 197, 94, 0.2); border: 2px solid #22C55E; color: #86EFAC; padding: 2rem 1rem; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.75rem; transition: all 0.3s ease;">
          <span style="font-size: 3rem;">üìä</span>
          <span>Excel (CSV)</span>
        </button>

        <button onclick="exportToPDF()" style="flex: 1; background: rgba(239, 68, 68, 0.2); border: 2px solid #EF4444; color: #FCA5A5; padding: 2rem 1rem; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.75rem; transition: all 0.3s ease;">
          <span style="font-size: 3rem;">üìÑ</span>
          <span>PDF</span>
        </button>
      </div>

      <button onclick="closeExportFormatModal()" style="width: 100%; background: rgba(255,255,255,0.1); color: white; padding: 0.875rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 1rem;">
        Cancel
      </button>
    </div>
  </div>

  <!-- Export Format Selection Modal (for Guards) -->
  <div id="exportGuardsFormatModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; align-items: center; justify-content: center;">
    <div style="background: linear-gradient(135deg, #006341 0%, #007850 100%); padding: 2rem; border-radius: 16px; max-width: 500px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.5); border: 2px solid #81d742;">
      <h2 style="color: #81d742; margin-bottom: 1.5rem; text-align: center; font-size: 1.5rem;">Select Export Format</h2>

      <p style="color: white; opacity: 0.8; text-align: center; margin-bottom: 2rem;">
        Choose the format for exporting <span id="exportGuardsCount" style="color: #81d742; font-weight: 700;">0</span> guards
      </p>

      <div style="display: flex; gap: 1rem;">
        <button onclick="exportGuardsToExcel()" style="flex: 1; background: rgba(34, 197, 94, 0.2); border: 2px solid #22C55E; color: #86EFAC; padding: 2rem 1rem; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.75rem; transition: all 0.3s ease;">
          <span style="font-size: 3rem;">üìä</span>
          <span>Excel (CSV)</span>
        </button>

        <button onclick="exportGuardsToPDF()" style="flex: 1; background: rgba(239, 68, 68, 0.2); border: 2px solid #EF4444; color: #FCA5A5; padding: 2rem 1rem; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1rem; display: flex; flex-direction: column; align-items: center; gap: 0.75rem; transition: all 0.3s ease;">
          <span style="font-size: 3rem;">üìÑ</span>
          <span>PDF</span>
        </button>
      </div>

      <button onclick="closeExportGuardsFormatModal()" style="width: 100%; background: rgba(255,255,255,0.1); color: white; padding: 0.875rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 1rem;">
        Cancel
      </button>
    </div>
  </div>

  <script>
    let currentUser = null;
    let currentPage = 1;
    let itemsPerPage = 8;
    let filteredGuardsList = [];

    // Toast Notification System
    function showToast(type, title, message, duration = 4000) {
      const container = document.getElementById('toastContainer');
      const toastId = 'toast-' + Date.now();

      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      };

      const toast = document.createElement('div');
      toast.id = toastId;
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <div class="toast-icon">${icons[type] || icons.info}</div>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          <div class="toast-message">${message}</div>
        </div>
        <button class="toast-close" onclick="closeToast('${toastId}')">‚úï</button>
      `;

      container.appendChild(toast);

      // Auto-remove after duration
      setTimeout(() => {
        closeToast(toastId);
      }, duration);
    }

    function closeToast(toastId) {
      const toast = document.getElementById(toastId);
      if (toast) {
        toast.classList.add('hiding');
        setTimeout(() => {
          toast.remove();
        }, 300); // Match animation duration
      }
    }

    // Function to hide Google Apps Script banner
    function hideGoogleBanner() {
      // Hide the "This application was created by a Google Apps Script user" banner
      const checkAndHide = () => {
        // Target Google's banner/warning elements
        const bannerSelectors = [
          'div[style*="background-color: rgb(255, 229, 153)"]',
          'div[style*="background-color: #ffe599"]',
          'div[style*="border: 1px solid rgb(240, 195, 109)"]',
          'div[aria-live="assertive"]',
          'div[role="alert"]'
        ];

        bannerSelectors.forEach(selector => {
          const elements = document.querySelectorAll(selector);
          elements.forEach(el => {
            const text = el.textContent || '';
            if (text.includes('Google Apps Script') || text.includes('application was created')) {
              el.style.display = 'none';
              el.remove();
            }
          });
        });

        // Also check for iframes that might contain the banner
        const iframes = document.querySelectorAll('iframe');
        iframes.forEach(iframe => {
          try {
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
            if (iframeDoc) {
              const bannerInIframe = iframeDoc.querySelector('div[style*="background-color"]');
              if (bannerInIframe && bannerInIframe.textContent.includes('Google Apps Script')) {
                bannerInIframe.style.display = 'none';
              }
            }
          } catch (e) {
            // Cross-origin iframe, can't access
          }
        });
      };

      // Run multiple times to catch dynamically added banners
      checkAndHide();
      setTimeout(checkAndHide, 100);
      setTimeout(checkAndHide, 500);
      setTimeout(checkAndHide, 1000);

      // Set up a mutation observer to catch any dynamically added banners
      const observer = new MutationObserver(checkAndHide);
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    }

    // Check for saved session on page load
    window.addEventListener('DOMContentLoaded', () => {
      // Hide Google Apps Script banner
      hideGoogleBanner();

      const savedUser = localStorage.getItem('guardMonitoringUser');
      if (savedUser) {
        try {
          currentUser = JSON.parse(savedUser);
          showDashboardContent();
        } catch (e) {
          localStorage.removeItem('guardMonitoringUser');
          showLandingPage();
        }
      } else {
        showLandingPage();
      }
    });

    function showLandingPage() {
      document.getElementById('landingPage').style.display = 'flex';
      document.getElementById('dashboardPage').style.display = 'none';
    }

    function hideLandingPage() {
      document.getElementById('landingPage').style.display = 'none';
      document.getElementById('dashboardPage').style.display = 'block';
    }

    function runSetup() {
      const setupMsg = document.getElementById('setupMessage');
      setupMsg.style.display = 'block';
      setupMsg.style.background = 'rgba(59, 130, 246, 0.2)';
      setupMsg.style.border = '1px solid #3B82F6';
      setupMsg.style.color = '#93C5FD';
      setupMsg.textContent = '‚è≥ Setting up database sheets...';

      google.script.run
        .withSuccessHandler(handleSetupSuccess)
        .withFailureHandler(handleSetupFailure)
        .setupSheets();
    }

    function handleSetupSuccess(result) {
      const setupMsg = document.getElementById('setupMessage');

      if (result.success) {
        setupMsg.style.background = 'rgba(34, 197, 94, 0.2)';
        setupMsg.style.border = '1px solid #22C55E';
        setupMsg.style.color = '#86EFAC';
        setupMsg.textContent = '‚úì ' + result.message;
      } else {
        setupMsg.style.background = 'rgba(239, 68, 68, 0.2)';
        setupMsg.style.border = '1px solid #EF4444';
        setupMsg.style.color = '#FCA5A5';
        setupMsg.textContent = '‚úó ' + result.message;
      }
    }

    function handleSetupFailure(error) {
      const setupMsg = document.getElementById('setupMessage');
      setupMsg.style.display = 'block';
      setupMsg.style.background = 'rgba(239, 68, 68, 0.2)';
      setupMsg.style.border = '1px solid #EF4444';
      setupMsg.style.color = '#FCA5A5';
      setupMsg.textContent = '‚úó Setup failed: ' + error.message;
    }

    function openDashboard() {
      document.getElementById('loginModal').style.display = 'flex';
      document.getElementById('username').focus();
    }

    function closeLoginModal() {
      document.getElementById('loginModal').style.display = 'none';
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
      document.getElementById('errorMessage').style.display = 'none';
    }

    function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const errorMsg = document.getElementById('errorMessage');
      const loginBtn = document.getElementById('loginBtn');

      if (!username || !password) {
        showError('Please enter both username and password');
        return;
      }

      // Show loading state
      loginBtn.textContent = 'Logging in...';
      loginBtn.disabled = true;
      errorMsg.style.display = 'none';

      // Call server-side authentication
      google.script.run
        .withSuccessHandler(handleLoginSuccess)
        .withFailureHandler(handleLoginFailure)
        .authenticateUser(username, password);
    }

    function handleLoginSuccess(result) {
      const loginBtn = document.getElementById('loginBtn');
      loginBtn.textContent = 'Login';
      loginBtn.disabled = false;

      if (result.success) {
        currentUser = result.user;
        // Save to localStorage for session persistence
        localStorage.setItem('guardMonitoringUser', JSON.stringify(result.user));
        showError('‚úì ' + result.message, true);

        // Redirect after successful login
        setTimeout(() => {
          closeLoginModal();
          showDashboardContent();
        }, 1000);
      } else {
        showError(result.message);
      }
    }

    function handleLoginFailure(error) {
      const loginBtn = document.getElementById('loginBtn');
      loginBtn.textContent = 'Login';
      loginBtn.disabled = false;
      showError('An error occurred. Please try again.');
      console.error(error);
    }

    function showError(message, isSuccess = false) {
      const errorMsg = document.getElementById('errorMessage');
      errorMsg.textContent = message;
      errorMsg.style.display = 'block';

      if (isSuccess) {
        errorMsg.style.background = 'rgba(34, 197, 94, 0.2)';
        errorMsg.style.borderColor = '#22C55E';
        errorMsg.style.color = '#86EFAC';
      } else {
        errorMsg.style.background = 'rgba(239, 68, 68, 0.2)';
        errorMsg.style.borderColor = '#EF4444';
        errorMsg.style.color = '#FCA5A5';
      }
    }

    function logout() {
      localStorage.removeItem('guardMonitoringUser');
      currentUser = null;
      showLandingPage();
      // Clear dashboard content
      document.getElementById('dashboardPage').innerHTML = '';
    }

    let currentView = 'dashboard';

    function navigateTo(view) {
      currentView = view;
      renderDashboard();

      // After rendering, load data if needed
      setTimeout(() => {
        if (view === 'guards') {
          loadGuards();
        } else if (view === 'performance') {
          loadAllRecords();
        } else if (view === 'users') {
          loadUsers();
        } else if (view === 'settings') {
          loadSettings();
        }
      }, 100);
    }

    function showDashboardContent() {
      // Hide landing page and show dashboard
      hideLandingPage();
      currentView = 'dashboard';
      renderDashboard();
    }

    function renderDashboard() {
      const dashboardContainer = document.getElementById('dashboardPage');

      dashboardContainer.innerHTML = `
        <style>
          .sidebar-menu-item {
            transition: all 0.2s ease;
          }
          /* Hover - subtle feedback */
          .sidebar-menu-item:hover {
            background: rgba(129, 215, 66, 0.1) !important;
            border-left: 4px solid rgba(129, 215, 66, 0.5) !important;
          }
          /* Active/Current Page - clear indication */
          .sidebar-menu-item.active {
            background: rgba(129, 215, 66, 0.15) !important;
            border-left: 4px solid #81d742 !important;
          }
          /* Click - tactile feedback */
          .sidebar-menu-item:active {
            transform: scale(0.97);
          }
        </style>
        <div style="display: flex; min-height: 100vh; background: linear-gradient(135deg, #006341 0%, #007850 100%);">
          <!-- Sidebar -->
          <div id="sidebar" style="width: ${isSidebarOpen ? '280px' : '80px'}; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); padding: 2rem 0; display: flex; flex-direction: column; transition: all 0.3s ease; overflow: hidden;">
            <!-- Toggle Button Inside Sidebar -->
            <div style="padding: 0 1.5rem 1rem; display: flex; justify-content: ${isSidebarOpen ? 'flex-end' : 'center'};">
              <button id="sidebarToggle" onclick="toggleSidebar()" style="background: rgba(251, 191, 36, 0.9); border: none; color: #006341; width: 40px; height: 40px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.3);" onmouseover="this.style.background='#FBBF24';" onmouseout="this.style.background='rgba(251, 191, 36, 0.9)';">
                ${isSidebarOpen ? '‚Äπ' : '‚Ä∫'}
              </button>
            </div>

            <!-- User Info -->
            <div style="padding: 0 1.5rem 2rem; border-bottom: 1px solid rgba(251, 191, 36, 0.2); ${isSidebarOpen ? '' : 'display: none;'}">
              <div style="background: rgba(251, 191, 36, 0.1); border: 2px solid #81d742; border-radius: 50%; width: 80px; height: 80px; margin: 0 auto 1rem; display: flex; align-items: center; justify-content: center; font-size: 2rem; color: #81d742;">
                ${currentUser.fullName.charAt(0).toUpperCase()}
              </div>
              <h3 style="color: #81d742; font-size: 1.1rem; margin: 0; text-align: center; font-weight: 700;">${currentUser.fullName}</h3>
              <p style="color: white; opacity: 0.7; font-size: 0.875rem; margin: 0.5rem 0 0; text-align: center;">${currentUser.role}</p>
            </div>

            <!-- Navigation Menu -->
            <nav style="flex: 1; padding: 1.5rem 0;">
              <div class="sidebar-menu-item ${currentView === 'dashboard' ? 'active' : ''}" onclick="navigateTo('dashboard')" style="padding: 1rem ${isSidebarOpen ? '1.5rem' : '0'}; color: white; cursor: pointer; display: flex; align-items: center; ${isSidebarOpen ? 'gap: 0.75rem' : 'justify-content: center'}; border-left: 4px solid transparent;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                <span style="font-weight: 500; ${isSidebarOpen ? '' : 'display: none;'}">Dashboard</span>
              </div>

              <div class="sidebar-menu-item ${currentView === 'guards' ? 'active' : ''}" onclick="navigateTo('guards')" style="padding: 1rem ${isSidebarOpen ? '1.5rem' : '0'}; color: white; cursor: pointer; display: flex; align-items: center; ${isSidebarOpen ? 'gap: 0.75rem' : 'justify-content: center'}; border-left: 4px solid transparent;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <span style="font-weight: 500; ${isSidebarOpen ? '' : 'display: none;'}">Guards</span>
              </div>

              <div class="sidebar-menu-item ${currentView === 'performance' ? 'active' : ''}" onclick="navigateTo('performance')" style="padding: 1rem ${isSidebarOpen ? '1.5rem' : '0'}; color: white; cursor: pointer; display: flex; align-items: center; ${isSidebarOpen ? 'gap: 0.75rem' : 'justify-content: center'}; border-left: 4px solid transparent;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                <span style="font-weight: 500; ${isSidebarOpen ? '' : 'display: none;'}">Records Monitoring</span>
              </div>

              ${currentUser.role === 'Admin' ? `
              <div class="sidebar-menu-item ${currentView === 'users' ? 'active' : ''}" onclick="navigateTo('users')" style="padding: 1rem ${isSidebarOpen ? '1.5rem' : '0'}; color: white; cursor: pointer; display: flex; align-items: center; ${isSidebarOpen ? 'gap: 0.75rem' : 'justify-content: center'}; border-left: 4px solid transparent;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <span style="font-weight: 500; ${isSidebarOpen ? '' : 'display: none;'}">User Management</span>
              </div>
              ` : ''}

              <div class="sidebar-menu-item" onclick="openChangePasswordModal()" style="padding: 1rem ${isSidebarOpen ? '1.5rem' : '0'}; color: white; cursor: pointer; display: flex; align-items: center; ${isSidebarOpen ? 'gap: 0.75rem' : 'justify-content: center'}; border-left: 4px solid transparent;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                <span style="font-weight: 500; ${isSidebarOpen ? '' : 'display: none;'}">Change Password</span>
              </div>

              ${currentUser.role === 'Admin' ? `
              <div class="sidebar-menu-item ${currentView === 'settings' ? 'active' : ''}" onclick="navigateTo('settings')" style="padding: 1rem ${isSidebarOpen ? '1.5rem' : '0'}; color: white; cursor: pointer; display: flex; align-items: center; ${isSidebarOpen ? 'gap: 0.75rem' : 'justify-content: center'}; border-left: 4px solid transparent;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M12 1v6M12 17v6M4.22 4.22l4.24 4.25M15.54 15.54l4.24 4.25M1 12h6M17 12h6M4.22 19.78l4.24-4.25M15.54 8.46l4.24-4.25"></path></svg>
                <span style="font-weight: 500; ${isSidebarOpen ? '' : 'display: none;'}">Settings</span>
              </div>
              ` : ''}
            </nav>

            <!-- Logout Button -->
            <div style="padding: 0 ${isSidebarOpen ? '1.5rem' : '0.5rem'}; border-top: 1px solid rgba(251, 191, 36, 0.2); padding-top: 1.5rem;">
              <button onclick="logout()" style="width: 100%; background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 0.875rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                <span style="${isSidebarOpen ? '' : 'display: none;'}">Logout</span>
              </button>
            </div>
          </div>

          <!-- Main Content Area -->
          <div style="flex: 1; padding: 2rem; overflow-y: auto;">
            ${renderMainContent()}
          </div>
        </div>
      `;
    }

    function renderMainContent() {
      switch(currentView) {
        case 'dashboard':
          return renderDashboardView();
        case 'guards':
          return renderGuardsView();
        case 'performance':
          return renderPerformanceView();
        case 'users':
          return renderUsersView();
        case 'settings':
          return renderSettingsView();
        default:
          return renderDashboardView();
      }
    }

    // Global variable for selected month
    let selectedDashboardMonth = new Date().getMonth() + 1; // Current month (1-12)
    let selectedDashboardYear = new Date().getFullYear();
    let isAllYearView = false; // Track if viewing all year data
    let isSidebarOpen = true; // Track sidebar state

    function renderDashboardView() {
      // Load dashboard stats and top statistics when dashboard is rendered
      setTimeout(() => {
        loadDashboardStats();
        loadTopStatistics();
      }, 100);

      // Generate month options
      const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];

      const currentMonth = new Date().getMonth() + 1;
      const currentYear = new Date().getFullYear();

      const monthOptions = months.map((month, index) => {
        const monthNum = index + 1;
        const isSelected = monthNum === selectedDashboardMonth && currentYear === selectedDashboardYear;
        return `<option value="${monthNum}" ${isSelected ? 'selected' : ''}>${month} ${currentYear}</option>`;
      }).join('');

      return `
        <div id="dashboardContent">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
              <h1 style="color: #FBBF24; font-size: 2.5rem; margin: 0 0 0.5rem; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Dashboard</h1>
              <p style="color: rgba(255,255,255,0.95); font-size: 1.05rem; margin: 0; font-weight: 500;">Welcome back, <span style="color: #FBBF24;">${currentUser.fullName}</span> !</p>
            </div>
            <div style="display: flex; gap: 1rem; align-items: flex-end;">
              <div style="min-width: 200px;">
                <label style="display: block; color: #FBBF24; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">üìÖ Filter by Month</label>
                <select
                  id="dashboardMonthFilter"
                  onchange="filterDashboardByMonth(this.value)"
                  style="width: 100%; padding: 0.875rem 1rem; background: #006341; border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 10px; color: white; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease;"
                  onfocus="this.style.border='2px solid #FBBF24';"
                  onblur="this.style.border='2px solid rgba(251, 191, 36, 0.4)';"
                >
                  ${monthOptions}
                </select>
              </div>
              <button onclick="filterDashboardAllYear()" style="background: rgba(251, 191, 36, 0.2); border: 2px solid #FBBF24; color: #FBBF24; padding: 0.875rem 1.5rem; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 0.95rem; transition: all 0.3s ease; white-space: nowrap;" onmouseover="this.style.background='rgba(251, 191, 36, 0.3)'; this.style.transform='translateY(-2px)';" onmouseout="this.style.background='rgba(251, 191, 36, 0.2)'; this.style.transform='';">
                üìä All Year
              </button>
            </div>
          </div>

          <!-- Quick Stats Grid -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem;">
            <!-- Active Guards -->
            <div style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 2px solid rgba(251, 191, 36, 0.4); border-bottom: 3px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2); transition: border-bottom-color 0.3s;" onmouseover="this.style.borderBottomColor='#FBBF24';" onmouseout="this.style.borderBottomColor='rgba(251, 191, 36, 0.4)';">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Active Guards</p>
                  <h2 id="activeGuardsCount" style="color: #6EE7B7; font-size: 3rem; margin: 0.5rem 0; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">0</h2>
                  <p style="color: #FBBF24; font-size: 0.95rem; margin: 0; font-weight: 600;"><span id="totalGuardsCount">0</span> Total Guards</p>
                </div>
                <div style="font-size: 3rem; opacity: 0.8;">üëÆ</div>
              </div>
            </div>

            <!-- Expired Licenses -->
            <div style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 2px solid rgba(251, 191, 36, 0.4); border-bottom: 3px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2); transition: border-bottom-color 0.3s;" onmouseover="this.style.borderBottomColor='#FBBF24';" onmouseout="this.style.borderBottomColor='rgba(251, 191, 36, 0.4)';">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Expired Licenses</p>
                  <h2 id="expiredLicensesCount" style="color: #FCA5A5; font-size: 3rem; margin: 0.5rem 0; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">0</h2>
                  <p style="color: rgba(255,255,255,0.85); font-size: 0.95rem; margin: 0; font-weight: 600;">Active Guards Only</p>
                </div>
                <div style="font-size: 3rem; opacity: 0.8;">üìã</div>
              </div>
            </div>

            <!-- Health Monitoring -->
            <div style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 2px solid rgba(251, 191, 36, 0.4); border-bottom: 3px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2); transition: border-bottom-color 0.3s;" onmouseover="this.style.borderBottomColor='#FBBF24';" onmouseout="this.style.borderBottomColor='rgba(251, 191, 36, 0.4)';">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Normal BMI</p>
                  <h2 id="bmiNormalCount" style="color: #22C55E; font-size: 3rem; margin: 0.5rem 0; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">0</h2>
                  <p style="color: rgba(255,255,255,0.85); font-size: 1.1rem; margin: 0; font-weight: 700; display: flex; gap: 0.75rem; flex-wrap: nowrap; white-space: nowrap;">
                    <span style="color: #FBBF24;">‚Üì <span id="bmiUnderweightCount">0</span></span>
                    <span style="color: #FB923C;">‚Üë <span id="bmiOverweightCount">0</span></span>
                    <span style="color: #EF4444;">‚ö† <span id="bmiObeseCount">0</span></span>
                  </p>
                </div>
                <div style="font-size: 3rem; opacity: 0.8;">üí™</div>
              </div>
            </div>

            <!-- Accomplishments -->
            <div style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 2px solid rgba(251, 191, 36, 0.4); border-bottom: 3px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2); transition: border-bottom-color 0.3s;" onmouseover="this.style.borderBottomColor='#FBBF24';" onmouseout="this.style.borderBottomColor='rgba(251, 191, 36, 0.4)';">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Accomplishments</p>
                  <h2 id="monthlyAccomplishmentsCount" style="color: #6EE7B7; font-size: 3rem; margin: 0.5rem 0; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">0</h2>
                  <p id="accomplishmentsMonthLabel" style="color: rgba(255,255,255,0.85); font-size: 0.95rem; margin: 0; font-weight: 600;">This month</p>
                </div>
                <div style="font-size: 3rem; opacity: 0.8;">üèÜ</div>
              </div>
            </div>

            <!-- Violations -->
            <div style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 2px solid rgba(251, 191, 36, 0.4); border-bottom: 3px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2); transition: border-bottom-color 0.3s;" onmouseover="this.style.borderBottomColor='#FBBF24';" onmouseout="this.style.borderBottomColor='rgba(251, 191, 36, 0.4)';">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <p style="color: rgba(255,255,255,0.9); font-size: 0.9rem; margin: 0; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Violations</p>
                  <h2 id="monthlyViolationsCount" style="color: #FCA5A5; font-size: 3rem; margin: 0.5rem 0; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">0</h2>
                  <p id="violationsMonthLabel" style="color: rgba(255,255,255,0.85); font-size: 0.95rem; margin: 0; font-weight: 600;">This month</p>
                </div>
                <div style="font-size: 3rem; opacity: 0.8;">‚ö†Ô∏è</div>
              </div>
            </div>
          </div>

          <!-- Charts Section -->
          <div style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 2rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2); margin-bottom: 2rem;">
            <h2 style="color: #FBBF24; font-size: 1.5rem; margin: 0 0 1.5rem; display: flex; align-items: center; gap: 0.75rem; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">
              <span style="font-size: 2rem;">üìä</span>
              Performance Analytics
            </h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem;">
              <!-- Top Guards Accomplishments Chart -->
              <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1.5rem;">
                <h3 style="color: #6EE7B7; font-size: 1rem; margin: 0 0 1rem; font-weight: 600; text-align: center;">üèÜ Top Performers</h3>
                <canvas id="topAccomplishmentsChart" style="max-height: 300px;"></canvas>
              </div>

              <!-- Top Violation Types Chart -->
              <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1.5rem;">
                <h3 style="color: #FCA5A5; font-size: 1rem; margin: 0 0 1rem; font-weight: 600; text-align: center;">‚ö†Ô∏è Violation Type Analysis</h3>
                <canvas id="topViolationTypesChart" style="max-height: 300px;"></canvas>
              </div>

              <!-- Top Guards Violations Chart -->
              <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 1.5rem;">
                <h3 style="color: #FCA5A5; font-size: 1rem; margin: 0 0 1rem; font-weight: 600; text-align: center;">üö® Violations Overview</h3>
                <canvas id="topViolationsChart" style="max-height: 300px;"></canvas>
              </div>
            </div>
          </div>

          <!-- Top 5 Cards Grid -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; margin-top: 2.5rem;">
            <!-- Top 5 Guards with Accomplishments -->
            <div style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
              <h3 id="topAccomplishmentsTitle" style="color: #FBBF24; font-size: 1.15rem; margin: 0 0 1.25rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">
                <span style="font-size: 1.5rem;">üèÜ</span>
                Accomplishment Rankings (This Month)
              </h3>
              <div id="topGuardsAccomplishmentsContainer" style="min-height: 150px;">
                <p style="color: rgba(255,255,255,0.7); text-align: center; padding: 2rem; font-weight: 500;">Loading...</p>
              </div>
            </div>

            <!-- Top 5 Violation Types -->
            <div style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
              <h3 id="topViolationTypesTitle" style="color: #FBBF24; font-size: 1.15rem; margin: 0 0 1.25rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">
                <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                Violation Type Summary (This Month)
              </h3>
              <div id="topViolationTypesContainer" style="min-height: 150px;">
                <p style="color: rgba(255,255,255,0.7); text-align: center; padding: 2rem; font-weight: 500;">Loading...</p>
              </div>
            </div>

            <!-- Top 5 Guards with Violations -->
            <div style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 2px solid rgba(251, 191, 36, 0.4); border-radius: 16px; padding: 1.5rem; box-shadow: 0 8px 32px rgba(0,0,0,0.2);">
              <h3 id="topViolationsTitle" style="color: #FBBF24; font-size: 1.15rem; margin: 0 0 1.25rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">
                <span style="font-size: 1.5rem;">üö®</span>
                Top Violators (This Month)
              </h3>
              <div id="topGuardsViolationsContainer" style="min-height: 150px;">
                <p style="color: rgba(255,255,255,0.7); text-align: center; padding: 2rem; font-weight: 500;">Loading...</p>
              </div>
            </div>
          </div>

          <!-- Copyright Bar -->
          <div style="margin-top: 3rem; padding: 1.5rem 0; border-top: 2px solid rgba(251, 191, 36, 0.3); text-align: center;">
            <p style="color: rgba(255,255,255,0.7); font-size: 0.85rem; margin: 0;">
              ¬© ${new Date().getFullYear()} Guard Monitoring System. All rights reserved. | Powered by Google Apps Script
            </p>
          </div>
        </div>
      `;
    }

    let guardsList = [];

    // Filter dashboard by month
    function filterDashboardByMonth(month) {
      isAllYearView = false; // Exit all year view
      selectedDashboardMonth = parseInt(month);

      // Update month labels
      const months = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
      ];
      const monthName = months[selectedDashboardMonth - 1];
      const currentMonth = new Date().getMonth() + 1;
      const label = selectedDashboardMonth === currentMonth ? 'This month' : monthName;

      // Update card labels
      const accomplishmentsLabel = document.getElementById('accomplishmentsMonthLabel');
      const violationsLabel = document.getElementById('violationsMonthLabel');
      if (accomplishmentsLabel) accomplishmentsLabel.textContent = label;
      if (violationsLabel) violationsLabel.textContent = label;

      // Update Top 5 card titles
      const topAccomplishmentsTitle = document.getElementById('topAccomplishmentsTitle');
      const topViolationTypesTitle = document.getElementById('topViolationTypesTitle');
      const topViolationsTitle = document.getElementById('topViolationsTitle');

      const titleSuffix = selectedDashboardMonth === currentMonth ? '(This Month)' : `(${monthName} ${selectedDashboardYear})`;

      // Safely update titles using textContent for user-controlled parts
      if (topAccomplishmentsTitle) {
        topAccomplishmentsTitle.innerHTML = '<span style="font-size: 1.5rem;">üèÜ</span> ';
        const titleText = document.createTextNode('Guard Accomplishment Rankings ' + titleSuffix);
        topAccomplishmentsTitle.appendChild(titleText);
      }
      if (topViolationTypesTitle) {
        topViolationTypesTitle.innerHTML = '<span style="font-size: 1.5rem;">‚ö†Ô∏è</span> ';
        const titleText = document.createTextNode('Violation Type Summary ' + titleSuffix);
        topViolationTypesTitle.appendChild(titleText);
      }
      if (topViolationsTitle) {
        topViolationsTitle.innerHTML = '<span style="font-size: 1.5rem;">üö®</span> ';
        const titleText = document.createTextNode('Top Violators ' + titleSuffix);
        topViolationsTitle.appendChild(titleText);
      }

      // Reload data with selected month
      loadDashboardStats(selectedDashboardMonth, selectedDashboardYear);
      loadTopStatistics(selectedDashboardMonth, selectedDashboardYear);
    }

    // Filter dashboard for all year
    function filterDashboardAllYear() {
      isAllYearView = true;

      // Update card labels
      const accomplishmentsLabel = document.getElementById('accomplishmentsMonthLabel');
      const violationsLabel = document.getElementById('violationsMonthLabel');
      if (accomplishmentsLabel) accomplishmentsLabel.textContent = `All Year ${selectedDashboardYear}`;
      if (violationsLabel) violationsLabel.textContent = `All Year ${selectedDashboardYear}`;

      // Update Top 5 card titles
      const topAccomplishmentsTitle = document.getElementById('topAccomplishmentsTitle');
      const topViolationTypesTitle = document.getElementById('topViolationTypesTitle');
      const topViolationsTitle = document.getElementById('topViolationsTitle');

      const titleSuffix = `(All Year ${selectedDashboardYear})`;

      // Safely update titles using textContent for user-controlled parts
      if (topAccomplishmentsTitle) {
        topAccomplishmentsTitle.innerHTML = '<span style="font-size: 1.5rem;">üèÜ</span> ';
        const titleText = document.createTextNode('Guard Accomplishment Rankings ' + titleSuffix);
        topAccomplishmentsTitle.appendChild(titleText);
      }
      if (topViolationTypesTitle) {
        topViolationTypesTitle.innerHTML = '<span style="font-size: 1.5rem;">‚ö†Ô∏è</span> ';
        const titleText = document.createTextNode('Violation Type Summary ' + titleSuffix);
        topViolationTypesTitle.appendChild(titleText);
      }
      if (topViolationsTitle) {
        topViolationsTitle.innerHTML = '<span style="font-size: 1.5rem;">üö®</span> ';
        const titleText = document.createTextNode('Top Violators ' + titleSuffix);
        topViolationsTitle.appendChild(titleText);
      }

      // Reload data for entire year (pass null for month to get all year data)
      loadDashboardStats(null, selectedDashboardYear, true);
      loadTopStatistics(null, selectedDashboardYear, true);
    }

    // Toggle sidebar open/close
    function toggleSidebar() {
      isSidebarOpen = !isSidebarOpen;

      // Re-render to update sidebar state
      showDashboardContent();
    }

    // Load dashboard statistics with loading animation
    function loadDashboardStats(month = null, year = null, isAllYear = false) {
      const filterMonth = isAllYear ? null : (month || selectedDashboardMonth);
      const filterYear = year || selectedDashboardYear;

      // Show loading state on all stat cards
      const statElements = [
        'totalGuardsCount',
        'activeGuardsCount',
        'expiredLicensesCount',
        'monthlyViolationsCount',
        'monthlyAccomplishmentsCount',
        'bmiNormalCount',
        'bmiUnderweightCount',
        'bmiOverweightCount',
        'bmiObeseCount'
      ];

      statElements.forEach(id => {
        const elem = document.getElementById(id);
        if (elem) {
          elem.innerHTML = '<span class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></span>';
        }
      });

      google.script.run
        .withSuccessHandler(function(stats) {
          // Safely update stat elements
          const setStatIfExists = (id, value) => {
            const elem = document.getElementById(id);
            if (elem) elem.textContent = value;
          };

          setStatIfExists('totalGuardsCount', stats.totalGuards);
          setStatIfExists('activeGuardsCount', stats.activeGuards);
          setStatIfExists('expiredLicensesCount', stats.expiredLicenses);
          setStatIfExists('monthlyViolationsCount', stats.monthlyViolations);
          setStatIfExists('monthlyAccomplishmentsCount', stats.monthlyAccomplishments);
          setStatIfExists('bmiNormalCount', stats.bmiNormal || 0);
          setStatIfExists('bmiUnderweightCount', stats.bmiUnderweight || 0);
          setStatIfExists('bmiOverweightCount', stats.bmiOverweight || 0);
          setStatIfExists('bmiObeseCount', stats.bmiObese || 0);
        })
        .withFailureHandler(function(error) {
          console.error('Error loading dashboard stats:', error);
          showToast('Failed to load dashboard statistics', 'error');
          // Reset to dashes on error
          statElements.forEach(id => {
            const elem = document.getElementById(id);
            if (elem) elem.textContent = '--';
          });
        })
        .getDashboardStats(filterMonth, filterYear);
    }

    // Load top statistics with loading animations
    function loadTopStatistics(month = null, year = null, isAllYear = false) {
      const filterMonth = isAllYear ? null : (month || selectedDashboardMonth);
      const filterYear = year || selectedDashboardYear;

      // Show loading spinners for all Top 5 containers
      const loadingHTML = '<div style="display: flex; justify-content: center; align-items: center; padding: 2rem;"><span class="spinner"></span></div>';

      const topViolationTypesContainer = document.getElementById('topViolationTypesContainer');
      const topGuardsAccomplishmentsContainer = document.getElementById('topGuardsAccomplishmentsContainer');
      const topGuardsViolationsContainer = document.getElementById('topGuardsViolationsContainer');

      if (topViolationTypesContainer) topViolationTypesContainer.innerHTML = loadingHTML;
      if (topGuardsAccomplishmentsContainer) topGuardsAccomplishmentsContainer.innerHTML = loadingHTML;
      if (topGuardsViolationsContainer) topGuardsViolationsContainer.innerHTML = loadingHTML;

      // Load top violation types
      google.script.run
        .withSuccessHandler(renderTopViolationTypes)
        .withFailureHandler(function(error) {
          console.error('Error loading top violation types:', error);
          const container = document.getElementById('topViolationTypesContainer');
          if (container) {
            container.innerHTML = '<p style="color: white; opacity: 0.6; text-align: center; padding: 1rem;">Failed to load data</p>';
          }
        })
        .getTopViolationTypes(filterMonth, filterYear);

      // Load top guards accomplishments
      google.script.run
        .withSuccessHandler(renderTopGuardsAccomplishments)
        .withFailureHandler(function(error) {
          console.error('Error loading top guards accomplishments:', error);
          const container = document.getElementById('topGuardsAccomplishmentsContainer');
          if (container) {
            container.innerHTML = '<p style="color: white; opacity: 0.6; text-align: center; padding: 1rem;">Failed to load data</p>';
          }
        })
        .getTopGuardsAccomplishments(filterMonth, filterYear);

      // Load top guards violations
      google.script.run
        .withSuccessHandler(renderTopGuardsViolations)
        .withFailureHandler(function(error) {
          console.error('Error loading top guards violations:', error);
          const container = document.getElementById('topGuardsViolationsContainer');
          if (container) {
            container.innerHTML = '<p style="color: white; opacity: 0.6; text-align: center; padding: 1rem;">Failed to load data</p>';
          }
        })
        .getTopGuardsViolations(filterMonth, filterYear);
    }

    // Global chart instances
    let topAccomplishmentsChart = null;
    let topViolationTypesChart = null;
    let topViolationsChart = null;

    // Render top violation types
    function renderTopViolationTypes(data) {
      const container = document.getElementById('topViolationTypesContainer');

      // Safety check: if container doesn't exist, exit early
      if (!container) {
        console.warn('topViolationTypesContainer not found');
        return;
      }

      if (!data || data.length === 0) {
        container.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center; padding: 1rem; font-weight: 500;">No violations this month</p>';
        renderViolationTypesChart([]);
        return;
      }

      const html = data.map((item, index) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.85rem; border-bottom: 1px solid rgba(251, 191, 36, 0.2); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background=''">
          <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
            <span style="color: #FBBF24; font-weight: 800; font-size: 1.2rem; min-width: 2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">#${index + 1}</span>
            <span style="color: rgba(255,255,255,0.95); font-size: 1rem; font-weight: 500;">${item.violationType}</span>
          </div>
          <span style="background: rgba(252, 165, 165, 0.3); color: #FFFFFF; padding: 0.35rem 0.85rem; border-radius: 16px; font-weight: 700; font-size: 0.95rem; box-shadow: 0 2px 4px rgba(0,0,0,0.15);">${item.count}</span>
        </div>
      `).join('');

      container.innerHTML = html;
      renderViolationTypesChart(data);
    }

    // Render top guards accomplishments
    function renderTopGuardsAccomplishments(data) {
      const container = document.getElementById('topGuardsAccomplishmentsContainer');

      // Safety check: if container doesn't exist, exit early
      if (!container) {
        console.warn('topGuardsAccomplishmentsContainer not found');
        return;
      }

      if (!data || data.length === 0) {
        container.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center; padding: 1rem; font-weight: 500;">No accomplishments this month</p>';
        renderAccomplishmentsChart([]);
        return;
      }

      const html = data.map((item, index) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.85rem; border-bottom: 1px solid rgba(251, 191, 36, 0.2); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background=''">
          <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
            <span style="color: #FBBF24; font-weight: 800; font-size: 1.2rem; min-width: 2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">#${index + 1}</span>
            <span style="color: rgba(255,255,255,0.95); font-size: 1rem; font-weight: 500;">${item.guardName}</span>
          </div>
          <span style="background: rgba(110, 231, 183, 0.3); color: #FFFFFF; padding: 0.35rem 0.85rem; border-radius: 16px; font-weight: 700; font-size: 0.95rem; box-shadow: 0 2px 4px rgba(0,0,0,0.15);">${item.count}</span>
        </div>
      `).join('');

      container.innerHTML = html;
      renderAccomplishmentsChart(data);
    }

    // Render top guards violations
    function renderTopGuardsViolations(data) {
      const container = document.getElementById('topGuardsViolationsContainer');

      // Safety check: if container doesn't exist, exit early
      if (!container) {
        console.warn('topGuardsViolationsContainer not found');
        return;
      }

      if (!data || data.length === 0) {
        container.innerHTML = '<p style="color: rgba(255,255,255,0.7); text-align: center; padding: 1rem; font-weight: 500;">No violations this month</p>';
        renderViolationsChart([]);
        return;
      }

      const html = data.map((item, index) => `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.85rem; border-bottom: 1px solid rgba(251, 191, 36, 0.2); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background=''">
          <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1;">
            <span style="color: #FBBF24; font-weight: 800; font-size: 1.2rem; min-width: 2rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">#${index + 1}</span>
            <span style="color: rgba(255,255,255,0.95); font-size: 1rem; font-weight: 500;">${item.guardName}</span>
          </div>
          <span style="background: rgba(252, 165, 165, 0.3); color: #FFFFFF; padding: 0.35rem 0.85rem; border-radius: 16px; font-weight: 700; font-size: 0.95rem; box-shadow: 0 2px 4px rgba(0,0,0,0.15);">${item.count}</span>
        </div>
      `).join('');

      container.innerHTML = html;
      renderViolationsChart(data);
    }

    // Chart rendering functions
    function renderAccomplishmentsChart(data) {
      const canvas = document.getElementById('topAccomplishmentsChart');
      if (!canvas) return;

      // Destroy existing chart
      if (topAccomplishmentsChart) {
        topAccomplishmentsChart.destroy();
      }

      if (!data || data.length === 0) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No data available', canvas.width / 2, canvas.height / 2);
        return;
      }

      const ctx = canvas.getContext('2d');
      topAccomplishmentsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map((item, index) => `Guard ${index + 1}`),
          datasets: [{
            label: 'Accomplishments',
            data: data.map(item => item.count),
            backgroundColor: 'rgba(110, 231, 183, 0.7)',
            borderColor: '#6EE7B7',
            borderWidth: 2,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#6EE7B7',
              bodyColor: '#FFFFFF',
              padding: 12,
              displayColors: false,
              callbacks: {
                title: function(context) {
                  return data[context[0].dataIndex].guardName;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: 'rgba(255,255,255,0.7)',
                stepSize: 1
              },
              grid: {
                color: 'rgba(255,255,255,0.1)'
              }
            },
            x: {
              display: false
            }
          }
        }
      });
    }

    function renderViolationTypesChart(data) {
      const canvas = document.getElementById('topViolationTypesChart');
      if (!canvas) return;

      // Destroy existing chart
      if (topViolationTypesChart) {
        topViolationTypesChart.destroy();
      }

      if (!data || data.length === 0) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No data available', canvas.width / 2, canvas.height / 2);
        return;
      }

      const ctx = canvas.getContext('2d');
      const colors = [
        'rgba(239, 68, 68, 0.7)',   // TOP 1: Red (most frequent)
        'rgba(251, 146, 60, 0.7)',  // TOP 2: Orange (second highest)
        'rgba(168, 85, 247, 0.7)',  // TOP 3: Purple (mid-level)
        'rgba(34, 197, 94, 0.7)',   // TOP 4: Green (less frequent)
        'rgba(59, 130, 246, 0.7)'   // TOP 5: Blue (least frequent)
      ];

      topViolationTypesChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: data.map(item => item.violationType.length > 20 ? item.violationType.substring(0, 17) + '...' : item.violationType),
          datasets: [{
            data: data.map(item => item.count),
            backgroundColor: colors.slice(0, data.length),
            borderColor: colors.slice(0, data.length).map(c => c.replace('0.7', '1')),
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#FCA5A5',
              bodyColor: '#FFFFFF',
              padding: 12,
              callbacks: {
                label: function(context) {
                  const label = data[context.dataIndex].violationType;
                  const value = context.parsed;
                  return label + ': ' + value;
                }
              }
            }
          }
        }
      });
    }

    function renderViolationsChart(data) {
      const canvas = document.getElementById('topViolationsChart');
      if (!canvas) return;

      // Destroy existing chart
      if (topViolationsChart) {
        topViolationsChart.destroy();
      }

      if (!data || data.length === 0) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = 'rgba(255,255,255,0.5)';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('No data available', canvas.width / 2, canvas.height / 2);
        return;
      }

      const ctx = canvas.getContext('2d');
      topViolationsChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map((item, index) => `Guard ${index + 1}`),
          datasets: [{
            label: 'Violations',
            data: data.map(item => item.count),
            backgroundColor: 'rgba(252, 165, 165, 0.7)',
            borderColor: '#FCA5A5',
            borderWidth: 2,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#FCA5A5',
              bodyColor: '#FFFFFF',
              padding: 12,
              displayColors: false,
              callbacks: {
                title: function(context) {
                  return data[context[0].dataIndex].guardName;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                color: 'rgba(255,255,255,0.7)',
                stepSize: 1
              },
              grid: {
                color: 'rgba(255,255,255,0.1)'
              }
            },
            x: {
              display: false
            }
          }
        }
      });
    }

    function getDocumentStatus(documents) {
      if (!documents) {
        return { label: 'No Documents', color: '#EF4444' };
      }

      const today = new Date();
      const thirtyDaysFromNow = new Date(today.getTime() + (30 * 24 * 60 * 60 * 1000));

      // Check all document expiry dates
      const documentDates = [
        documents.licenseExpiry,
        documents.policeClearance,
        documents.nbiClearance,
        documents.drugTestValidity,
        documents.neuroExamValidity
      ].filter(Boolean); // Remove null/undefined values

      if (documentDates.length === 0) {
        return { label: 'No Documents', color: '#EF4444' };
      }

      let hasExpired = false;
      let hasNearlyExpired = false;

      documentDates.forEach(dateStr => {
        const expiryDate = new Date(dateStr);

        if (expiryDate < today) {
          hasExpired = true;
        } else if (expiryDate <= thirtyDaysFromNow) {
          hasNearlyExpired = true;
        }
      });

      if (hasExpired) {
        return { label: 'Expired', color: '#EF4444' };
      } else if (hasNearlyExpired) {
        return { label: 'Nearly Expire', color: '#F59E0B' };
      } else {
        return { label: 'Good', color: '#22C55E' };
      }
    }

    function renderGuardsView() {
      return `
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
              <h1 style="color: #81d742; font-size: 2rem; margin: 0 0 0.5rem;">Guards List</h1>
              <p style="color: white; opacity: 0.7; margin: 0;">Manage your security personnel</p>
            </div>
            <div style="display: flex; gap: 1rem; align-items: center;">
              <button onclick="openAddGuardModal()" style="background: #81d742; color: #006341; padding: 0.875rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: all 0.3s ease;">
                + Add Guard
              </button>
              ${currentUser.role === 'Admin' ? `
              <button
                onclick="extractGuardsToExcel()"
                style="background: #81d742; color: #006341; padding: 0.875rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: all 0.3s ease;"
                onmouseover="this.style.background='#6bc92b'"
                onmouseout="this.style.background='#81d742'"
              >
                üìä Extract Guards
              </button>
              ` : ''}
            </div>
          </div>

          <!-- Search and Filter Controls -->
          <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(129, 215, 66, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <div style="display: flex; gap: 1rem; align-items: end;">
              <div style="width: 37.5%;">
                <label style="display: block; color: #81d742; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">üîç Search by Name</label>
                <input
                  type="text"
                  id="searchGuardInput"
                  placeholder="Search first name, middle name, or last name..."
                  oninput="filterGuards()"
                  style="width: 100%; padding: 0.875rem 1rem; background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(129, 215, 66, 0.4); border-radius: 10px; color: white; font-size: 0.95rem; transition: all 0.3s ease;"
                  onfocus="this.style.border='2px solid #81d742'; this.style.background='rgba(255, 255, 255, 0.2)';"
                  onblur="this.style.border='2px solid rgba(129, 215, 66, 0.4)'; this.style.background='rgba(255, 255, 255, 0.15)';"
                />
              </div>
              <div style="width: 12.5%;">
                <label style="display: block; color: #81d742; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">üìä Status</label>
                <select
                  id="statusFilter"
                  onchange="filterGuards()"
                  style="width: 100%; padding: 0.875rem 1rem; background: #006341; border: 2px solid rgba(129, 215, 66, 0.4); border-radius: 10px; color: white; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease;"
                  onfocus="this.style.border='2px solid #81d742';"
                  onblur="this.style.border='2px solid rgba(129, 215, 66, 0.4)';"
                >
                  <option value="all" selected style="background: #006341; color: white;">All Status</option>
                  <option value="Active" style="background: #006341; color: white;">Active</option>
                  <option value="Return To Agency" style="background: #006341; color: white;">Return To Agency</option>
                  <option value="Banned" style="background: #006341; color: white;">Banned</option>
                </select>
              </div>
              <div style="width: 12.5%;">
                <label style="display: block; color: #81d742; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">üìÑ Documents</label>
                <select
                  id="documentsFilter"
                  onchange="filterGuards()"
                  style="width: 100%; padding: 0.875rem 1rem; background: #006341; border: 2px solid rgba(129, 215, 66, 0.4); border-radius: 10px; color: white; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease;"
                  onfocus="this.style.border='2px solid #81d742';"
                  onblur="this.style.border='2px solid rgba(129, 215, 66, 0.4)';"
                >
                  <option value="all" style="background: #006341; color: white;">All Documents</option>
                  <option value="Good" style="background: #006341; color: white;">Good</option>
                  <option value="Nearly Expire" style="background: #006341; color: white;">Nearly Expire</option>
                  <option value="Expired" style="background: #006341; color: white;">Expired</option>
                </select>
              </div>
              <div style="width: 12.5%;">
                <label style="display: block; color: #81d742; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">üí™ BMI</label>
                <select
                  id="bmiFilter"
                  onchange="filterGuards()"
                  style="width: 100%; padding: 0.875rem 1rem; background: #006341; border: 2px solid rgba(129, 215, 66, 0.4); border-radius: 10px; color: white; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease;"
                  onfocus="this.style.border='2px solid #81d742';"
                  onblur="this.style.border='2px solid rgba(129, 215, 66, 0.4)';"
                >
                  <option value="all" style="background: #006341; color: white;">All BMI</option>
                  <option value="Underweight" style="background: #006341; color: white;">Underweight</option>
                  <option value="Normal" style="background: #006341; color: white;">Normal</option>
                  <option value="Overweight" style="background: #006341; color: white;">Overweight</option>
                  <option value="Obese" style="background: #006341; color: white;">Obese</option>
                </select>
              </div>
              <div style="width: 25%;"></div>
            </div>
          </div>

          <div id="guardsListContainer" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 12px; padding: 2rem;">
            <p style="color: white; opacity: 0.6; text-align: center; padding: 2rem;">Loading guards...</p>
          </div>

          <!-- Pagination -->
          <div id="guards-pagination"></div>
        </div>
      `;
    }

    function loadGuards() {
      console.log('loadGuards() called');
      const container = document.getElementById('guardsListContainer');
      if (!container) {
        console.error('Guards container not found');
        return;
      }

      container.innerHTML = '<p style="color: white; opacity: 0.6; text-align: center; padding: 2rem;">Loading guards...</p>';

      console.log('Calling getAllGuards()...');
      google.script.run
        .withSuccessHandler(function(guards) {
          console.log('getAllGuards() returned:', guards);
          displayGuards(guards);
        })
        .withFailureHandler(error => {
          console.error('getAllGuards() failed:', error);
          const container = document.getElementById('guardsListContainer');
          if (container) {
            container.innerHTML = `
              <p style="color: #FCA5A5; text-align: center; padding: 2rem;">Error loading guards: ${error.message}</p>
            `;
          }
        })
        .getAllGuards();
    }

    function displayGuards(guards) {
      console.log('Displaying guards:', guards);
      guardsList = guards;
      filteredGuardsList = guards;
      currentPage = 1;
      renderGuardsTable();
    }

    function renderGuardsTable() {
      const container = document.getElementById('guardsListContainer');

      if (!container) {
        console.error('Container not found!');
        return;
      }

      if (!filteredGuardsList || filteredGuardsList.length === 0) {
        container.innerHTML = `
          <p style="color: white; opacity: 0.6; text-align: center; padding: 2rem;">No guards found. Try adjusting your filters or click "Add Guard" to get started.</p>
        `;
        document.getElementById('guards-pagination').innerHTML = '';
        return;
      }

      const isAdmin = currentUser.role === 'Admin';

      // Calculate pagination
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedGuards = filteredGuardsList.slice(startIndex, endIndex);

      let html = '<div style="overflow-x: auto;">';
      html += '<table style="width: 100%; border-collapse: collapse;">';
      html += `
        <thead>
          <tr style="border-bottom: 2px solid rgba(251, 191, 36, 0.3);">
            <th style="padding: 1rem; text-align: left; color: #81d742;">Name</th>
            <th style="padding: 1rem; text-align: left; color: #81d742;">DOB</th>
            <th style="padding: 1rem; text-align: left; color: #81d742;">License Number</th>
            <th style="padding: 1rem; text-align: left; color: #81d742;">License Expiry</th>
            <th style="padding: 1rem; text-align: left; color: #81d742;">BMI</th>
            <th style="padding: 1rem; text-align: left; color: #81d742;">Documents</th>
            <th style="padding: 1rem; text-align: left; color: #81d742;">Status</th>
            <th style="padding: 1rem; text-align: center; color: #81d742;">Actions</th>
          </tr>
        </thead>
        <tbody>
      `;

      paginatedGuards.forEach(guard => {
        const fullName = [guard.firstName, guard.middleName, guard.lastName, guard.suffix].filter(Boolean).join(' ');
        const statusColor = guard.status === 'Active' ? '#22C55E' : guard.status === 'Banned' ? '#EF4444' : '#6bc92b';

        // Check document status
        const docStatus = getDocumentStatus(guard.documents);

        // Get BMI status and color
        let bmiDisplay = 'N/A';
        let bmiColor = 'rgba(255,255,255,0.6)';
        if (guard.health && guard.health.bmi) {
          const bmiValue = parseFloat(guard.health.bmi);

          // Display user-friendly BMI status with color
          if (bmiValue <= 16.0) {
            bmiDisplay = 'Severely Underweight';
            bmiColor = '#DC2626'; // Dark Red
          } else if (bmiValue > 16.0 && bmiValue <= 18.5) {
            bmiDisplay = 'Underweight';
            bmiColor = '#FBBF24'; // Yellow
          } else if (bmiValue > 18.5 && bmiValue <= 25) {
            bmiDisplay = 'Normal';
            bmiColor = '#22C55E'; // Green
          } else if (bmiValue > 25 && bmiValue <= 30) {
            bmiDisplay = 'Overweight';
            bmiColor = '#FB923C'; // Orange
          } else {
            bmiDisplay = 'Obese';
            bmiColor = '#EF4444'; // Red
          }
        }

        html += `
          <tr style="border-bottom: 1px solid rgba(251, 191, 36, 0.1);">
            <td style="padding: 1rem; color: white; font-weight: 600;">${fullName}</td>
            <td style="padding: 1rem; color: white; opacity: 0.8;">${guard.dateOfBirth || 'N/A'}</td>
            <td style="padding: 1rem; color: white; opacity: 0.8;">${guard.documents?.licenseNumber || 'N/A'}</td>
            <td style="padding: 1rem; color: white; opacity: 0.8;">${guard.documents?.licenseExpiry || 'N/A'}</td>
            <td style="padding: 1rem;">
              <span style="color: ${bmiColor}; font-weight: 600; font-size: 0.95rem;">
                ${bmiDisplay}
              </span>
            </td>
            <td style="padding: 1rem;">
              <span style="background: rgba(${docStatus.color === '#22C55E' ? '34, 197, 94' : docStatus.color === '#F59E0B' ? '245, 158, 11' : '239, 68, 68'}, 0.2); color: ${docStatus.color}; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600;">
                ${docStatus.label}
              </span>
            </td>
            <td style="padding: 1rem;">
              <span style="background: rgba(${statusColor === '#22C55E' ? '34, 197, 94' : statusColor === '#EF4444' ? '239, 68, 68' : '245, 158, 11'}, 0.2); color: ${statusColor}; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600;">
                ${guard.status}
              </span>
            </td>
            <td style="padding: 1rem;">
              <div style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
                <button
                  onclick="viewGuard('${guard.guardId}')"
                  title="View Details"
                  style="background: rgba(59, 130, 246, 0.2); border: 1px solid #3B82F6; color: #93C5FD; padding: 0.5rem; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; width: 36px; height: 36px;"
                  onmouseover="this.style.background='rgba(59, 130, 246, 0.3)'"
                  onmouseout="this.style.background='rgba(59, 130, 246, 0.2)'"
                >
                  üëÅÔ∏è
                </button>
                ${(currentUser.role === 'User' && guard.status !== 'Active') ? '' : `
                <button
                  onclick="editGuard('${guard.guardId}')"
                  title="Edit Guard"
                  style="background: rgba(251, 191, 36, 0.2); border: 1px solid #81d742; color: #81d742; padding: 0.5rem; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; width: 36px; height: 36px;"
                  onmouseover="this.style.background='rgba(251, 191, 36, 0.3)'"
                  onmouseout="this.style.background='rgba(251, 191, 36, 0.2)'"
                >
                  ‚úèÔ∏è
                </button>
                `}
                ${isAdmin ? `
                <button
                  onclick="deleteGuard('${guard.guardId}', '${fullName}')"
                  title="Delete Guard"
                  style="background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 0.5rem; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; width: 36px; height: 36px;"
                  onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'"
                  onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'"
                >
                  üóëÔ∏è
                </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table></div>';

      container.innerHTML = html;

      // Render pagination separately
      renderGuardsPagination();
    }

    function renderGuardsPagination() {
      const paginationContainer = document.getElementById('guards-pagination');
      if (!paginationContainer) return;

      const totalPages = Math.ceil(filteredGuardsList.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;

      if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
      }

      let paginationHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(251, 191, 36, 0.2);">
          <div style="color: white; opacity: 0.8; font-size: 0.9rem;">
            Showing ${startIndex + 1}-${Math.min(endIndex, filteredGuardsList.length)} of ${filteredGuardsList.length} guards
          </div>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button
              onclick="goToPage(${currentPage - 1})"
              ${currentPage === 1 ? 'disabled' : ''}
              style="background: ${currentPage === 1 ? 'rgba(255,255,255,0.1)' : 'rgba(129, 215, 66, 0.2)'}; border: 1px solid ${currentPage === 1 ? 'rgba(255,255,255,0.2)' : '#81d742'}; color: ${currentPage === 1 ? 'rgba(255,255,255,0.4)' : '#81d742'}; padding: 0.5rem 1rem; border-radius: 6px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'}; font-weight: 600; transition: all 0.2s ease;"
              ${currentPage === 1 ? '' : 'onmouseover="this.style.background=\'rgba(129, 215, 66, 0.3)\'" onmouseout="this.style.background=\'rgba(129, 215, 66, 0.2)\'"'}
            >
              ‚Üê Previous
            </button>

            <div style="display: flex; gap: 0.25rem;">
              ${generatePageNumbers(currentPage, totalPages)}
            </div>

            <button
              onclick="goToPage(${currentPage + 1})"
              ${currentPage === totalPages ? 'disabled' : ''}
              style="background: ${currentPage === totalPages ? 'rgba(255,255,255,0.1)' : 'rgba(129, 215, 66, 0.2)'}; border: 1px solid ${currentPage === totalPages ? 'rgba(255,255,255,0.2)' : '#81d742'}; color: ${currentPage === totalPages ? 'rgba(255,255,255,0.4)' : '#81d742'}; padding: 0.5rem 1rem; border-radius: 6px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'}; font-weight: 600; transition: all 0.2s ease;"
              ${currentPage === totalPages ? '' : 'onmouseover="this.style.background=\'rgba(129, 215, 66, 0.3)\'" onmouseout="this.style.background=\'rgba(129, 215, 66, 0.2)\'"'}
            >
              Next ‚Üí
            </button>
          </div>
        </div>
      `;

      paginationContainer.innerHTML = paginationHTML;
    }

    function generatePageNumbers(current, total) {
      let html = '';
      const maxVisible = 5;
      let startPage = Math.max(1, current - Math.floor(maxVisible / 2));
      let endPage = Math.min(total, startPage + maxVisible - 1);

      if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        const isActive = i === current;
        html += `
          <button
            onclick="goToPage(${i})"
            style="background: ${isActive ? '#81d742' : 'rgba(255,255,255,0.1)'}; border: 1px solid ${isActive ? '#81d742' : 'rgba(255,255,255,0.2)'}; color: ${isActive ? '#006341' : 'white'}; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; font-weight: ${isActive ? '700' : '500'}; min-width: 40px; transition: all 0.2s ease;"
            ${isActive ? '' : 'onmouseover="this.style.background=\'rgba(255,255,255,0.2)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.1)\'"'}
          >
            ${i}
          </button>
        `;
      }

      return html;
    }

    function goToPage(page) {
      const totalPages = Math.ceil(filteredGuardsList.length / itemsPerPage);
      if (page < 1 || page > totalPages) return;

      currentPage = page;
      renderGuardsTable();
    }

    function filterGuards() {
      const searchInput = document.getElementById('searchGuardInput');
      const statusFilter = document.getElementById('statusFilter');
      const documentsFilter = document.getElementById('documentsFilter');
      const bmiFilter = document.getElementById('bmiFilter');

      if (!searchInput || !statusFilter || !documentsFilter || !bmiFilter) {
        console.error('Filter controls not found');
        return;
      }

      const searchTerm = searchInput.value.toLowerCase().trim();
      const selectedStatus = statusFilter.value;
      const selectedDocuments = documentsFilter.value;
      const selectedBMI = bmiFilter.value;

      // Filter the guards list
      filteredGuardsList = guardsList.filter(guard => {
        // Check name match (search in firstName, middleName, lastName)
        const fullName = [
          guard.firstName || '',
          guard.middleName || '',
          guard.lastName || ''
        ].join(' ').toLowerCase();

        const nameMatch = searchTerm === '' || fullName.includes(searchTerm);

        // Check status match
        const statusMatch = selectedStatus === 'all' || guard.status === selectedStatus;

        // Check documents match
        const docStatus = getDocumentStatus(guard.documents);
        const documentsMatch = selectedDocuments === 'all' || docStatus.label === selectedDocuments;

        // Check BMI match
        let bmiMatch = true;
        if (selectedBMI !== 'all') {
          if (guard.health && guard.health.bmi) {
            const bmiValue = parseFloat(guard.health.bmi);
            let bmiCategory = '';

            // Determine BMI category (matching the display logic)
            if (bmiValue <= 16.0) {
              bmiCategory = 'Underweight'; // Severely Underweight grouped as Underweight
            } else if (bmiValue > 16.0 && bmiValue <= 18.5) {
              bmiCategory = 'Underweight';
            } else if (bmiValue > 18.5 && bmiValue <= 25) {
              bmiCategory = 'Normal';
            } else if (bmiValue > 25 && bmiValue <= 30) {
              bmiCategory = 'Overweight';
            } else {
              bmiCategory = 'Obese';
            }

            bmiMatch = bmiCategory === selectedBMI;
          } else {
            // If no BMI data and a specific filter is selected, exclude this guard
            bmiMatch = false;
          }
        }

        return nameMatch && statusMatch && documentsMatch && bmiMatch;
      });

      // Reset to first page when filtering
      currentPage = 1;

      // Re-render table with filtered results
      renderGuardsTable();

      // Show result count
      console.log(`Showing ${filteredGuardsList.length} of ${guardsList.length} guards`);
    }

    // Guards Extraction Functions
    function extractGuardsToExcel() {
      if (filteredGuardsList.length === 0) {
        showToast('warning', 'No Guards', 'No guards to extract based on current filters');
        return;
      }

      // Update guard count in modal
      document.getElementById('exportGuardsCount').textContent = filteredGuardsList.length;

      // Show export format modal
      document.getElementById('exportGuardsFormatModal').style.display = 'flex';
    }

    function closeExportGuardsFormatModal() {
      document.getElementById('exportGuardsFormatModal').style.display = 'none';
    }

    // Helper function to get BMI status from BMI value
    function getBMIStatus(bmi) {
      if (!bmi || bmi === 'N/A') return 'N/A';
      const bmiValue = parseFloat(bmi);
      if (isNaN(bmiValue)) return 'N/A';

      // Asian BMI standards
      if (bmiValue < 18.5) return 'Underweight';
      if (bmiValue >= 18.5 && bmiValue < 23) return 'Normal';
      if (bmiValue >= 23 && bmiValue < 25) return 'Overweight';
      return 'Obese';
    }

    // Export Guards to Excel (CSV)
    function exportGuardsToExcel() {
      // Prepare data for CSV (Excel format)
      const headers = ['Full Name', 'Date of Birth', 'Hired Date', 'End of Contract', 'Status', 'License Number', 'License Expiry', 'Police Clearance', 'NBI Clearance', 'Drug Test', 'Neuro Exam', 'BMI', 'BMI Status'];
      const csvRows = [headers.join(',')];

      filteredGuardsList.forEach(guard => {
        const fullName = [guard.firstName, guard.middleName, guard.lastName, guard.suffix].filter(Boolean).join(' ');
        const bmi = guard.health?.bmi || 'N/A';
        const bmiStatus = guard.health?.status || getBMIStatus(bmi);

        const row = [
          `"${fullName}"`,
          guard.dateOfBirth || 'N/A',
          guard.hiredDate || 'N/A',
          guard.endOfContractDate || 'N/A',
          guard.status || 'N/A',
          guard.documents?.licenseNumber || 'N/A',
          guard.documents?.licenseExpiry || 'N/A',
          guard.documents?.policeClearance || 'N/A',
          guard.documents?.nbiClearance || 'N/A',
          guard.documents?.drugTestValidity || 'N/A',
          guard.documents?.neuroExamValidity || 'N/A',
          bmi,
          bmiStatus
        ];
        csvRows.push(row.join(','));
      });

      // Create CSV content
      const csvContent = csvRows.join('\n');

      // Create blob and download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);

      // Generate filename
      const filename = `Guards_Export_${new Date().toISOString().split('T')[0]}.csv`;

      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      closeExportGuardsFormatModal();
      showToast('success', 'Export Successful', `Extracted ${filteredGuardsList.length} guards to ${filename}`);
    }

    // Export Guards to PDF
    function exportGuardsToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4'); // Landscape orientation

      // Title
      doc.setFontSize(16);
      doc.setTextColor(0, 99, 65); // DLSU Green
      doc.text('Guard Monitoring System - Guards Export', 15, 15);

      // Subtitle with filters
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      const statusFilter = document.getElementById('statusFilter')?.value || 'all';
      const documentsFilter = document.getElementById('documentsFilter')?.value || 'all';
      const bmiFilter = document.getElementById('bmiFilter')?.value || 'all';

      let subtitle = `Total Guards: ${filteredGuardsList.length}`;
      if (statusFilter !== 'all') subtitle += ` | Status: ${statusFilter}`;
      if (documentsFilter !== 'all') subtitle += ` | Documents: ${documentsFilter}`;
      if (bmiFilter !== 'all') subtitle += ` | BMI: ${bmiFilter}`;
      doc.text(subtitle, 15, 22);

      // Prepare table data - Compact version with essential columns
      const tableData = filteredGuardsList.map(guard => {
        const fullName = [guard.firstName, guard.middleName, guard.lastName, guard.suffix].filter(Boolean).join(' ');
        const bmi = guard.health?.bmi || 'N/A';
        const bmiStatus = guard.health?.status || getBMIStatus(bmi);

        return [
          fullName,
          guard.hiredDate || 'N/A',
          guard.status || 'N/A',
          guard.documents?.licenseExpiry || 'N/A',
          bmiStatus
        ];
      });

      // Generate table
      doc.autoTable({
        head: [['Full Name', 'Hired Date', 'Status', 'License Expiry', 'BMI Status']],
        body: tableData,
        startY: 28,
        styles: {
          fontSize: 9,
          cellPadding: 2
        },
        headStyles: {
          fillColor: [0, 99, 65], // DLSU Green
          textColor: [255, 255, 255],
          fontStyle: 'bold'
        },
        alternateRowStyles: {
          fillColor: [245, 245, 245]
        },
        margin: { top: 28, left: 15, right: 15 }
      });

      // Footer with user and date/time
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);

        // Current date and time in "Jan, 01, 2025 hh:mm" format
        const today = new Date();
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthStr = months[today.getMonth()];
        const dayStr = String(today.getDate()).padStart(2, '0');
        const yearStr = today.getFullYear();
        const hoursStr = String(today.getHours()).padStart(2, '0');
        const minutesStr = String(today.getMinutes()).padStart(2, '0');
        const dateTimeStr = `${monthStr}, ${dayStr}, ${yearStr} ${hoursStr}:${minutesStr}`;

        // Footer text: "Extracted by [user name] | Jan, 01, 2025 hh:mm"
        const footerText = `Extracted by ${currentUser.fullName} | ${dateTimeStr}`;
        const footerX = doc.internal.pageSize.getWidth() / 2;
        const footerY = doc.internal.pageSize.getHeight() - 10;

        doc.text(footerText, footerX, footerY, { align: 'center' });

        // Page number
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.getWidth() - 20, footerY, { align: 'right' });
      }

      // Generate filename and save
      const filename = `Guards_Export_${new Date().toISOString().split('T')[0]}.pdf`;
      doc.save(filename);

      closeExportGuardsFormatModal();
      showToast('success', 'Export Successful', `Extracted ${filteredGuardsList.length} guards to ${filename}`);
    }

    // Global variable to store current guard ID for the view modal
    let currentViewGuardId = null;
    let currentViewGuardRecordsPage = 1;
    const viewGuardRecordsPerPage = 5;

    function viewGuard(guardId) {
      const guard = guardsList.find(g => g.guardId === guardId);
      if (!guard) {
        alert('Guard not found');
        return;
      }

      // Debug: Log full guard object
      console.log('Viewing guard:', guard);
      console.log('Photo URL from guard object:', guard.photoUrl);
      console.log('Photo URL type:', typeof guard.photoUrl);

      // Store guard ID for loading records later
      currentViewGuardId = guardId;
      currentViewGuardRecordsPage = 1;

      const fullName = [guard.firstName, guard.middleName, guard.lastName, guard.suffix].filter(Boolean).join(' ');
      const statusColor = guard.status === 'Active' ? '#22C55E' : guard.status === 'Banned' ? '#EF4444' : '#6bc92b';

      // Populate Personal Information
      const personalInfoHTML = `
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">Full Name</div>
          <div style="color: white; font-size: 1rem;">${fullName}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">Guard ID</div>
          <div style="color: white; font-size: 1rem;">${guard.guardId}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">Date of Birth</div>
          <div style="color: white; font-size: 1rem;">${guard.dateOfBirth || 'N/A'}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">Hired Date</div>
          <div style="color: white; font-size: 1rem;">${guard.hiredDate || 'N/A'}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">End of Contract</div>
          <div style="color: white; font-size: 1rem;">${guard.endOfContractDate || 'N/A'}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">Status</div>
          <div>
            <span style="background: rgba(${statusColor === '#22C55E' ? '34, 197, 94' : statusColor === '#EF4444' ? '239, 68, 68' : '245, 158, 11'}, 0.2); color: ${statusColor}; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600;">
              ${guard.status}
            </span>
          </div>
        </div>
      `;

      // Helper function to check if date is within 30 days
      const isNearExpiry = (dateStr) => {
        if (!dateStr || dateStr === 'N/A') return false;
        const date = new Date(dateStr);
        const today = new Date();
        const diffTime = date - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays >= 0 && diffDays <= 30;
      };

      // Helper function to check if date is expired
      const isExpired = (dateStr) => {
        if (!dateStr || dateStr === 'N/A') return false;
        const date = new Date(dateStr);
        const today = new Date();
        return date < today;
      };

      // Helper function to get date style
      const getDateStyle = (dateStr) => {
        if (isExpired(dateStr)) {
          return 'color: #EF4444; font-weight: 700; background: rgba(239, 68, 68, 0.1); padding: 0.25rem 0.5rem; border-radius: 4px; border-left: 3px solid #EF4444;';
        } else if (isNearExpiry(dateStr)) {
          return 'color: #F59E0B; font-weight: 700; background: rgba(245, 158, 11, 0.1); padding: 0.25rem 0.5rem; border-radius: 4px; border-left: 3px solid #F59E0B;';
        }
        return 'color: white;';
      };

      // Populate Documents Information
      const documentsHTML = `
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">License Number</div>
          <div style="color: white; font-size: 1rem;">${guard.documents?.licenseNumber || 'N/A'}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">License Expiry</div>
          <div style="${getDateStyle(guard.documents?.licenseExpiry)} font-size: 1rem;">${guard.documents?.licenseExpiry || 'N/A'}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">National Police Clearance</div>
          <div style="${getDateStyle(guard.documents?.policeClearance)} font-size: 1rem;">${guard.documents?.policeClearance || 'N/A'}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">NBI Clearance</div>
          <div style="${getDateStyle(guard.documents?.nbiClearance)} font-size: 1rem;">${guard.documents?.nbiClearance || 'N/A'}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">Drug Test Validity</div>
          <div style="${getDateStyle(guard.documents?.drugTestValidity)} font-size: 1rem;">${guard.documents?.drugTestValidity || 'N/A'}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">Neuro Exam Validity</div>
          <div style="${getDateStyle(guard.documents?.neuroExamValidity)} font-size: 1rem;">${guard.documents?.neuroExamValidity || 'N/A'}</div>
        </div>
      `;

      // Populate Health Records
      const healthHTML = guard.health ? `
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">Height</div>
          <div style="color: white; font-size: 1rem;">${guard.health.height ? guard.health.height + ' cm' : 'N/A'}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">Weight</div>
          <div style="color: white; font-size: 1rem;">${guard.health.weight ? guard.health.weight + ' kg' : 'N/A'}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">BMI</div>
          <div style="color: white; font-size: 1rem;">${guard.health.bmi || 'N/A'}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">BMI Status</div>
          <div style="color: white; font-size: 1rem;">${guard.health.status || 'N/A'}</div>
        </div>
        <div style="padding: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 6px; grid-column: 1 / -1;">
          <div style="color: #81d742; font-size: 0.875rem; font-weight: 600; margin-bottom: 0.25rem;">Notes</div>
          <div style="color: white; font-size: 1rem;">${guard.health.notes || 'N/A'}</div>
        </div>
      ` : `
        <div style="grid-column: 1 / -1; padding: 2rem; text-align: center;">
          <p style="color: white; opacity: 0.6;">No health records available</p>
        </div>
      `;

      // Update photo
      const photoDiv = document.getElementById('viewGuardPhoto');
      console.log('Guard photo URL:', guard.photoUrl);

      if (guard.photoUrl && guard.photoUrl !== '') {
        // Sanitize the URL to prevent XSS
        const sanitizedUrl = String(guard.photoUrl).replace(/['"]/g, '');
        console.log('Sanitized photo URL:', sanitizedUrl);

        photoDiv.innerHTML = `<img src="${sanitizedUrl}" style="width: 100%; height: 100%; object-fit: cover;" onerror="console.error('Image load failed'); this.parentElement.innerHTML='<span style=\\'color: rgba(255,255,255,0.4); font-size: 0.9rem; text-align: center;\\'>Photo unavailable</span>'" onload="console.log('Image loaded successfully')">`;
      } else {
        photoDiv.innerHTML = '<span style="color: rgba(255,255,255,0.4); font-size: 0.9rem; text-align: center;">No photo</span>';
      }

      // Update modal content
      document.getElementById('viewGuardPersonalInfo').innerHTML = personalInfoHTML;
      document.getElementById('viewGuardDocuments').innerHTML = documentsHTML;
      document.getElementById('viewGuardHealth').innerHTML = healthHTML;

      // Show modal
      document.getElementById('viewGuardModal').style.display = 'flex';

      // Reset to documents tab
      switchViewTab('documents');
    }

    function closeViewGuardModal() {
      document.getElementById('viewGuardModal').style.display = 'none';
    }

    function switchViewTab(tab) {
      const documentsTab = document.getElementById('tabDocuments');
      const healthTab = document.getElementById('tabHealth');
      const performanceTab = document.getElementById('tabPerformance');
      const documentsContent = document.getElementById('viewTabDocuments');
      const healthContent = document.getElementById('viewTabHealth');
      const performanceContent = document.getElementById('viewTabPerformance');

      // Reset all tabs
      documentsTab.style.background = 'transparent';
      documentsTab.style.color = 'white';
      documentsTab.style.opacity = '0.7';
      documentsTab.style.borderBottom = '3px solid transparent';

      healthTab.style.background = 'transparent';
      healthTab.style.color = 'white';
      healthTab.style.opacity = '0.7';
      healthTab.style.borderBottom = '3px solid transparent';

      performanceTab.style.background = 'transparent';
      performanceTab.style.color = 'white';
      performanceTab.style.opacity = '0.7';
      performanceTab.style.borderBottom = '3px solid transparent';

      // Hide all content
      documentsContent.style.display = 'none';
      healthContent.style.display = 'none';
      performanceContent.style.display = 'none';

      // Activate selected tab
      if (tab === 'documents') {
        documentsTab.style.background = 'rgba(251, 191, 36, 0.2)';
        documentsTab.style.color = '#81d742';
        documentsTab.style.opacity = '1';
        documentsTab.style.borderBottom = '3px solid #81d742';
        documentsContent.style.display = 'block';
      } else if (tab === 'health') {
        healthTab.style.background = 'rgba(251, 191, 36, 0.2)';
        healthTab.style.color = '#81d742';
        healthTab.style.opacity = '1';
        healthTab.style.borderBottom = '3px solid #81d742';
        healthContent.style.display = 'block';
      } else if (tab === 'performance') {
        performanceTab.style.background = 'rgba(251, 191, 36, 0.2)';
        performanceTab.style.color = '#81d742';
        performanceTab.style.opacity = '1';
        performanceTab.style.borderBottom = '3px solid #81d742';
        performanceContent.style.display = 'block';
        // Load guard records when switching to performance tab
        loadGuardRecords(currentViewGuardId);
      }
    }

    function loadGuardRecords(guardId) {
      const container = document.getElementById('viewGuardPerformance');

      if (!guardId) {
        container.innerHTML = '<p style="color: white; opacity: 0.6; text-align: center; padding: 2rem;">No guard selected</p>';
        return;
      }

      // Show loading state
      container.innerHTML = '<p style="color: white; opacity: 0.6; text-align: center; padding: 2rem;"><span class="spinner" style="margin: 0 auto 1rem; display: block;"></span>Loading records...</p>';

      // Fetch all records and filter by guardId
      google.script.run
        .withSuccessHandler(function(allRecords) {
          // Filter records for this guard
          const guardRecords = allRecords.filter(record => record.guardId === guardId);
          renderGuardRecords(guardRecords);
        })
        .withFailureHandler(function(error) {
          // Safely display error without XSS risk
          container.innerHTML = '';
          const errorP = document.createElement('p');
          errorP.style.cssText = 'color: #EF4444; text-align: center; padding: 2rem;';
          errorP.textContent = 'Error loading records: ' + (error.message || 'Unknown error');
          container.appendChild(errorP);
        })
        .getAllPerformanceRecords();
    }

    function renderGuardRecords(records) {
      const container = document.getElementById('viewGuardPerformance');

      if (records.length === 0) {
        container.innerHTML = '<p style="color: white; opacity: 0.6; text-align: center; padding: 2rem;">No records found for this guard</p>';
        return;
      }

      // Pagination
      const startIndex = (currentViewGuardRecordsPage - 1) * viewGuardRecordsPerPage;
      const endIndex = startIndex + viewGuardRecordsPerPage;
      const paginatedRecords = records.slice(startIndex, endIndex);
      const totalPages = Math.ceil(records.length / viewGuardRecordsPerPage);

      let html = `
        <div style="overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; color: white;">
            <thead>
              <tr style="border-bottom: 2px solid rgba(129, 215, 66, 0.3);">
                <th style="padding: 0.75rem; text-align: left; color: #81d742; font-weight: 700;">Type</th>
                <th style="padding: 0.75rem; text-align: left; color: #81d742; font-weight: 700;">Date</th>
                <th style="padding: 0.75rem; text-align: left; color: #81d742; font-weight: 700;">Sanction</th>
              </tr>
            </thead>
            <tbody>
      `;

      paginatedRecords.forEach(record => {
        const typeColor = record.type === 'Violation' ? '#EF4444' : '#22C55E';
        const typeBg = record.type === 'Violation' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(34, 197, 94, 0.2)';
        const sanction = record.violationSanction && record.violationSanction !== 'N/A' ? record.violationSanction : '-';

        html += `
          <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
            <td style="padding: 0.75rem;">
              <span style="background: ${typeBg}; color: ${typeColor}; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">
                ${record.type}
              </span>
            </td>
            <td style="padding: 0.75rem;">${record.date}</td>
            <td style="padding: 0.75rem;">${sanction}</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      // Add pagination controls if needed
      if (totalPages > 1) {
        html += `
          <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
        `;

        // Previous button
        if (currentViewGuardRecordsPage > 1) {
          html += `
            <button onclick="goToGuardRecordsPage(${currentViewGuardRecordsPage - 1})" style="background: rgba(129, 215, 66, 0.2); border: 1px solid #81d742; color: #81d742; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">
              ¬´ Previous
            </button>
          `;
        }

        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
          if (i === currentViewGuardRecordsPage) {
            html += `
              <button style="background: #81d742; color: #006341; padding: 0.5rem 1rem; border: none; border-radius: 6px; font-weight: 700; cursor: default;">
                ${i}
              </button>
            `;
          } else {
            html += `
              <button onclick="goToGuardRecordsPage(${i})" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(129, 215, 66, 0.3); color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">
                ${i}
              </button>
            `;
          }
        }

        // Next button
        if (currentViewGuardRecordsPage < totalPages) {
          html += `
            <button onclick="goToGuardRecordsPage(${currentViewGuardRecordsPage + 1})" style="background: rgba(129, 215, 66, 0.2); border: 1px solid #81d742; color: #81d742; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600;">
              Next ¬ª
            </button>
          `;
        }

        html += `</div>`;
      }

      container.innerHTML = html;
    }

    function goToGuardRecordsPage(page) {
      currentViewGuardRecordsPage = page;
      loadGuardRecords(currentViewGuardId);
    }

    function editGuard(guardId) {
      try {
        console.log('Edit Guard clicked, ID:', guardId);
        console.log('Available guards:', guardsList);

        // Find the guard data
        const guard = guardsList.find(g => g.guardId === guardId);
        if (!guard) {
          alert('Guard not found');
          return;
        }

        console.log('Guard found:', guard);

        // Populate the update form
        document.getElementById('updateGuardId').value = guard.guardId;
        document.getElementById('updateGuardFirstName').value = guard.firstName || '';
        document.getElementById('updateGuardMiddleName').value = guard.middleName || '';
        document.getElementById('updateGuardLastName').value = guard.lastName || '';
        document.getElementById('updateGuardSuffix').value = guard.suffix || '';

      // Convert date strings to YYYY-MM-DD format for date inputs
      const formatDateForInput = (dateStr) => {
        if (!dateStr) return '';
        try {
          const date = new Date(dateStr);
          return date.toISOString().split('T')[0];
        } catch (e) {
          return '';
        }
      };

      document.getElementById('updateGuardDOB').value = formatDateForInput(guard.dateOfBirth);
      document.getElementById('updateGuardHiredDate').value = formatDateForInput(guard.hiredDate);
      document.getElementById('updateGuardEndContract').value = formatDateForInput(guard.endOfContractDate);
      document.getElementById('updateGuardStatus').value = guard.status || 'Active';

      // Populate documents
      if (guard.documents) {
        document.getElementById('updateLicenseNumber').value = guard.documents.licenseNumber || '';
        document.getElementById('updateLicenseExpiry').value = formatDateForInput(guard.documents.licenseExpiry);
        document.getElementById('updatePoliceClearance').value = formatDateForInput(guard.documents.policeClearance);
        document.getElementById('updateNbiClearance').value = formatDateForInput(guard.documents.nbiClearance);
        document.getElementById('updateDrugTestValidity').value = formatDateForInput(guard.documents.drugTestValidity);
        document.getElementById('updateNeuroExamValidity').value = formatDateForInput(guard.documents.neuroExamValidity);
      }

      // Populate health data
      if (guard.health) {
        document.getElementById('updateGuardHeight').value = guard.health.height || '';
        document.getElementById('updateGuardWeight').value = guard.health.weight || '';
        document.getElementById('updateGuardHealthNotes').value = guard.health.notes || '';
        // Trigger BMI calculation if both height and weight exist
        if (guard.health.height && guard.health.weight) {
          calculateUpdateBMI();
        }
      } else {
        // Clear health fields if no health data
        document.getElementById('updateGuardHeight').value = '';
        document.getElementById('updateGuardWeight').value = '';
        document.getElementById('updateGuardBMI').value = '';
        document.getElementById('updateGuardHealthNotes').value = '';
        document.getElementById('updateBmiStatus').textContent = '-';
        document.getElementById('updateBmiStatus').style.color = 'rgba(255,255,255,0.7)';
      }

      // Populate photo preview
      const photoPreview = document.getElementById('updateGuardPhotoPreview');
      if (guard.photoUrl) {
        photoPreview.innerHTML = `<img src="${guard.photoUrl}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<span style=\\'color: rgba(255,255,255,0.4); font-size: 0.85rem; text-align: center;\\'>Current</span>'">`;
      } else {
        photoPreview.innerHTML = '<span style="color: rgba(255,255,255,0.4); font-size: 0.85rem; text-align: center;">No photo</span>';
      }

      // Clear file input
      document.getElementById('updateGuardPhoto').value = '';

        // Show the modal
        console.log('Showing update modal...');
        const modal = document.getElementById('updateGuardModal');
        if (modal) {
          modal.style.display = 'flex';
          console.log('Modal display set to flex');
        } else {
          console.error('Update modal element not found!');
        }

        document.getElementById('updateGuardErrorMessage').style.display = 'none';
        document.getElementById('updateGuardSuccessMessage').style.display = 'none';
      } catch (error) {
        console.error('Error in editGuard:', error);
        alert('Error opening update modal: ' + error.message);
      }
    }

    let pendingDeleteGuard = null;

    function deleteGuard(guardId, guardName) {
      if (currentUser.role !== 'Admin') {
        showToast('error', 'Permission Denied', 'Only administrators can delete guards.');
        return;
      }

      // Store the guard info for deletion
      pendingDeleteGuard = { guardId, guardName };

      // Update modal content
      document.getElementById('deleteGuardName').textContent = guardName;
      document.getElementById('deleteGuardId').textContent = `ID: ${guardId}`;

      // Show modal
      document.getElementById('deleteConfirmModal').style.display = 'flex';
    }

    function closeDeleteModal() {
      document.getElementById('deleteConfirmModal').style.display = 'none';
      pendingDeleteGuard = null;
    }

    function confirmDelete() {
      if (!pendingDeleteGuard) return;

      const { guardId, guardName } = pendingDeleteGuard;

      // Disable button and show loading
      const deleteBtn = document.getElementById('confirmDeleteBtn');
      deleteBtn.innerHTML = '<span class="spinner"></span>Deleting...';
      deleteBtn.disabled = true;

      // Call server function
      google.script.run
        .withSuccessHandler(function(result) {
          deleteBtn.innerHTML = 'Delete Guard';
          deleteBtn.disabled = false;

          if (result.success) {
            closeDeleteModal();
            showToast('success', 'Guard Deleted', `${guardName} has been removed from the system.`);

            // Refresh guards list
            if (currentView === 'guards') {
              loadGuards();
            }
          } else {
            showToast('error', 'Delete Failed', result.message);
          }
        })
        .withFailureHandler(function(error) {
          deleteBtn.innerHTML = 'Delete Guard';
          deleteBtn.disabled = false;
          showToast('error', 'Error', 'Failed to delete guard: ' + error.message);
        })
        .deleteGuard(guardId, currentUser.username);
    }

    // ========== Settings Modal Functions ==========

    // Add Violation Type Modal
    function openAddViolationModal() {
      document.getElementById('addViolationModal').style.display = 'flex';
      document.getElementById('violationName').focus();
    }

    function closeAddViolationModal() {
      document.getElementById('addViolationModal').style.display = 'none';
      document.getElementById('addViolationForm').reset();
      // Remove invalid class if present
      document.querySelectorAll('#addViolationForm .invalid').forEach(el => el.classList.remove('invalid'));
    }

    // Add Sanction Modal
    function openAddSanctionModal() {
      document.getElementById('addSanctionModal').style.display = 'flex';
      document.getElementById('sanctionName').focus();
    }

    function closeAddSanctionModal() {
      document.getElementById('addSanctionModal').style.display = 'none';
      document.getElementById('addSanctionForm').reset();
      document.querySelectorAll('#addSanctionForm .invalid').forEach(el => el.classList.remove('invalid'));
    }

    // Edit Violation Type Modal
    function openEditViolationModal(id, name, description) {
      document.getElementById('editViolationId').value = id;
      document.getElementById('editViolationName').value = name;
      document.getElementById('editViolationDescription').value = description || '';
      document.getElementById('editViolationModal').style.display = 'flex';
      document.getElementById('editViolationName').focus();
    }

    function closeEditViolationModal() {
      document.getElementById('editViolationModal').style.display = 'none';
      document.getElementById('editViolationForm').reset();
      document.querySelectorAll('#editViolationForm .invalid').forEach(el => el.classList.remove('invalid'));
    }

    // Edit Sanction Modal
    function openEditSanctionModal(id, name, description) {
      document.getElementById('editSanctionId').value = id;
      document.getElementById('editSanctionName').value = name;
      document.getElementById('editSanctionDescription').value = description || '';
      document.getElementById('editSanctionModal').style.display = 'flex';
      document.getElementById('editSanctionName').focus();
    }

    function closeEditSanctionModal() {
      document.getElementById('editSanctionModal').style.display = 'none';
      document.getElementById('editSanctionForm').reset();
      document.querySelectorAll('#editSanctionForm .invalid').forEach(el => el.classList.remove('invalid'));
    }

    // Load Settings Data
    function loadSettings() {
      google.script.run
        .withSuccessHandler(function(violations) {
          renderViolationsList(violations);
        })
        .withFailureHandler(function(error) {
          console.error('Error loading violations:', error);
        })
        .getViolationTypes();

      google.script.run
        .withSuccessHandler(function(sanctions) {
          renderSanctionsList(sanctions);
        })
        .withFailureHandler(function(error) {
          console.error('Error loading sanctions:', error);
        })
        .getViolationSanctions();
    }

    // Helper function to safely escape strings for HTML attributes
    function escapeHtml(str) {
      if (!str) return '';
      return String(str).replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // Render Violations List
    function renderViolationsList(violations) {
      const container = document.getElementById('violationTypesList');
      if (!container) return;

      if (!violations || violations.length === 0) {
        container.innerHTML = '<div style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">No violations found</div>';
        return;
      }

      container.innerHTML = violations.map(violation => {
        const id = String(violation.id || '');
        const name = String(violation.name || 'Unnamed Violation');
        const description = String(violation.description || '');

        return `
        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; border-left: 4px solid rgba(239, 68, 68, 0.6);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
            <div style="flex: 1;">
              <div style="color: white; font-weight: 500; margin-bottom: 0.25rem;">${name}</div>
              ${description ? `<div style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">${description}</div>` : ''}
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button
                onclick="openEditViolationModal('${escapeHtml(id)}', '${escapeHtml(name)}', '${escapeHtml(description)}')"
                style="background: rgba(59, 130, 246, 0.2); border: 1px solid #3B82F6; color: #93C5FD; padding: 0.375rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s ease;"
                onmouseover="this.style.background='rgba(59, 130, 246, 0.3)'"
                onmouseout="this.style.background='rgba(59, 130, 246, 0.2)'"
              >
                ‚úèÔ∏è Edit
              </button>
              <button
                onclick="deleteViolationType('${escapeHtml(id)}', '${escapeHtml(name)}')"
                style="background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 0.375rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s ease;"
                onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'"
                onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'"
              >
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
        </div>
        `;
      }).join('');
    }

    // Render Sanctions List
    function renderSanctionsList(sanctions) {
      const container = document.getElementById('sanctionsList');
      if (!container) return;

      if (!sanctions || sanctions.length === 0) {
        container.innerHTML = '<div style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">No sanctions found</div>';
        return;
      }

      container.innerHTML = sanctions.map(sanction => {
        const id = String(sanction.id || '');
        const name = String(sanction.name || 'Unnamed Sanction');
        const description = String(sanction.description || '');

        return `
        <div style="background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px; border-left: 4px solid rgba(251, 191, 36, 0.6);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
            <div style="flex: 1;">
              <div style="color: white; font-weight: 500; margin-bottom: 0.25rem;">${name}</div>
              ${description ? `<div style="color: rgba(255,255,255,0.6); font-size: 0.85rem;">${description}</div>` : ''}
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button
                onclick="openEditSanctionModal('${escapeHtml(id)}', '${escapeHtml(name)}', '${escapeHtml(description)}')"
                style="background: rgba(59, 130, 246, 0.2); border: 1px solid #3B82F6; color: #93C5FD; padding: 0.375rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s ease;"
                onmouseover="this.style.background='rgba(59, 130, 246, 0.3)'"
                onmouseout="this.style.background='rgba(59, 130, 246, 0.2)'"
              >
                ‚úèÔ∏è Edit
              </button>
              <button
                onclick="deleteSanction('${escapeHtml(id)}', '${escapeHtml(name)}')"
                style="background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 0.375rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s ease;"
                onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'"
                onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'"
              >
                üóëÔ∏è Delete
              </button>
            </div>
          </div>
        </div>
        `;
      }).join('');
    }

    // Delete Functions
    let pendingDeleteViolation = null;

    function deleteViolationType(id, name) {
      // Store the violation info for deletion
      pendingDeleteViolation = { id, name };

      // Update modal content
      document.getElementById('deleteViolationName').textContent = name;
      document.getElementById('deleteViolationId').textContent = `ID: ${id}`;

      // Show modal
      document.getElementById('deleteViolationModal').style.display = 'flex';
    }

    function closeDeleteViolationModal() {
      document.getElementById('deleteViolationModal').style.display = 'none';
      pendingDeleteViolation = null;
    }

    function confirmDeleteViolation() {
      if (!pendingDeleteViolation) return;

      const { id, name } = pendingDeleteViolation;

      // Disable button and show loading
      const deleteBtn = document.getElementById('confirmDeleteViolationBtn');
      deleteBtn.innerHTML = '<span class="spinner"></span>Deleting...';
      deleteBtn.disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          deleteBtn.innerHTML = 'Delete Violation';
          deleteBtn.disabled = false;

          if (result.success) {
            closeDeleteViolationModal();
            showToast('success', 'Violation Deleted', `${name} has been removed.`);
            loadSettings();
          } else {
            showToast('error', 'Error', result.message || 'Failed to delete violation type.');
          }
        })
        .withFailureHandler(function(error) {
          deleteBtn.innerHTML = 'Delete Violation';
          deleteBtn.disabled = false;
          showToast('error', 'Error', 'An error occurred while deleting violation type.');
          console.error('Delete violation error:', error);
        })
        .deleteViolationType(id);
    }

    let pendingDeleteSanction = null;

    function deleteSanction(id, name) {
      // Store the sanction info for deletion
      pendingDeleteSanction = { id, name };

      // Update modal content
      document.getElementById('deleteSanctionName').textContent = name;
      document.getElementById('deleteSanctionId').textContent = `ID: ${id}`;

      // Show modal
      document.getElementById('deleteSanctionModal').style.display = 'flex';
    }

    function closeDeleteSanctionModal() {
      document.getElementById('deleteSanctionModal').style.display = 'none';
      pendingDeleteSanction = null;
    }

    function confirmDeleteSanction() {
      if (!pendingDeleteSanction) return;

      const { id, name } = pendingDeleteSanction;

      // Disable button and show loading
      const deleteBtn = document.getElementById('confirmDeleteSanctionBtn');
      deleteBtn.innerHTML = '<span class="spinner"></span>Deleting...';
      deleteBtn.disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          deleteBtn.innerHTML = 'Delete Sanction';
          deleteBtn.disabled = false;

          if (result.success) {
            closeDeleteSanctionModal();
            showToast('success', 'Sanction Deleted', `${name} has been removed.`);
            loadSettings();
          } else {
            showToast('error', 'Error', result.message || 'Failed to delete sanction.');
          }
        })
        .withFailureHandler(function(error) {
          deleteBtn.innerHTML = 'Delete Sanction';
          deleteBtn.disabled = false;
          showToast('error', 'Error', 'An error occurred while deleting sanction.');
          console.error('Delete sanction error:', error);
        })
        .deleteViolationSanction(id);
    }

    function debugSheetStatus() {
      showToast('Checking sheet status...', 'info');
      google.script.run
        .withSuccessHandler(function(status) {
          console.log('Sheet Status:', status);
          let message = 'üìä SHEET STATUS DEBUG\n\n';

          if (status.error) {
            message += 'Error: ' + status.error + '\n\n';
            if (status.stack) {
              message += 'Stack: ' + status.stack;
            }
          } else {
            message += 'üìÑ SPREADSHEET INFO:\n';
            message += `  - Name: ${status.spreadsheetName}\n`;
            message += `  - ID (Actual): ${status.spreadsheetId}\n`;
            message += `  - ID (Config): ${status.configuredId}\n`;
            message += `  - Match: ${status.spreadsheetId === status.configuredId ? '‚úì YES' : '‚úó NO - MISMATCH!'}\n`;
            message += `  - URL: ${status.spreadsheetUrl}\n\n`;

            message += 'üìã ALL SHEETS:\n';
            message += `  ${status.allSheets.join(', ')}\n\n`;

            message += '‚úì Guards Sheet:\n';
            message += `  - Exists: ${status.guards.exists}\n`;
            message += `  - Total Rows: ${status.guards.rows}\n`;
            message += `  - Data Rows: ${status.guards.dataRows}\n\n`;

            message += '‚úì Documents Sheet:\n';
            message += `  - Exists: ${status.documents.exists}\n`;
            message += `  - Total Rows: ${status.documents.rows}\n`;
            message += `  - Data Rows: ${status.documents.dataRows}\n\n`;

            message += '‚úì Performance Sheet:\n';
            message += `  - Exists: ${status.performance.exists}\n`;
            message += `  - Total Rows: ${status.performance.rows}\n`;
            message += `  - Data Rows: ${status.performance.dataRows}`;
          }

          alert(message);

          // If no guards, suggest adding sample data
          if (!status.error && status.guards.dataRows === 0) {
            if (confirm('No guards found in the database. Would you like to generate 200 sample guards?')) {
              google.script.run
                .withSuccessHandler(function(result) {
                  if (result.success) {
                    showToast(result.message, 'success');
                    loadGuards(); // Reload the guards list
                  } else {
                    showToast(result.message, 'error');
                  }
                })
                .generateSampleGuards();
            }
          }
        })
        .withFailureHandler(function(error) {
          console.error('Debug error:', error);
          alert('Error checking sheet status: ' + error.message);
        })
        .checkSheetStatus();
    }

    function openAddGuardModal() {
      document.getElementById('addGuardModal').style.display = 'flex';
      document.getElementById('guardHiredDate').valueAsDate = new Date();
      setupValidationListeners();
    }

    function closeAddGuardModal() {
      document.getElementById('addGuardModal').style.display = 'none';
      document.getElementById('addGuardForm').reset();
      document.getElementById('guardErrorMessage').style.display = 'none';
      // Reset to documents tab
      switchAddGuardTab('documents');
    }

    // Switch between tabs in Add Guard modal
    function switchAddGuardTab(tab) {
      const documentsTab = document.getElementById('documentsTab');
      const healthTab = document.getElementById('healthTab');
      const documentsContent = document.getElementById('documentsTabContent');
      const healthContent = document.getElementById('healthTabContent');

      if (tab === 'documents') {
        documentsTab.style.background = '#81d742';
        documentsTab.style.color = '#006341';
        healthTab.style.background = 'rgba(255,255,255,0.1)';
        healthTab.style.color = 'white';
        documentsContent.style.display = 'block';
        healthContent.style.display = 'none';
      } else if (tab === 'health') {
        healthTab.style.background = '#81d742';
        healthTab.style.color = '#006341';
        documentsTab.style.background = 'rgba(255,255,255,0.1)';
        documentsTab.style.color = 'white';
        healthContent.style.display = 'block';
        documentsContent.style.display = 'none';
      }
    }

    // Handle photo preview
    function handlePhotoPreview(input, previewElementId) {
      const previewDiv = document.getElementById(previewElementId);

      if (input.files && input.files[0]) {
        const file = input.files[0];

        // Check file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          alert('File size must be less than 5MB');
          input.value = '';
          previewDiv.innerHTML = '<span style="color: rgba(255,255,255,0.4); font-size: 0.85rem; text-align: center; padding: 0.5rem;">üì∑<br>Click to upload</span>';
          return;
        }

        // Check file type
        if (!file.type.match('image.*')) {
          alert('Please select an image file');
          input.value = '';
          previewDiv.innerHTML = '<span style="color: rgba(255,255,255,0.4); font-size: 0.85rem; text-align: center; padding: 0.5rem;">üì∑<br>Click to upload</span>';
          return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
          // Add click handler to image to allow re-upload
          previewDiv.innerHTML = '<img src="' + e.target.result + '" style="width: 100%; height: 100%; object-fit: cover;" onclick="event.stopPropagation(); document.getElementById(\'' + input.id + '\').click()" title="Click to change photo">';
        };
        reader.readAsDataURL(file);
      } else {
        previewDiv.innerHTML = '<span style="color: rgba(255,255,255,0.4); font-size: 0.85rem; text-align: center; padding: 0.5rem;">üì∑<br>Click to upload</span>';
      }
    }

    // Calculate BMI based on Philippine standard
    function calculateBMI() {
      const heightCm = parseFloat(document.getElementById('guardHeight').value);
      const weightKg = parseFloat(document.getElementById('guardWeight').value);

      if (heightCm > 0 && weightKg > 0) {
        const heightM = heightCm / 100; // Convert cm to meters
        const bmi = (weightKg / (heightM * heightM)).toFixed(1);

        document.getElementById('guardBMI').value = bmi;

        // Philippine BMI Classification (Asian-Pacific BMI Standards)
        let status = '';
        let statusColor = '';

        if (bmi < 18.5) {
          status = 'Underweight';
          statusColor = '#FBBF24'; // Yellow
        } else if (bmi >= 18.5 && bmi < 23) {
          status = 'Normal';
          statusColor = '#22C55E'; // Green
        } else if (bmi >= 23 && bmi < 25) {
          status = 'Overweight';
          statusColor = '#FB923C'; // Orange
        } else if (bmi >= 25 && bmi < 30) {
          status = 'Obese Class I';
          statusColor = '#EF4444'; // Red
        } else {
          status = 'Obese Class II';
          statusColor = '#DC2626'; // Dark Red
        }

        const bmiStatusDiv = document.getElementById('bmiStatus');
        bmiStatusDiv.textContent = status;
        bmiStatusDiv.style.color = statusColor;
        bmiStatusDiv.style.borderColor = statusColor;
      } else {
        document.getElementById('guardBMI').value = '';
        const bmiStatusDiv = document.getElementById('bmiStatus');
        bmiStatusDiv.textContent = '-';
        bmiStatusDiv.style.color = 'white';
        bmiStatusDiv.style.borderColor = 'rgba(129, 215, 66, 0.3)';
      }
    }

    // Switch tabs in Update Guard modal
    function switchUpdateGuardTab(tab) {
      const documentsTab = document.getElementById('updateDocumentsTab');
      const healthTab = document.getElementById('updateHealthTab');
      const documentsContent = document.getElementById('updateDocumentsTabContent');
      const healthContent = document.getElementById('updateHealthTabContent');

      if (tab === 'documents') {
        documentsTab.style.background = 'rgba(129, 215, 66, 0.3)';
        documentsTab.style.color = '#81d742';
        documentsTab.style.borderBottom = '3px solid #81d742';
        healthTab.style.background = 'transparent';
        healthTab.style.color = 'rgba(255,255,255,0.6)';
        healthTab.style.borderBottom = '3px solid transparent';
        documentsContent.style.display = 'block';
        healthContent.style.display = 'none';
      } else if (tab === 'health') {
        healthTab.style.background = 'rgba(129, 215, 66, 0.3)';
        healthTab.style.color = '#81d742';
        healthTab.style.borderBottom = '3px solid #81d742';
        documentsTab.style.background = 'transparent';
        documentsTab.style.color = 'rgba(255,255,255,0.6)';
        documentsTab.style.borderBottom = '3px solid transparent';
        healthContent.style.display = 'block';
        documentsContent.style.display = 'none';
      }
    }

    // Calculate BMI for Update Guard modal based on Philippine standard
    function calculateUpdateBMI() {
      const heightCm = parseFloat(document.getElementById('updateGuardHeight').value);
      const weightKg = parseFloat(document.getElementById('updateGuardWeight').value);

      if (heightCm > 0 && weightKg > 0) {
        const heightM = heightCm / 100; // Convert cm to meters
        const bmi = (weightKg / (heightM * heightM)).toFixed(1);

        document.getElementById('updateGuardBMI').value = bmi;

        // Philippine BMI Classification (Asian-Pacific BMI Standards)
        let status = '';
        let statusColor = '';

        if (bmi < 18.5) {
          status = 'Underweight';
          statusColor = '#FBBF24'; // Yellow
        } else if (bmi >= 18.5 && bmi < 23) {
          status = 'Normal';
          statusColor = '#22C55E'; // Green
        } else if (bmi >= 23 && bmi < 25) {
          status = 'Overweight';
          statusColor = '#FB923C'; // Orange
        } else if (bmi >= 25 && bmi < 30) {
          status = 'Obese Class I';
          statusColor = '#EF4444'; // Red
        } else {
          status = 'Obese Class II';
          statusColor = '#DC2626'; // Dark Red
        }

        const bmiStatusDiv = document.getElementById('updateBmiStatus');
        bmiStatusDiv.textContent = status;
        bmiStatusDiv.style.color = statusColor;
        bmiStatusDiv.style.borderColor = statusColor;
      } else {
        document.getElementById('updateGuardBMI').value = '';
        const bmiStatusDiv = document.getElementById('updateBmiStatus');
        bmiStatusDiv.textContent = '-';
        bmiStatusDiv.style.color = 'rgba(255,255,255,0.7)';
        bmiStatusDiv.style.borderColor = 'rgba(129, 215, 66, 0.3)';
      }
    }

    function closeUpdateGuardModal() {
      document.getElementById('updateGuardModal').style.display = 'none';
      document.getElementById('updateGuardForm').reset();
      document.getElementById('updateGuardErrorMessage').style.display = 'none';
      document.getElementById('updateGuardSuccessMessage').style.display = 'none';
      // Reset to documents tab
      switchUpdateGuardTab('documents');
      // Clear BMI fields
      document.getElementById('updateGuardBMI').value = '';
      document.getElementById('updateBmiStatus').textContent = '-';
      document.getElementById('updateBmiStatus').style.color = 'rgba(255,255,255,0.7)';
    }

    // Add Performance Modal Functions
    function openAddPerformanceModal() {
      const guardId = document.getElementById('updateGuardId').value;
      const firstName = document.getElementById('updateGuardFirstName').value;
      const middleName = document.getElementById('updateGuardMiddleName').value;
      const lastName = document.getElementById('updateGuardLastName').value;
      const suffix = document.getElementById('updateGuardSuffix').value;

      const fullName = [firstName, middleName, lastName, suffix].filter(Boolean).join(' ');

      document.getElementById('performanceGuardId').value = guardId;
      document.getElementById('performanceGuardName').value = fullName;

      // Set today's date as default
      document.getElementById('performanceDate').valueAsDate = new Date();

      // Reset form
      document.getElementById('addPerformanceForm').reset();
      document.getElementById('performanceGuardId').value = guardId;
      document.getElementById('performanceGuardName').value = fullName;
      document.getElementById('performanceDate').valueAsDate = new Date();

      // Load violation types and sanctions
      loadViolationTypesForPerformance();
      loadSanctionsForPerformance();

      document.getElementById('addPerformanceModal').style.display = 'flex';
    }

    function closeAddPerformanceModal() {
      document.getElementById('addPerformanceModal').style.display = 'none';
      document.getElementById('performanceErrorMessage').style.display = 'none';
    }

    function loadViolationTypesForPerformance() {
      google.script.run
        .withSuccessHandler(function(violationTypes) {
          const select = document.getElementById('performanceViolationType');
          select.innerHTML = '<option value="" style="background: #006341; color: white;">Select Violation Type</option>';

          violationTypes.forEach(vt => {
            const option = document.createElement('option');
            option.value = vt.name;
            option.textContent = vt.name;
            option.style.background = '#006341';
            option.style.color = 'white';
            select.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          console.error('Error loading violation types:', error);
        })
        .getViolationTypes();
    }

    function loadSanctionsForPerformance() {
      google.script.run
        .withSuccessHandler(function(sanctions) {
          const select = document.getElementById('performanceSanction');
          select.innerHTML = '<option value="" style="background: #006341; color: white;">Select Sanction</option>';

          sanctions.forEach(s => {
            const option = document.createElement('option');
            option.value = s.name;
            option.textContent = s.name;
            option.style.background = '#006341';
            option.style.color = 'white';
            select.appendChild(option);
          });
        })
        .withFailureHandler(function(error) {
          console.error('Error loading sanctions:', error);
        })
        .getViolationSanctions();
    }

    // Handle Type selection change - show/hide violation fields
    document.addEventListener('DOMContentLoaded', function() {
      const performanceTypeSelect = document.getElementById('performanceType');
      if (performanceTypeSelect) {
        performanceTypeSelect.addEventListener('change', function() {
          const type = this.value;
          const violationTypeContainer = document.getElementById('violationTypeContainer');
          const violationSanctionContainer = document.getElementById('violationSanctionContainer');

          if (type === 'Violation') {
            violationTypeContainer.style.display = 'block';
            violationSanctionContainer.style.display = 'block';
            document.getElementById('performanceViolationType').setAttribute('required', 'required');
            document.getElementById('performanceSanction').setAttribute('required', 'required');
          } else {
            violationTypeContainer.style.display = 'none';
            violationSanctionContainer.style.display = 'none';
            // Reset values when hiding
            document.getElementById('performanceViolationType').value = '';
            document.getElementById('performanceSanction').value = '';
            document.getElementById('performanceViolationType').removeAttribute('required');
            document.getElementById('performanceSanction').removeAttribute('required');
          }
        });
      }

      // Add Performance Form Submit
      const addPerformanceForm = document.getElementById('addPerformanceForm');
      if (addPerformanceForm) {
        addPerformanceForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          const type = document.getElementById('performanceType').value;
          const description = document.getElementById('performanceDescription').value.trim();
          const date = document.getElementById('performanceDate').value;

          // Validation
          if (!type || !description || !date) {
            document.getElementById('performanceErrorMessage').textContent = 'Please fill in all required fields';
            document.getElementById('performanceErrorMessage').style.display = 'block';
            return;
          }

          if (type === 'Violation') {
            const violationType = document.getElementById('performanceViolationType').value;
            const sanction = document.getElementById('performanceSanction').value;

            if (!violationType || !sanction) {
              document.getElementById('performanceErrorMessage').textContent = 'Please select violation type and sanction';
              document.getElementById('performanceErrorMessage').style.display = 'block';
              return;
            }
          }

          // Hide error message
          document.getElementById('performanceErrorMessage').style.display = 'none';

          // Disable submit button
          const submitBtn = document.getElementById('submitPerformanceBtn');
          const originalText = submitBtn.textContent;
          submitBtn.innerHTML = '<span class="spinner"></span>Adding...';
          submitBtn.disabled = true;

          try {
            // Handle PDF upload if file is selected
            let pdfLink = '';
            const pdfFile = document.getElementById('performancePDF').files[0];

            if (pdfFile) {
              // Validate file size (5MB max)
              if (pdfFile.size > 5 * 1024 * 1024) {
                throw new Error('PDF file size must be less than 5MB');
              }

              // Validate file type
              if (pdfFile.type !== 'application/pdf') {
                throw new Error('Only PDF files are allowed');
              }

              // Read file as base64
              const fileData = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                  resolve({
                    content: e.target.result,
                    filename: pdfFile.name,
                    mimeType: pdfFile.type
                  });
                };
                reader.onerror = reject;
                reader.readAsDataURL(pdfFile);
              });

              // Upload to Drive
              const uploadResult = await new Promise((resolve, reject) => {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  .uploadPDFToDrive(fileData);
              });

              if (!uploadResult.success) {
                throw new Error(uploadResult.message);
              }

              pdfLink = uploadResult.fileUrl;
            }

            // Prepare performance data
            const performanceData = {
              guardId: document.getElementById('performanceGuardId').value,
              guardName: document.getElementById('performanceGuardName').value,
              type: type,
              typeOfViolation: type === 'Violation' ? document.getElementById('performanceViolationType').value : 'N/A',
              shortDescription: description,
              date: date,
              violationSanction: type === 'Violation' ? document.getElementById('performanceSanction').value : 'N/A',
              pdfLink: pdfLink
            };

            // Save performance record
            google.script.run
              .withSuccessHandler(function(result) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;

                if (result.success) {
                  closeAddPerformanceModal();
                  showToast('success', 'Performance Added', 'Performance record has been added successfully.');
                } else {
                  document.getElementById('performanceErrorMessage').textContent = result.message;
                  document.getElementById('performanceErrorMessage').style.display = 'block';
                }
              })
              .withFailureHandler(function(error) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                document.getElementById('performanceErrorMessage').textContent = 'Error: ' + error.message;
                document.getElementById('performanceErrorMessage').style.display = 'block';
              })
              .addPerformanceRecord(performanceData, currentUser.username);

          } catch (error) {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            document.getElementById('performanceErrorMessage').textContent = error.message;
            document.getElementById('performanceErrorMessage').style.display = 'block';
          }
        });
      }
    });

    // Update the old function to call the new one
    function addPerformanceRecord() {
      openAddPerformanceModal();
    }

    // Form submissions - Add and Update Guard
    document.addEventListener('DOMContentLoaded', () => {
      // Update Record Type change handler
      const updateRecordTypeSelect = document.getElementById('updateRecordType');
      if (updateRecordTypeSelect) {
        updateRecordTypeSelect.addEventListener('change', function() {
          const type = this.value;
          const violationTypeContainer = document.getElementById('updateRecordViolationTypeContainer');
          const violationSanctionContainer = document.getElementById('updateRecordSanctionContainer');

          if (type === 'Violation') {
            violationTypeContainer.style.display = 'block';
            violationSanctionContainer.style.display = 'block';
            document.getElementById('updateRecordViolationType').setAttribute('required', 'required');
            document.getElementById('updateRecordSanction').setAttribute('required', 'required');
          } else {
            violationTypeContainer.style.display = 'none';
            violationSanctionContainer.style.display = 'none';
            // Reset values when hiding
            document.getElementById('updateRecordViolationType').value = '';
            document.getElementById('updateRecordSanction').value = '';
            document.getElementById('updateRecordViolationType').removeAttribute('required');
            document.getElementById('updateRecordSanction').removeAttribute('required');
          }
        });
      }

      // Update Record Form Submit
      const updateRecordForm = document.getElementById('updateRecordForm');
      if (updateRecordForm) {
        updateRecordForm.addEventListener('submit', async function(e) {
          e.preventDefault();

          const recordId = document.getElementById('updateRecordId').value;
          const type = document.getElementById('updateRecordType').value;
          const description = document.getElementById('updateRecordDescription').value.trim();
          const date = document.getElementById('updateRecordDate').value;

          // Validation
          if (!type || !description || !date) {
            document.getElementById('updateRecordErrorMessage').textContent = 'Please fill in all required fields';
            document.getElementById('updateRecordErrorMessage').style.display = 'block';
            return;
          }

          if (type === 'Violation') {
            const violationType = document.getElementById('updateRecordViolationType').value;
            const sanction = document.getElementById('updateRecordSanction').value;

            if (!violationType || !sanction) {
              document.getElementById('updateRecordErrorMessage').textContent = 'Please select violation type and sanction';
              document.getElementById('updateRecordErrorMessage').style.display = 'block';
              return;
            }
          }

          // Hide error message
          document.getElementById('updateRecordErrorMessage').style.display = 'none';

          // Disable submit button
          const submitBtn = document.getElementById('submitUpdateRecordBtn');
          const originalText = submitBtn.textContent;
          submitBtn.innerHTML = '<span class="spinner"></span>Updating...';
          submitBtn.disabled = true;

          try {
            // Get current PDF link
            let pdfLink = document.getElementById('updateRecordCurrentPdfLink').value;

            // Handle PDF upload if new file is selected
            const pdfFile = document.getElementById('updateRecordPDF').files[0];

            if (pdfFile) {
              // Validate file size (5MB max)
              if (pdfFile.size > 5 * 1024 * 1024) {
                throw new Error('PDF file size must be less than 5MB');
              }

              // Validate file type
              if (pdfFile.type !== 'application/pdf') {
                throw new Error('Only PDF files are allowed');
              }

              // Read file as base64
              const fileData = await new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                  resolve({
                    content: e.target.result,
                    filename: pdfFile.name,
                    mimeType: pdfFile.type
                  });
                };
                reader.onerror = reject;
                reader.readAsDataURL(pdfFile);
              });

              // Upload to Drive
              const uploadResult = await new Promise((resolve, reject) => {
                google.script.run
                  .withSuccessHandler(resolve)
                  .withFailureHandler(reject)
                  .uploadPDFToDrive(fileData);
              });

              if (!uploadResult.success) {
                throw new Error(uploadResult.message);
              }

              // Update PDF link with new upload
              pdfLink = uploadResult.fileUrl;
            }

            // Prepare performance data
            const performanceData = {
              type: type,
              typeOfViolation: type === 'Violation' ? document.getElementById('updateRecordViolationType').value : 'N/A',
              shortDescription: description,
              date: date,
              violationSanction: type === 'Violation' ? document.getElementById('updateRecordSanction').value : 'N/A',
              pdfLink: pdfLink
            };

            // Update record
            google.script.run
              .withSuccessHandler(function(result) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;

                if (result.success) {
                  closeUpdateRecordModal();
                  showToast('success', 'Record Updated', 'Performance record has been updated successfully.');
                  loadAllRecords(); // Reload records list
                } else {
                  document.getElementById('updateRecordErrorMessage').textContent = result.message;
                  document.getElementById('updateRecordErrorMessage').style.display = 'block';
                }
              })
              .withFailureHandler(function(error) {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                document.getElementById('updateRecordErrorMessage').textContent = 'Error: ' + error.message;
                document.getElementById('updateRecordErrorMessage').style.display = 'block';
              })
              .updatePerformanceRecord(recordId, performanceData, currentUser.username);

          } catch (error) {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            document.getElementById('updateRecordErrorMessage').textContent = error.message;
            document.getElementById('updateRecordErrorMessage').style.display = 'block';
          }
        });
      }
    });

    // Form submissions - Add and Update Guard
    document.addEventListener('DOMContentLoaded', () => {
      // Add Guard Form
      const addForm = document.getElementById('addGuardForm');
      if (addForm) {
        addForm.addEventListener('submit', (e) => {
          e.preventDefault();

          // Custom validation
          if (!validateAddGuardForm()) {
            return;
          }

          submitGuard();
        });
      }

      // Update Guard Form
      const updateForm = document.getElementById('updateGuardForm');
      if (updateForm) {
        updateForm.addEventListener('submit', (e) => {
          e.preventDefault();

          const guardId = document.getElementById('updateGuardId').value;

          // Collect form data
          const guardData = {
            firstName: document.getElementById('updateGuardFirstName').value,
            middleName: document.getElementById('updateGuardMiddleName').value,
            lastName: document.getElementById('updateGuardLastName').value,
            suffix: document.getElementById('updateGuardSuffix').value,
            dateOfBirth: document.getElementById('updateGuardDOB').value,
            hiredDate: document.getElementById('updateGuardHiredDate').value,
            endOfContractDate: document.getElementById('updateGuardEndContract').value,
            status: document.getElementById('updateGuardStatus').value,
            licenseNumber: document.getElementById('updateLicenseNumber').value,
            licenseExpiry: document.getElementById('updateLicenseExpiry').value,
            policeClearance: document.getElementById('updatePoliceClearance').value,
            nbiClearance: document.getElementById('updateNbiClearance').value,
            drugTestValidity: document.getElementById('updateDrugTestValidity').value,
            neuroExamValidity: document.getElementById('updateNeuroExamValidity').value,
            height: document.getElementById('updateGuardHeight').value,
            weight: document.getElementById('updateGuardWeight').value,
            healthNotes: document.getElementById('updateGuardHealthNotes').value.trim()
          };

          // Handle photo upload
          const photoInput = document.getElementById('updateGuardPhoto');
          if (photoInput.files && photoInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
              guardData.photo = {
                base64: e.target.result,
                filename: photoInput.files[0].name,
                mimeType: photoInput.files[0].type
              };

              submitUpdateGuardWithData(guardId, guardData);
            };
            reader.readAsDataURL(photoInput.files[0]);
          } else {
            submitUpdateGuardWithData(guardId, guardData);
          }
        });
      }

      function submitUpdateGuardWithData(guardId, guardData) {
        // Disable button and show loading
        const updateBtn = document.getElementById('updateGuardBtn');
        updateBtn.textContent = 'Updating...';
        updateBtn.disabled = true;

        // Hide messages
        document.getElementById('updateGuardErrorMessage').style.display = 'none';
        document.getElementById('updateGuardSuccessMessage').style.display = 'none';

        // Call server function
        google.script.run
          .withSuccessHandler(handleUpdateGuardSuccess)
          .withFailureHandler(handleUpdateGuardFailure)
          .updateGuard(guardId, guardData, currentUser.username);
      }

      // Add Violation Form Submit
      const addViolationForm = document.getElementById('addViolationForm');
      if (addViolationForm) {
        addViolationForm.addEventListener('submit', function(e) {
          e.preventDefault();

          const name = document.getElementById('violationName').value.trim();
          const description = document.getElementById('violationDescription').value.trim();

          if (!name) {
            document.getElementById('violationName').classList.add('invalid');
            showToast('error', 'Validation Error', 'Violation name is required');
            return;
          }

          // Remove invalid class
          document.getElementById('violationName').classList.remove('invalid');

          // Get submit button and show loading state
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.innerHTML = '<span class="spinner"></span>Adding...';
          submitBtn.disabled = true;

          // Call server function
          google.script.run
            .withSuccessHandler(function(result) {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;

              if (result.success) {
                closeAddViolationModal();
                showToast('success', 'Violation Added', `${name} has been added successfully.`);
                loadSettings(); // Refresh settings view
              } else {
                showToast('error', 'Error', result.message || 'Failed to add violation type.');
              }
            })
            .withFailureHandler(function(error) {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;
              showToast('error', 'Error', 'An error occurred while adding violation type.');
              console.error('Add violation error:', error);
            })
            .addViolationType(name, description);
        });
      }

      // Add Sanction Form Submit
      const addSanctionForm = document.getElementById('addSanctionForm');
      if (addSanctionForm) {
        addSanctionForm.addEventListener('submit', function(e) {
          e.preventDefault();

          const name = document.getElementById('sanctionName').value.trim();
          const description = document.getElementById('sanctionDescription').value.trim();

          if (!name) {
            document.getElementById('sanctionName').classList.add('invalid');
            showToast('error', 'Validation Error', 'Sanction name is required');
            return;
          }

          document.getElementById('sanctionName').classList.remove('invalid');

          // Get submit button and show loading state
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.innerHTML = '<span class="spinner"></span>Adding...';
          submitBtn.disabled = true;

          google.script.run
            .withSuccessHandler(function(result) {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;

              if (result.success) {
                closeAddSanctionModal();
                showToast('success', 'Sanction Added', `${name} has been added successfully.`);
                loadSettings();
              } else {
                showToast('error', 'Error', result.message || 'Failed to add sanction.');
              }
            })
            .withFailureHandler(function(error) {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;
              showToast('error', 'Error', 'An error occurred while adding sanction.');
              console.error('Add sanction error:', error);
            })
            .addViolationSanction(name, description);
        });
      }

      // Edit Violation Form Submit
      const editViolationForm = document.getElementById('editViolationForm');
      if (editViolationForm) {
        editViolationForm.addEventListener('submit', function(e) {
          e.preventDefault();

          const id = document.getElementById('editViolationId').value;
          const name = document.getElementById('editViolationName').value.trim();
          const description = document.getElementById('editViolationDescription').value.trim();

          if (!name) {
            document.getElementById('editViolationName').classList.add('invalid');
            showToast('error', 'Validation Error', 'Violation name is required');
            return;
          }

          document.getElementById('editViolationName').classList.remove('invalid');

          // Get submit button and show loading state
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.innerHTML = '<span class="spinner"></span>Updating...';
          submitBtn.disabled = true;

          google.script.run
            .withSuccessHandler(function(result) {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;

              if (result.success) {
                closeEditViolationModal();
                showToast('success', 'Violation Updated', `${name} has been updated successfully.`);
                loadSettings();
              } else {
                showToast('error', 'Error', result.message || 'Failed to update violation type.');
              }
            })
            .withFailureHandler(function(error) {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;
              showToast('error', 'Error', 'An error occurred while updating violation type.');
              console.error('Update violation error:', error);
            })
            .updateViolationType(id, name, description);
        });
      }

      // Edit Sanction Form Submit
      const editSanctionForm = document.getElementById('editSanctionForm');
      if (editSanctionForm) {
        editSanctionForm.addEventListener('submit', function(e) {
          e.preventDefault();

          const id = document.getElementById('editSanctionId').value;
          const name = document.getElementById('editSanctionName').value.trim();
          const description = document.getElementById('editSanctionDescription').value.trim();

          if (!name) {
            document.getElementById('editSanctionName').classList.add('invalid');
            showToast('error', 'Validation Error', 'Sanction name is required');
            return;
          }

          document.getElementById('editSanctionName').classList.remove('invalid');

          // Get submit button and show loading state
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.innerHTML = '<span class="spinner"></span>Updating...';
          submitBtn.disabled = true;

          google.script.run
            .withSuccessHandler(function(result) {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;

              if (result.success) {
                closeEditSanctionModal();
                showToast('success', 'Sanction Updated', `${name} has been updated successfully.`);
                loadSettings();
              } else {
                showToast('error', 'Error', result.message || 'Failed to update sanction.');
              }
            })
            .withFailureHandler(function(error) {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;
              showToast('error', 'Error', 'An error occurred while updating sanction.');
              console.error('Update sanction error:', error);
            })
            .updateViolationSanction(id, name, description);
        });
      }
    });

    function validateAddGuardForm() {
      // Required field IDs (excluding Suffix and End of Contract)
      const requiredFields = [
        'guardFirstName',
        'guardMiddleName',
        'guardLastName',
        'guardDOB',
        'guardHiredDate',
        'guardStatus',
        'licenseNumber',
        'licenseExpiry',
        'policeClearance',
        'nbiClearance',
        'drugTestValidity',
        'neuroExamValidity'
      ];

      let isValid = true;
      let firstInvalidField = null;

      // Remove previous invalid styles
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.classList.remove('invalid');
        }
      });

      // Check each required field
      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field && !field.value.trim()) {
          field.classList.add('invalid');
          isValid = false;
          if (!firstInvalidField) {
            firstInvalidField = field;
          }
        }
      });

      // Show toast and focus first invalid field
      if (!isValid) {
        showToast('error', 'Required Fields Missing', 'Please fill out all required fields marked with *');
        if (firstInvalidField) {
          firstInvalidField.focus();
        }
      }

      return isValid;
    }

    // Add event listeners to remove invalid styling on input
    function setupValidationListeners() {
      const requiredFields = [
        'guardFirstName', 'guardMiddleName', 'guardLastName',
        'guardDOB', 'guardHiredDate', 'guardStatus',
        'licenseNumber', 'licenseExpiry', 'policeClearance',
        'nbiClearance', 'drugTestValidity', 'neuroExamValidity'
      ];

      requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.addEventListener('input', function() {
            if (this.classList.contains('invalid')) {
              this.classList.remove('invalid');
            }
          });
        }
      });
    }

    function submitGuard() {
      const guardData = {
        firstName: document.getElementById('guardFirstName').value.trim(),
        middleName: document.getElementById('guardMiddleName').value.trim(),
        lastName: document.getElementById('guardLastName').value.trim(),
        suffix: document.getElementById('guardSuffix').value.trim(),
        dateOfBirth: document.getElementById('guardDOB').value,
        hiredDate: document.getElementById('guardHiredDate').value,
        endOfContractDate: document.getElementById('guardEndContract').value,
        status: document.getElementById('guardStatus').value,
        licenseNumber: document.getElementById('licenseNumber').value.trim(),
        licenseExpiry: document.getElementById('licenseExpiry').value,
        policeClearance: document.getElementById('policeClearance').value,
        nbiClearance: document.getElementById('nbiClearance').value,
        drugTestValidity: document.getElementById('drugTestValidity').value,
        neuroExamValidity: document.getElementById('neuroExamValidity').value,
        height: document.getElementById('guardHeight').value,
        weight: document.getElementById('guardWeight').value,
        healthNotes: document.getElementById('guardHealthNotes').value.trim()
      };

      // Handle photo upload
      const photoInput = document.getElementById('guardPhoto');
      if (photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          guardData.photo = {
            base64: e.target.result,
            filename: photoInput.files[0].name,
            mimeType: photoInput.files[0].type
          };

          submitGuardWithData(guardData);
        };
        reader.readAsDataURL(photoInput.files[0]);
      } else {
        submitGuardWithData(guardData);
      }
    }

    function submitGuardWithData(guardData) {
      const btn = document.getElementById('submitGuardBtn');
      btn.textContent = 'Adding...';
      btn.disabled = true;

      // Log photo info for debugging
      if (guardData.photo) {
        console.log('Submitting guard with photo:', {
          filename: guardData.photo.filename,
          mimeType: guardData.photo.mimeType,
          base64Length: guardData.photo.base64 ? guardData.photo.base64.length : 0
        });
      } else {
        console.log('Submitting guard without photo');
      }

      google.script.run
        .withSuccessHandler(handleAddGuardSuccess)
        .withFailureHandler(handleAddGuardFailure)
        .addGuard(guardData, currentUser.username);
    }

    function handleAddGuardSuccess(result) {
      console.log('Add guard result:', result);

      if (result.success) {
        closeAddGuardModal();

        // Show success toast
        showToast('success', 'Guard Added', 'Guard added successfully! ID: ' + result.guardId);

        // Refresh the guards list
        if (currentView === 'guards') {
          loadGuards();
        }
      } else {
        showGuardError(result.message);
      }

      document.getElementById('submitGuardBtn').textContent = 'Add Guard';
      document.getElementById('submitGuardBtn').disabled = false;
    }

    function handleAddGuardFailure(error) {
      showGuardError('Error adding guard: ' + error.message);
      document.getElementById('submitGuardBtn').textContent = 'Add Guard';
      document.getElementById('submitGuardBtn').disabled = false;
    }

    function showGuardError(message) {
      const errorMsg = document.getElementById('guardErrorMessage');
      errorMsg.textContent = message;
      errorMsg.style.display = 'block';
    }

    function handleUpdateGuardSuccess(result) {
      const updateBtn = document.getElementById('updateGuardBtn');
      updateBtn.textContent = 'Update Guard';
      updateBtn.disabled = false;

      if (result.success) {
        // Show success toast
        showToast('success', 'Guard Updated', result.message);

        // Close modal immediately
        closeUpdateGuardModal();

        // Refresh the guards list
        if (currentView === 'guards') {
          loadGuards();
        }
      } else {
        const errorMsg = document.getElementById('updateGuardErrorMessage');
        errorMsg.textContent = result.message;
        errorMsg.style.display = 'block';
      }
    }

    function handleUpdateGuardFailure(error) {
      const errorMsg = document.getElementById('updateGuardErrorMessage');
      errorMsg.textContent = 'Error updating guard: ' + error.message;
      errorMsg.style.display = 'block';

      const updateBtn = document.getElementById('updateGuardBtn');
      updateBtn.textContent = 'Update Guard';
      updateBtn.disabled = false;
    }


    // Global variables for records
    let allRecordsList = [];
    let filteredRecordsList = [];
    let currentRecordsPage = 1;

    function renderPerformanceView() {
      return `
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
              <h1 style="color: #81d742; font-size: 2rem; margin: 0 0 0.5rem;">Records Monitoring</h1>
              <p style="color: white; opacity: 0.7; margin: 0;">Track violations and accomplishments</p>
            </div>
            ${currentUser.role === 'Admin' ? `
            <div style="display: flex; gap: 1rem; align-items: center;">
              <button
                onclick="extractRecordsToExcel()"
                style="background: #81d742; color: #006341; padding: 0.875rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: all 0.3s ease;"
                onmouseover="this.style.background='#6bc92b'"
                onmouseout="this.style.background='#81d742'"
              >
                üìä Extract Records
              </button>
            </div>
            ` : ''}
          </div>

          <!-- Search and Filter Controls -->
          <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(129, 215, 66, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <div style="display: flex; gap: 1rem; align-items: end;">
              <div style="width: 37.5%;">
                <label style="display: block; color: #81d742; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">üîç Search</label>
                <input
                  type="text"
                  id="recordsSearchInput"
                  placeholder="Search by guard name"
                  oninput="filterRecords()"
                  style="width: 100%; padding: 0.875rem 1rem; background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(129, 215, 66, 0.4); border-radius: 10px; color: white; font-size: 0.95rem; transition: all 0.3s ease;"
                  onfocus="this.style.border='2px solid #81d742'; this.style.background='rgba(255, 255, 255, 0.2)';"
                  onblur="this.style.border='2px solid rgba(129, 215, 66, 0.4)'; this.style.background='rgba(255, 255, 255, 0.15)';"
                />
              </div>
              <div style="width: 12.5%;">
                <label style="display: block; color: #81d742; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">üìã Type</label>
                <select
                  id="typeFilter"
                  onchange="filterRecords()"
                  style="width: 100%; padding: 0.875rem 1rem; background: #006341; border: 2px solid rgba(129, 215, 66, 0.4); border-radius: 10px; color: white; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease;"
                  onfocus="this.style.border='2px solid #81d742';"
                  onblur="this.style.border='2px solid rgba(129, 215, 66, 0.4)';"
                >
                  <option value="all" style="background: #006341; color: white;">All Types</option>
                  <option value="Violation" style="background: #006341; color: white;">Violation</option>
                  <option value="Accomplishment" style="background: #006341; color: white;">Accomplishment</option>
                </select>
              </div>
              <div style="width: 12.5%;">
                <label style="display: block; color: #81d742; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">üìÖ Start Date</label>
                <input
                  type="date"
                  id="startDateFilter"
                  onchange="filterRecords()"
                  style="width: 100%; padding: 0.875rem 1rem; background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(129, 215, 66, 0.4); border-radius: 10px; color: white; font-size: 0.95rem; transition: all 0.3s ease;"
                  onfocus="this.style.border='2px solid #81d742'; this.style.background='rgba(255, 255, 255, 0.2)';"
                  onblur="this.style.border='2px solid rgba(129, 215, 66, 0.4)'; this.style.background='rgba(255, 255, 255, 0.15)';"
                />
              </div>
              <div style="width: 12.5%;">
                <label style="display: block; color: #81d742; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">üìÖ End Date</label>
                <input
                  type="date"
                  id="endDateFilter"
                  onchange="filterRecords()"
                  style="width: 100%; padding: 0.875rem 1rem; background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(129, 215, 66, 0.4); border-radius: 10px; color: white; font-size: 0.95rem; transition: all 0.3s ease;"
                  onfocus="this.style.border='2px solid #81d742'; this.style.background='rgba(255, 255, 255, 0.2)';"
                  onblur="this.style.border='2px solid rgba(129, 215, 66, 0.4)'; this.style.background='rgba(255, 255, 255, 0.15)';"
                />
              </div>
            </div>
          </div>

          <!-- Records List -->
          <div id="records-list-container">
            <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6);">
              <div class="spinner" style="margin: 0 auto 1rem;"></div>
              Loading records...
            </div>
          </div>

          <!-- Pagination -->
          <div id="records-pagination"></div>
        </div>
      `;
    }

    function loadAllRecords() {
      google.script.run
        .withSuccessHandler(function(records) {
          allRecordsList = records;
          filteredRecordsList = records;
          currentRecordsPage = 1;
          renderRecordsList();
        })
        .withFailureHandler(function(error) {
          console.error('Error loading records:', error);
          document.getElementById('records-list-container').innerHTML = `
            <div style="background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 1.5rem; border-radius: 12px; text-align: center;">
              Error loading records: ${error.message}
            </div>
          `;
        })
        .getAllPerformanceRecords();
    }

    function filterRecords() {
      const searchTerm = document.getElementById('recordsSearchInput')?.value.toLowerCase() || '';
      const typeFilter = document.getElementById('typeFilter')?.value || 'all';
      const startDate = document.getElementById('startDateFilter')?.value || '';
      const endDate = document.getElementById('endDateFilter')?.value || '';

      filteredRecordsList = allRecordsList.filter(record => {
        // Filter by type dropdown
        if (typeFilter !== 'all' && record.type !== typeFilter) return false;

        // Filter by date range
        if (startDate || endDate) {
          const recordDate = parseRecordDate(record.date);
          if (recordDate) {
            if (startDate && recordDate < new Date(startDate)) return false;
            if (endDate && recordDate > new Date(endDate + 'T23:59:59')) return false;
          }
        }

        // Filter by search term
        if (searchTerm) {
          return record.guardName.toLowerCase().includes(searchTerm) ||
                 record.shortDescription.toLowerCase().includes(searchTerm) ||
                 record.type.toLowerCase().includes(searchTerm) ||
                 record.typeOfViolation.toLowerCase().includes(searchTerm);
        }

        return true;
      });

      currentRecordsPage = 1;
      renderRecordsList();
    }

    // Helper function to parse date from "MMM dd, yyyy" format
    function parseRecordDate(dateStr) {
      if (!dateStr) return null;
      try {
        // Parse "Jan 15, 2024" format
        const months = {
          'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
          'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11
        };
        const parts = dateStr.match(/(\w+)\s+(\d+),\s+(\d+)/);
        if (parts) {
          const month = months[parts[1]];
          const day = parseInt(parts[2]);
          const year = parseInt(parts[3]);
          return new Date(year, month, day);
        }
      } catch (e) {
        console.error('Error parsing date:', dateStr, e);
      }
      return null;
    }

    // Open export format selection modal
    function extractRecordsToExcel() {
      if (filteredRecordsList.length === 0) {
        showToast('warning', 'No Records', 'No records to extract based on current filters');
        return;
      }

      // Update record count in modal
      document.getElementById('exportRecordCount').textContent = filteredRecordsList.length;

      // Show export format modal
      document.getElementById('exportFormatModal').style.display = 'flex';
    }

    function closeExportFormatModal() {
      document.getElementById('exportFormatModal').style.display = 'none';
    }

    // Export to Excel (CSV)
    function exportToExcel() {
      // Prepare data for CSV (Excel format)
      const headers = ['Record ID', 'Guard ID', 'Guard Name', 'Type', 'Date', 'Violation Type', 'Sanction', 'Description'];
      const csvRows = [headers.join(',')];

      filteredRecordsList.forEach(record => {
        const row = [
          record.recordId || '',
          record.guardId || '',
          `"${record.guardName || ''}"`,
          record.type || '',
          record.date || '',
          record.typeOfViolation || 'N/A',
          record.violationSanction || 'N/A',
          `"${(record.shortDescription || '').replace(/"/g, '""')}"`
        ];
        csvRows.push(row.join(','));
      });

      // Create CSV content
      const csvContent = csvRows.join('\n');

      // Create blob and download
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);

      // Generate filename
      const filename = generateExportFilename('csv');

      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      closeExportFormatModal();
      showToast('success', 'Export Successful', `Extracted ${filteredRecordsList.length} records to ${filename}`);
    }

    // Export to PDF
    function exportToPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4'); // Landscape orientation

      // Title
      doc.setFontSize(16);
      doc.setTextColor(0, 99, 65); // DLSU Green
      doc.text('Guard Monitoring System - Records Export', 15, 15);

      // Subtitle with filters
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      const startDate = document.getElementById('startDateFilter')?.value || '';
      const endDate = document.getElementById('endDateFilter')?.value || '';
      let subtitle = `Total Records: ${filteredRecordsList.length}`;
      if (startDate && endDate) {
        subtitle += ` | Period: ${startDate} to ${endDate}`;
      } else if (startDate) {
        subtitle += ` | From: ${startDate}`;
      } else if (endDate) {
        subtitle += ` | Until: ${endDate}`;
      }
      doc.text(subtitle, 15, 22);

      // Prepare table data - Only 5 columns: Guard Name, Type, Date, Violation Type, Sanction
      const tableData = filteredRecordsList.map(record => [
        record.guardName || '',
        record.type || '',
        record.date || '',
        record.typeOfViolation || 'N/A',
        record.violationSanction || 'N/A'
      ]);

      // Generate table
      doc.autoTable({
        head: [['Guard Name', 'Type', 'Date', 'Violation Type', 'Sanction']],
        body: tableData,
        startY: 28,
        styles: {
          fontSize: 10,
          cellPadding: 3
        },
        headStyles: {
          fillColor: [0, 99, 65], // DLSU Green
          textColor: 255,
          fontStyle: 'bold'
        },
        alternateRowStyles: {
          fillColor: [245, 245, 245]
        },
        margin: { bottom: 25 },
        columnStyles: {
          0: { cellWidth: 70 },  // Guard Name
          1: { cellWidth: 35 },  // Type
          2: { cellWidth: 35 },  // Date
          3: { cellWidth: 55 },  // Violation Type
          4: { cellWidth: 60 }   // Sanction
        }
      });

      // Footer with user and date/time
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);

        // Current date and time in "Jan, 01, 2025 hh:mm" format
        const today = new Date();
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const monthStr = months[today.getMonth()];
        const dayStr = String(today.getDate()).padStart(2, '0');
        const yearStr = today.getFullYear();
        const hoursStr = String(today.getHours()).padStart(2, '0');
        const minutesStr = String(today.getMinutes()).padStart(2, '0');
        const dateTimeStr = `${monthStr}, ${dayStr}, ${yearStr} ${hoursStr}:${minutesStr}`;

        // Footer text: "Extracted by [user name] | Jan, 01, 2025 hh:mm"
        const footerText = `Extracted by ${currentUser.fullName} | ${dateTimeStr}`;
        const footerX = doc.internal.pageSize.getWidth() / 2;
        const footerY = doc.internal.pageSize.getHeight() - 10;

        doc.text(footerText, footerX, footerY, { align: 'center' });

        // Page number
        doc.text(`Page ${i} of ${pageCount}`, doc.internal.pageSize.getWidth() - 20, footerY, { align: 'right' });
      }

      // Generate filename and save
      const filename = generateExportFilename('pdf');
      doc.save(filename);

      closeExportFormatModal();
      showToast('success', 'Export Successful', `Extracted ${filteredRecordsList.length} records to ${filename}`);
    }

    // Generate export filename with date range
    function generateExportFilename(extension) {
      const startDate = document.getElementById('startDateFilter')?.value || '';
      const endDate = document.getElementById('endDateFilter')?.value || '';
      let filename = 'Records_Export';
      if (startDate && endDate) {
        filename += `_${startDate}_to_${endDate}`;
      } else if (startDate) {
        filename += `_from_${startDate}`;
      } else if (endDate) {
        filename += `_until_${endDate}`;
      }
      filename += `_${new Date().toISOString().split('T')[0]}.${extension}`;
      return filename;
    }

    // Tab function removed - now using Type dropdown filter instead

    function renderRecordsList() {
      const container = document.getElementById('records-list-container');
      if (!container) return;

      if (filteredRecordsList.length === 0) {
        container.innerHTML = `
          <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 12px; padding: 2rem; text-align: center;">
            <p style="color: white; opacity: 0.6; margin: 0;">No records found</p>
          </div>
        `;
        document.getElementById('records-pagination').innerHTML = '';
        return;
      }

      // Pagination
      const startIndex = (currentRecordsPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedRecords = filteredRecordsList.slice(startIndex, endIndex);

      let html = `
        <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 12px; padding: 1.5rem; overflow-x: auto;">
          <table style="width: 100%; border-collapse: collapse; color: white;">
            <thead>
              <tr style="border-bottom: 2px solid rgba(129, 215, 66, 0.3);">
                <th style="padding: 1rem; text-align: left; color: #81d742; font-weight: 700;">Guard Name</th>
                <th style="padding: 1rem; text-align: left; color: #81d742; font-weight: 700;">Type</th>
                <th style="padding: 1rem; text-align: left; color: #81d742; font-weight: 700;">Date</th>
                <th style="padding: 1rem; text-align: left; color: #81d742; font-weight: 700;">Violation Type</th>
                <th style="padding: 1rem; text-align: left; color: #81d742; font-weight: 700;">Sanctions</th>
                <th style="padding: 1rem; text-align: center; color: #81d742; font-weight: 700;">Actions</th>
              </tr>
            </thead>
            <tbody>
      `;

      paginatedRecords.forEach(record => {
        const typeColor = record.type === 'Violation' ? '#EF4444' : '#22C55E';
        const typeBg = record.type === 'Violation' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(34, 197, 94, 0.2)';

        // Check if PDF link exists
        const hasAttachment = record.pdfLink && record.pdfLink.trim() !== '' && record.pdfLink !== 'N/A';

        // Display violation type and sanction, or N/A for accomplishments
        const violationType = record.typeOfViolation && record.typeOfViolation !== 'N/A' ? record.typeOfViolation : '-';
        const sanction = record.violationSanction && record.violationSanction !== 'N/A' ? record.violationSanction : '-';

        html += `
          <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
            <td style="padding: 1rem;">${record.guardName}</td>
            <td style="padding: 1rem;">
              <span style="background: ${typeBg}; color: ${typeColor}; padding: 0.25rem 0.75rem; border-radius: 6px; font-size: 0.85rem; font-weight: 600;">
                ${record.type}
              </span>
            </td>
            <td style="padding: 1rem;">${record.date}</td>
            <td style="padding: 1rem;">${violationType}</td>
            <td style="padding: 1rem;">${sanction}</td>
            <td style="padding: 1rem; text-align: center;">
              <div style="display: flex; gap: 0.5rem; justify-content: center;">
                <button
                  ${hasAttachment ? `onclick="window.open('${record.pdfLink}', '_blank')"` : ''}
                  style="background: ${hasAttachment ? 'rgba(59, 130, 246, 0.2)' : 'rgba(255,255,255,0.05)'}; border: 1px solid ${hasAttachment ? '#3B82F6' : 'rgba(255,255,255,0.2)'}; color: ${hasAttachment ? '#60A5FA' : 'rgba(255,255,255,0.3)'}; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: ${hasAttachment ? 'pointer' : 'not-allowed'}; font-size: 1.1rem; min-width: 40px;"
                  title="${hasAttachment ? 'View Attachment' : 'No Attachment'}"
                  ${hasAttachment ? '' : 'disabled'}
                >
                  üëÅÔ∏è
                </button>
                <button onclick="openUpdateRecordModal('${record.recordId}')" style="background: rgba(251, 191, 36, 0.2); border: 1px solid #FBBF24; color: #FCD34D; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 1.1rem; min-width: 40px;" title="Edit">
                  ‚úèÔ∏è
                </button>
                ${currentUser.role === 'Admin' ? `
                <button onclick="openDeleteRecordModal('${record.recordId}', '${record.guardName.replace(/'/g, "\\'")}', '${record.type}')" style="background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; font-size: 1.1rem; min-width: 40px;" title="Delete">
                  üóëÔ∏è
                </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;

      // Render pagination
      renderRecordsPagination();
    }

    function renderRecordsPagination() {
      const paginationContainer = document.getElementById('records-pagination');
      if (!paginationContainer) return;

      const totalPages = Math.ceil(filteredRecordsList.length / itemsPerPage);
      const startIndex = (currentRecordsPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;

      if (totalPages <= 1) {
        paginationContainer.innerHTML = '';
        return;
      }

      let paginationHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(251, 191, 36, 0.2);">
          <div style="color: white; opacity: 0.8; font-size: 0.9rem;">
            Showing ${startIndex + 1}-${Math.min(endIndex, filteredRecordsList.length)} of ${filteredRecordsList.length} records
          </div>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <button
              onclick="goToRecordsPage(${currentRecordsPage - 1})"
              ${currentRecordsPage === 1 ? 'disabled' : ''}
              style="background: ${currentRecordsPage === 1 ? 'rgba(255,255,255,0.1)' : 'rgba(129, 215, 66, 0.2)'}; border: 1px solid ${currentRecordsPage === 1 ? 'rgba(255,255,255,0.2)' : '#81d742'}; color: ${currentRecordsPage === 1 ? 'rgba(255,255,255,0.4)' : '#81d742'}; padding: 0.5rem 1rem; border-radius: 6px; cursor: ${currentRecordsPage === 1 ? 'not-allowed' : 'pointer'}; font-weight: 600; transition: all 0.2s ease;"
              ${currentRecordsPage === 1 ? '' : 'onmouseover="this.style.background=\'rgba(129, 215, 66, 0.3)\'" onmouseout="this.style.background=\'rgba(129, 215, 66, 0.2)\'"'}
            >
              ‚Üê Previous
            </button>

            <div style="display: flex; gap: 0.25rem;">
              ${generateRecordsPageNumbers(currentRecordsPage, totalPages)}
            </div>

            <button
              onclick="goToRecordsPage(${currentRecordsPage + 1})"
              ${currentRecordsPage === totalPages ? 'disabled' : ''}
              style="background: ${currentRecordsPage === totalPages ? 'rgba(255,255,255,0.1)' : 'rgba(129, 215, 66, 0.2)'}; border: 1px solid ${currentRecordsPage === totalPages ? 'rgba(255,255,255,0.2)' : '#81d742'}; color: ${currentRecordsPage === totalPages ? 'rgba(255,255,255,0.4)' : '#81d742'}; padding: 0.5rem 1rem; border-radius: 6px; cursor: ${currentRecordsPage === totalPages ? 'not-allowed' : 'pointer'}; font-weight: 600; transition: all 0.2s ease;"
              ${currentRecordsPage === totalPages ? '' : 'onmouseover="this.style.background=\'rgba(129, 215, 66, 0.3)\'" onmouseout="this.style.background=\'rgba(129, 215, 66, 0.2)\'"'}
            >
              Next ‚Üí
            </button>
          </div>
        </div>
      `;

      paginationContainer.innerHTML = paginationHTML;
    }

    function generateRecordsPageNumbers(current, total) {
      let html = '';
      const maxVisible = 5;

      if (total <= maxVisible) {
        for (let i = 1; i <= total; i++) {
          html += generateRecordsPageButton(i, current);
        }
      } else {
        html += generateRecordsPageButton(1, current);

        let startPage = Math.max(2, current - 1);
        let endPage = Math.min(total - 1, current + 1);

        if (startPage > 2) {
          html += '<span style="color: white; opacity: 0.5; padding: 0.5rem;">...</span>';
        }

        for (let i = startPage; i <= endPage; i++) {
          html += generateRecordsPageButton(i, current);
        }

        if (endPage < total - 1) {
          html += '<span style="color: white; opacity: 0.5; padding: 0.5rem;">...</span>';
        }

        html += generateRecordsPageButton(total, current);
      }

      return html;
    }

    function generateRecordsPageButton(pageNum, currentPage) {
      const isActive = pageNum === currentPage;
      const activeStyle = 'background: #81d742; color: #006341; padding: 0.5rem 0.75rem; border: none; border-radius: 6px; font-weight: 700; cursor: default; min-width: 2.5rem;';
      const inactiveStyle = 'background: rgba(255,255,255,0.1); border: 1px solid rgba(129, 215, 66, 0.3); color: white; padding: 0.5rem 0.75rem; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; min-width: 2.5rem;';

      if (isActive) {
        return `<button style="${activeStyle}">${pageNum}</button>`;
      } else {
        return `<button onclick="goToRecordsPage(${pageNum})" style="${inactiveStyle}" onmouseover="this.style.background='rgba(129, 215, 66, 0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">${pageNum}</button>`;
      }
    }

    function goToRecordsPage(page) {
      currentRecordsPage = page;
      renderRecordsList();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Record action functions
    function openUpdateRecordModal(recordId) {
      const record = allRecordsList.find(r => r.recordId === recordId);
      if (!record) return;

      // Populate update modal
      document.getElementById('updateRecordId').value = recordId;
      document.getElementById('updateRecordGuardId').value = record.guardId;
      document.getElementById('updateRecordGuardName').value = record.guardName;
      document.getElementById('displayGuardName').textContent = record.guardName;
      document.getElementById('updateRecordType').value = record.type;
      document.getElementById('updateRecordDescription').value = record.shortDescription;
      document.getElementById('updateRecordDate').value = convertDateToInput(record.date);

      // Store current PDF link
      document.getElementById('updateRecordCurrentPdfLink').value = record.pdfLink || '';

      // Display current PDF if exists
      const hasAttachment = record.pdfLink && record.pdfLink.trim() !== '' && record.pdfLink !== 'N/A';
      const pdfDisplay = document.getElementById('currentPdfDisplay');
      const pdfLink = document.getElementById('currentPdfLink');

      if (hasAttachment) {
        pdfDisplay.style.display = 'block';
        pdfLink.href = record.pdfLink;
      } else {
        pdfDisplay.style.display = 'none';
      }

      // Clear file input
      document.getElementById('updateRecordPDF').value = '';

      // Handle Type-specific fields
      if (record.type === 'Violation') {
        document.getElementById('updateRecordViolationTypeContainer').style.display = 'block';
        document.getElementById('updateRecordSanctionContainer').style.display = 'block';
        document.getElementById('updateRecordViolationType').value = record.typeOfViolation;
        document.getElementById('updateRecordSanction').value = record.violationSanction;
      } else {
        document.getElementById('updateRecordViolationTypeContainer').style.display = 'none';
        document.getElementById('updateRecordSanctionContainer').style.display = 'none';
      }

      // Load dropdown options
      loadViolationTypesForUpdateRecord();
      loadSanctionsForUpdateRecord();

      document.getElementById('updateRecordModal').style.display = 'flex';
    }

    function closeUpdateRecordModal() {
      document.getElementById('updateRecordModal').style.display = 'none';
      document.getElementById('updateRecordErrorMessage').style.display = 'none';
    }

    function loadViolationTypesForUpdateRecord() {
      google.script.run
        .withSuccessHandler(function(violationTypes) {
          const select = document.getElementById('updateRecordViolationType');
          const currentValue = select.value;
          select.innerHTML = '<option value="" style="background: #006341; color: white;">Select Violation Type</option>';

          violationTypes.forEach(vt => {
            const option = document.createElement('option');
            option.value = vt.name;
            option.textContent = vt.name;
            option.style.background = '#006341';
            option.style.color = 'white';
            select.appendChild(option);
          });

          // Restore selected value
          if (currentValue) {
            select.value = currentValue;
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading violation types:', error);
        })
        .getViolationTypes();
    }

    function loadSanctionsForUpdateRecord() {
      google.script.run
        .withSuccessHandler(function(sanctions) {
          const select = document.getElementById('updateRecordSanction');
          const currentValue = select.value;
          select.innerHTML = '<option value="" style="background: #006341; color: white;">Select Sanction</option>';

          sanctions.forEach(s => {
            const option = document.createElement('option');
            option.value = s.name;
            option.textContent = s.name;
            option.style.background = '#006341';
            option.style.color = 'white';
            select.appendChild(option);
          });

          // Restore selected value
          if (currentValue) {
            select.value = currentValue;
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading sanctions:', error);
        })
        .getViolationSanctions();
    }

    function convertDateToInput(dateStr) {
      // Convert "Jan 15, 2025" to "2025-01-15"
      if (!dateStr) return '';
      try {
        const date = new Date(dateStr);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      } catch (e) {
        return '';
      }
    }

    let recordToDelete = null;

    function openDeleteRecordModal(recordId, guardName, type) {
      recordToDelete = recordId;
      document.getElementById('deleteRecordGuardName').textContent = guardName;
      document.getElementById('deleteRecordType').textContent = type;
      document.getElementById('deleteRecordId').textContent = `Record ID: ${recordId}`;
      document.getElementById('deleteRecordModal').style.display = 'flex';
    }

    function closeDeleteRecordModal() {
      document.getElementById('deleteRecordModal').style.display = 'none';
      recordToDelete = null;
    }

    function confirmDeleteRecord() {
      if (!recordToDelete) return;

      const deleteBtn = document.getElementById('confirmDeleteRecordBtn');
      deleteBtn.innerHTML = '<span class="spinner"></span>Deleting...';
      deleteBtn.disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          deleteBtn.innerHTML = 'Delete Record';
          deleteBtn.disabled = false;

          if (result.success) {
            closeDeleteRecordModal();
            showToast('success', 'Record Deleted', 'Performance record has been deleted successfully.');
            loadAllRecords(); // Reload records list
          } else {
            showToast('error', 'Delete Failed', result.message);
          }
        })
        .withFailureHandler(function(error) {
          deleteBtn.innerHTML = 'Delete Record';
          deleteBtn.disabled = false;
          showToast('error', 'Error', error.message);
        })
        .deletePerformanceRecord(recordToDelete, currentUser.username);
    }

    // ==================== USER MANAGEMENT SECTION ====================
    let usersList = [];
    let filteredUsersList = [];
    let currentUsersPage = 1;
    let usersPerPage = 10;

    function renderUsersView() {
      console.log('renderUsersView() called - User Management page is rendering');
      return `
        <div>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <div>
              <h1 style="color: #81d742; font-size: 2rem; margin: 0 0 0.5rem;">User Management</h1>
              <p style="color: white; opacity: 0.7; margin: 0;">Manage system users and access</p>
            </div>
            <div style="display: flex; gap: 1rem;">
              <button onclick="openAddUserModal()" style="background: #81d742; color: #006341; padding: 0.875rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: all 0.3s ease;">
                + Add User
              </button>
            </div>
          </div>

          <!-- Search and Filter Controls -->
          <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(129, 215, 66, 0.3); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
            <div style="display: flex; gap: 1rem; align-items: end;">
              <div style="width: 37.5%;">
                <label style="display: block; color: #81d742; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">üîç Search by Username or Name</label>
                <input
                  type="text"
                  id="searchUserInput"
                  placeholder="Search username or full name..."
                  oninput="filterUsers()"
                  style="width: 100%; padding: 0.875rem 1rem; background: rgba(255, 255, 255, 0.15); border: 2px solid rgba(129, 215, 66, 0.4); border-radius: 10px; color: white; font-size: 0.95rem; transition: all 0.3s ease;"
                  onfocus="this.style.border='2px solid #81d742'; this.style.background='rgba(255, 255, 255, 0.2)';"
                  onblur="this.style.border='2px solid rgba(129, 215, 66, 0.4)'; this.style.background='rgba(255, 255, 255, 0.15)';"
                />
              </div>
              <div style="width: 12.5%;">
                <label style="display: block; color: #81d742; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">üë§ Role</label>
                <select
                  id="roleFilter"
                  onchange="filterUsers()"
                  style="width: 100%; padding: 0.875rem 1rem; background: #006341; border: 2px solid rgba(129, 215, 66, 0.4); border-radius: 10px; color: white; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease;"
                  onfocus="this.style.border='2px solid #81d742';"
                  onblur="this.style.border='2px solid rgba(129, 215, 66, 0.4)';"
                >
                  <option value="all" style="background: #006341; color: white;">All Roles</option>
                  <option value="Admin" style="background: #006341; color: white;">Admin</option>
                  <option value="User" style="background: #006341; color: white;">User</option>
                </select>
              </div>
              <div style="width: 12.5%;">
                <label style="display: block; color: #81d742; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.95rem;">üìä Status</label>
                <select
                  id="userStatusFilter"
                  onchange="filterUsers()"
                  style="width: 100%; padding: 0.875rem 1rem; background: #006341; border: 2px solid rgba(129, 215, 66, 0.4); border-radius: 10px; color: white; font-size: 0.95rem; cursor: pointer; transition: all 0.3s ease;"
                  onfocus="this.style.border='2px solid #81d742';"
                  onblur="this.style.border='2px solid rgba(129, 215, 66, 0.4)';"
                >
                  <option value="all" style="background: #006341; color: white;">All Status</option>
                  <option value="Active" style="background: #006341; color: white;">Active</option>
                  <option value="Inactive" style="background: #006341; color: white;">Inactive</option>
                </select>
              </div>
              <div style="width: 37.5%;"></div>
            </div>
          </div>

          <div id="usersListContainer" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 12px; padding: 2rem;">
            <p style="color: white; opacity: 0.6; text-align: center; padding: 2rem;">Loading users...</p>
          </div>
        </div>
      `;
    }

    function loadUsers() {
      console.log('loadUsers() called');
      const container = document.getElementById('usersListContainer');
      if (!container) {
        console.error('Users container not found');
        return;
      }

      container.innerHTML = '<p style="color: white; opacity: 0.6; text-align: center; padding: 2rem;">Loading users...</p>';

      console.log('Calling getAllUsers()...');
      google.script.run
        .withSuccessHandler(function(users) {
          console.log('getAllUsers() returned:', users);
          displayUsers(users);
        })
        .withFailureHandler(error => {
          console.error('getAllUsers() failed:', error);
          const container = document.getElementById('usersListContainer');
          if (container) {
            container.innerHTML = `
              <p style="color: #FCA5A5; text-align: center; padding: 2rem;">Error loading users: ${error.message}</p>
            `;
          }
        })
        .getAllUsers();
    }

    function displayUsers(users) {
      console.log('Displaying users:', users);
      console.log('Number of users:', users ? users.length : 'null/undefined');
      console.log('Users type:', typeof users);

      if (!users) {
        console.error('Users is null or undefined');
        users = [];
      }

      usersList = users;
      filteredUsersList = users;
      currentUsersPage = 1;

      console.log('usersList set to:', usersList);
      console.log('filteredUsersList set to:', filteredUsersList);

      renderUsersTable();
    }

    function filterUsers() {
      const searchTerm = document.getElementById('searchUserInput').value.toLowerCase();
      const roleFilter = document.getElementById('roleFilter').value;
      const statusFilter = document.getElementById('userStatusFilter').value;

      filteredUsersList = usersList.filter(user => {
        const matchesSearch = user.username.toLowerCase().includes(searchTerm) ||
                            user.fullName.toLowerCase().includes(searchTerm);
        const matchesRole = roleFilter === 'all' || user.role === roleFilter;
        const matchesStatus = statusFilter === 'all' || user.status === statusFilter;

        return matchesSearch && matchesRole && matchesStatus;
      });

      currentUsersPage = 1;
      renderUsersTable();
    }

    function renderUsersTable() {
      console.log('renderUsersTable called');
      const container = document.getElementById('usersListContainer');

      if (!container) {
        console.error('Container not found!');
        return;
      }

      console.log('filteredUsersList:', filteredUsersList);
      console.log('filteredUsersList length:', filteredUsersList ? filteredUsersList.length : 'null/undefined');

      if (!filteredUsersList || filteredUsersList.length === 0) {
        console.warn('No users to display');
        container.innerHTML = `
          <p style="color: white; opacity: 0.6; text-align: center; padding: 2rem;">No users found. Try adjusting your filters or click "Add User" to get started.</p>
        `;
        return;
      }

      console.log('Rendering', filteredUsersList.length, 'users');

      const isAdmin = currentUser.role === 'Admin';

      // Calculate pagination
      const totalPages = Math.ceil(filteredUsersList.length / usersPerPage);
      const startIndex = (currentUsersPage - 1) * usersPerPage;
      const endIndex = startIndex + usersPerPage;
      const paginatedUsers = filteredUsersList.slice(startIndex, endIndex);

      let html = '<div style="overflow-x: auto;">';
      html += '<table style="width: 100%; border-collapse: collapse;">';
      html += `
        <thead>
          <tr style="border-bottom: 2px solid rgba(251, 191, 36, 0.3);">
            <th style="padding: 1rem; text-align: left; color: #81d742;">Username</th>
            <th style="padding: 1rem; text-align: left; color: #81d742;">Full Name</th>
            <th style="padding: 1rem; text-align: left; color: #81d742;">Role</th>
            <th style="padding: 1rem; text-align: left; color: #81d742;">Status</th>
            <th style="padding: 1rem; text-align: left; color: #81d742;">Created Date</th>
            <th style="padding: 1rem; text-align: center; color: #81d742;">Actions</th>
          </tr>
        </thead>
        <tbody>
      `;

      paginatedUsers.forEach(user => {
        const roleColor = user.role === 'Admin' ? '#F59E0B' : '#3B82F6';
        const statusColor = user.status === 'Active' ? '#22C55E' : '#EF4444';

        html += `
          <tr style="border-bottom: 1px solid rgba(251, 191, 36, 0.1);">
            <td style="padding: 1rem; color: white; font-weight: 600;">${user.username}</td>
            <td style="padding: 1rem; color: white; opacity: 0.8;">${user.fullName}</td>
            <td style="padding: 1rem;">
              <span style="background: rgba(${roleColor === '#F59E0B' ? '245, 158, 11' : '59, 130, 246'}, 0.2); color: ${roleColor}; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600;">
                ${user.role}
              </span>
            </td>
            <td style="padding: 1rem;">
              <span style="background: rgba(${statusColor === '#22C55E' ? '34, 197, 94' : '239, 68, 68'}, 0.2); color: ${statusColor}; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600;">
                ${user.status}
              </span>
            </td>
            <td style="padding: 1rem; color: white; opacity: 0.8;">${user.createdDate || 'N/A'}</td>
            <td style="padding: 1rem;">
              <div style="display: flex; gap: 0.5rem; justify-content: center; align-items: center;">
                <button
                  onclick="editUser('${user.userId}')"
                  title="Edit User"
                  style="background: rgba(251, 191, 36, 0.2); border: 1px solid #81d742; color: #81d742; padding: 0.5rem; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; width: 36px; height: 36px;"
                  onmouseover="this.style.background='rgba(251, 191, 36, 0.3)'"
                  onmouseout="this.style.background='rgba(251, 191, 36, 0.2)'"
                >
                  ‚úèÔ∏è
                </button>
                ${isAdmin && user.userId !== currentUser.userId ? `
                <button
                  onclick="deleteUser('${user.userId}', '${user.username}')"
                  title="Delete User"
                  style="background: rgba(239, 68, 68, 0.2); border: 1px solid #EF4444; color: #FCA5A5; padding: 0.5rem; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; width: 36px; height: 36px;"
                  onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'"
                  onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'"
                >
                  üóëÔ∏è
                </button>
                ` : ''}
              </div>
            </td>
          </tr>
        `;
      });

      html += `
        </tbody>
      </table>
      </div>

      <!-- Pagination -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(251, 191, 36, 0.2);">
        <p style="color: white; opacity: 0.7; margin: 0;">
          Showing ${startIndex + 1} to ${Math.min(endIndex, filteredUsersList.length)} of ${filteredUsersList.length} users
        </p>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <button
            onclick="goToUsersPage(${currentUsersPage - 1})"
            ${currentUsersPage === 1 ? 'disabled' : ''}
            style="background: rgba(129, 215, 66, 0.2); border: 1px solid #81d742; color: #81d742; padding: 0.5rem 1rem; border-radius: 6px; cursor: ${currentUsersPage === 1 ? 'not-allowed' : 'pointer'}; opacity: ${currentUsersPage === 1 ? '0.5' : '1'};"
          >
            ‚Üê Previous
          </button>
          <span style="color: white; padding: 0 1rem;">
            Page ${currentUsersPage} of ${totalPages}
          </span>
          <button
            onclick="goToUsersPage(${currentUsersPage + 1})"
            ${currentUsersPage === totalPages ? 'disabled' : ''}
            style="background: rgba(129, 215, 66, 0.2); border: 1px solid #81d742; color: #81d742; padding: 0.5rem 1rem; border-radius: 6px; cursor: ${currentUsersPage === totalPages ? 'not-allowed' : 'pointer'}; opacity: ${currentUsersPage === totalPages ? '0.5' : '1'};"
          >
            Next ‚Üí
          </button>
        </div>
      </div>
      `;

      container.innerHTML = html;
    }

    function goToUsersPage(page) {
      const totalPages = Math.ceil(filteredUsersList.length / usersPerPage);
      if (page >= 1 && page <= totalPages) {
        currentUsersPage = page;
        renderUsersTable();
      }
    }

    // Modal Functions
    function openAddUserModal() {
      document.getElementById('addUserModal').style.display = 'flex';
      document.getElementById('addUserForm').reset();
      document.getElementById('addUserErrorMessage').style.display = 'none';
    }

    function closeAddUserModal() {
      document.getElementById('addUserModal').style.display = 'none';
      document.getElementById('addUserForm').reset();
    }

    function openUpdateUserModal() {
      document.getElementById('updateUserModal').style.display = 'flex';
    }

    function closeUpdateUserModal() {
      document.getElementById('updateUserModal').style.display = 'none';
      document.getElementById('updateUserForm').reset();
    }

    function openChangePasswordModal() {
      document.getElementById('changePasswordModal').style.display = 'flex';
      document.getElementById('changePasswordForm').reset();
      document.getElementById('changePasswordErrorMessage').style.display = 'none';
      document.getElementById('changePasswordSuccessMessage').style.display = 'none';

      // Reset password field types and icons
      document.getElementById('currentPassword').type = 'password';
      document.getElementById('newPassword').type = 'password';
      document.getElementById('confirmPassword').type = 'password';
      document.getElementById('currentPasswordIcon').textContent = 'üëÅÔ∏è';
      document.getElementById('newPasswordIcon').textContent = 'üëÅÔ∏è';
      document.getElementById('confirmPasswordIcon').textContent = 'üëÅÔ∏è';
    }

    function closeChangePasswordModal() {
      document.getElementById('changePasswordModal').style.display = 'none';
      document.getElementById('changePasswordForm').reset();
      document.getElementById('changePasswordErrorMessage').style.display = 'none';
      document.getElementById('changePasswordSuccessMessage').style.display = 'none';

      // Reset password field types and icons
      document.getElementById('currentPassword').type = 'password';
      document.getElementById('newPassword').type = 'password';
      document.getElementById('confirmPassword').type = 'password';
      document.getElementById('currentPasswordIcon').textContent = 'üëÅÔ∏è';
      document.getElementById('newPasswordIcon').textContent = 'üëÅÔ∏è';
      document.getElementById('confirmPasswordIcon').textContent = 'üëÅÔ∏è';
    }

    function togglePasswordVisibility(fieldId) {
      const passwordField = document.getElementById(fieldId);
      const iconSpan = document.getElementById(fieldId + 'Icon');

      if (passwordField.type === 'password') {
        passwordField.type = 'text';
        iconSpan.textContent = 'üôà'; // Eye slash icon (hide)
      } else {
        passwordField.type = 'password';
        iconSpan.textContent = 'üëÅÔ∏è'; // Eye icon (show)
      }
    }

    function editUser(userId) {
      const user = usersList.find(u => u.userId === userId);
      if (!user) {
        showToast('error', 'Error', 'User not found');
        return;
      }

      document.getElementById('updateUserId').value = user.userId;
      document.getElementById('updateUserUsername').value = user.username;
      document.getElementById('updateUserFullName').value = user.fullName;
      document.getElementById('updateUserPassword').value = '';
      document.getElementById('updateUserRole').value = user.role;
      document.getElementById('updateUserStatus').value = user.status;

      openUpdateUserModal();
    }

    function deleteUser(userId, username) {
      if (!confirm(`Are you sure you want to delete user "${username}"?\n\nThis action cannot be undone.`)) {
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            showToast('success', 'Success', 'User deleted successfully');
            loadUsers();
          } else {
            showToast('error', 'Error', result.message);
          }
        })
        .withFailureHandler(error => {
          showToast('error', 'Error', error.message);
        })
        .deleteUser(userId, currentUser.username);
    }

    // Form Submissions
    document.addEventListener('DOMContentLoaded', function() {
      // Add User Form
      const addUserForm = document.getElementById('addUserForm');
      if (addUserForm) {
        addUserForm.addEventListener('submit', function(e) {
          e.preventDefault();

          const userData = {
            username: document.getElementById('userUsername').value.trim(),
            fullName: document.getElementById('userFullName').value.trim(),
            password: document.getElementById('userPassword').value,
            role: document.getElementById('userRole').value,
            status: document.getElementById('userStatus').value
          };

          // Validation
          if (!userData.username || !userData.fullName || !userData.password || !userData.role) {
            document.getElementById('addUserErrorMessage').textContent = 'Please fill in all required fields';
            document.getElementById('addUserErrorMessage').style.display = 'block';
            return;
          }

          const submitBtn = document.getElementById('submitUserBtn');
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span class="spinner"></span> Adding...';

          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                showToast('success', 'Success', 'User added successfully');
                closeAddUserModal();
                loadUsers();
              } else {
                document.getElementById('addUserErrorMessage').textContent = result.message;
                document.getElementById('addUserErrorMessage').style.display = 'block';
              }
              submitBtn.disabled = false;
              submitBtn.innerHTML = 'Add User';
            })
            .withFailureHandler(function(error) {
              document.getElementById('addUserErrorMessage').textContent = 'Error: ' + error.message;
              document.getElementById('addUserErrorMessage').style.display = 'block';
              submitBtn.disabled = false;
              submitBtn.innerHTML = 'Add User';
            })
            .addUser(userData, currentUser.username);
        });
      }

      // Update User Form
      const updateUserForm = document.getElementById('updateUserForm');
      if (updateUserForm) {
        updateUserForm.addEventListener('submit', function(e) {
          e.preventDefault();

          const userData = {
            userId: document.getElementById('updateUserId').value,
            username: document.getElementById('updateUserUsername').value.trim(),
            fullName: document.getElementById('updateUserFullName').value.trim(),
            password: document.getElementById('updateUserPassword').value.trim(),
            role: document.getElementById('updateUserRole').value,
            status: document.getElementById('updateUserStatus').value
          };

          // Validation
          if (!userData.username || !userData.fullName || !userData.role) {
            document.getElementById('updateUserErrorMessage').textContent = 'Please fill in all required fields';
            document.getElementById('updateUserErrorMessage').style.display = 'block';
            return;
          }

          const submitBtn = document.getElementById('updateUserBtn');
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span class="spinner"></span> Updating...';

          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                document.getElementById('updateUserSuccessMessage').textContent = 'User updated successfully';
                document.getElementById('updateUserSuccessMessage').style.display = 'block';
                document.getElementById('updateUserErrorMessage').style.display = 'none';
                showToast('success', 'Success', 'User updated successfully');
                setTimeout(() => {
                  closeUpdateUserModal();
                  loadUsers();
                }, 1500);
              } else {
                document.getElementById('updateUserErrorMessage').textContent = result.message;
                document.getElementById('updateUserErrorMessage').style.display = 'block';
                document.getElementById('updateUserSuccessMessage').style.display = 'none';
              }
              submitBtn.disabled = false;
              submitBtn.innerHTML = 'Update User';
            })
            .withFailureHandler(function(error) {
              document.getElementById('updateUserErrorMessage').textContent = 'Error: ' + error.message;
              document.getElementById('updateUserErrorMessage').style.display = 'block';
              document.getElementById('updateUserSuccessMessage').style.display = 'none';
              submitBtn.disabled = false;
              submitBtn.innerHTML = 'Update User';
            })
            .updateUser(userData);
        });
      }

      // Change Password Form
      const changePasswordForm = document.getElementById('changePasswordForm');
      if (changePasswordForm) {
        changePasswordForm.addEventListener('submit', function(e) {
          e.preventDefault();

          const currentPassword = document.getElementById('currentPassword').value.trim();
          const newPassword = document.getElementById('newPassword').value.trim();
          const confirmPassword = document.getElementById('confirmPassword').value.trim();

          // Hide previous messages
          document.getElementById('changePasswordErrorMessage').style.display = 'none';
          document.getElementById('changePasswordSuccessMessage').style.display = 'none';

          // Validation
          if (!currentPassword || !newPassword || !confirmPassword) {
            document.getElementById('changePasswordErrorMessage').textContent = 'Please fill in all fields';
            document.getElementById('changePasswordErrorMessage').style.display = 'block';
            return;
          }

          if (newPassword.length < 6) {
            document.getElementById('changePasswordErrorMessage').textContent = 'New password must be at least 6 characters';
            document.getElementById('changePasswordErrorMessage').style.display = 'block';
            return;
          }

          if (newPassword !== confirmPassword) {
            document.getElementById('changePasswordErrorMessage').textContent = 'New passwords do not match';
            document.getElementById('changePasswordErrorMessage').style.display = 'block';
            return;
          }

          if (currentPassword === newPassword) {
            document.getElementById('changePasswordErrorMessage').textContent = 'New password must be different from current password';
            document.getElementById('changePasswordErrorMessage').style.display = 'block';
            return;
          }

          const submitBtn = document.getElementById('changePasswordBtn');
          submitBtn.disabled = true;
          submitBtn.innerHTML = '<span class="spinner"></span> Changing...';

          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                document.getElementById('changePasswordSuccessMessage').textContent = result.message;
                document.getElementById('changePasswordSuccessMessage').style.display = 'block';
                document.getElementById('changePasswordErrorMessage').style.display = 'none';
                showToast('success', 'Success', 'Password changed successfully');
                setTimeout(() => {
                  closeChangePasswordModal();
                }, 1500);
              } else {
                document.getElementById('changePasswordErrorMessage').textContent = result.message;
                document.getElementById('changePasswordErrorMessage').style.display = 'block';
                document.getElementById('changePasswordSuccessMessage').style.display = 'none';
              }
              submitBtn.disabled = false;
              submitBtn.innerHTML = 'Change Password';
            })
            .withFailureHandler(function(error) {
              document.getElementById('changePasswordErrorMessage').textContent = 'Error: ' + error.message;
              document.getElementById('changePasswordErrorMessage').style.display = 'block';
              document.getElementById('changePasswordSuccessMessage').style.display = 'none';
              submitBtn.disabled = false;
              submitBtn.innerHTML = 'Change Password';
            })
            .changePassword(currentUser.username, currentPassword, newPassword);
        });
      }
    });

    function renderSettingsView() {
      return `
        <div>
          <h1 style="color: #81d742; font-size: 2rem; margin: 0 0 0.5rem;">Settings</h1>
          <p style="color: white; opacity: 0.7; margin: 0 0 2rem;">Manage system configuration</p>

          <!-- Settings Grid - Two Columns -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">

            <!-- Type of Violation Column -->
            <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 12px; padding: 2rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: #81d742; font-size: 1.25rem; margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                  <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                  Type of Violation
                </h3>
                <button
                  onclick="openAddViolationModal()"
                  style="background: #81d742; color: #006341; padding: 0.5rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: all 0.3s ease; font-size: 0.9rem;"
                  onmouseover="this.style.background='#6bc92b'"
                  onmouseout="this.style.background='#81d742'"
                >
                  + Violation
                </button>
              </div>

              <!-- Violation Types List -->
              <div id="violationTypesList" style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 600px; overflow-y: auto; padding-right: 0.5rem;">
                <div style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">Loading violations...</div>
              </div>
            </div>

            <!-- Violation Sanctions Column -->
            <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 12px; padding: 2rem;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h3 style="color: #81d742; font-size: 1.25rem; margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                  <span style="font-size: 1.5rem;">‚öñÔ∏è</span>
                  Violation Sanctions
                </h3>
                <button
                  onclick="openAddSanctionModal()"
                  style="background: #81d742; color: #006341; padding: 0.5rem 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: all 0.3s ease; font-size: 0.9rem;"
                  onmouseover="this.style.background='#6bc92b'"
                  onmouseout="this.style.background='#81d742'"
                >
                  + Sanction
                </button>
              </div>

              <!-- Sanctions List -->
              <div id="sanctionsList" style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 600px; overflow-y: auto; padding-right: 0.5rem;">
                <div style="color: rgba(255,255,255,0.5); text-align: center; padding: 2rem;">Loading sanctions...</div>
              </div>
            </div>

          </div>
        </div>
      `;
    }

  </script>
</body>
</html>
